name = "clawproxy"
account_id = "b8f2c66f1848dff476faa874282d781e"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

routes = [
  { pattern = "clawproxy.com/*", zone_name = "clawproxy.com" },
  { pattern = "www.clawproxy.com/*", zone_name = "clawproxy.com" }
]

# CPX-US-031: Durable idempotency store
[[durable_objects.bindings]]
name = "IDEMPOTENCY"
class_name = "IdempotencyDurableObject"

[[migrations]]
tag = "v1"
new_classes = ["IdempotencyDurableObject"]

[vars]
PROXY_VERSION = "0.1.0"

# CST (Scoped Token) issuer public key (from clawscope)
CST_ISSUER_PUBLIC_KEY = "KhBwy4lBSKtd7M9eWyNnYfpIPl7sGnDWTSyJpmjYcjc"
# Audience override (stabilizes staging usage)
CST_AUDIENCE = "clawproxy.com"

# Secrets/vars to be set via wrangler secret put (or via dashboard vars):
# - PROXY_SIGNING_KEY (Ed25519 seed, base64url; required)
# - PROXY_ENCRYPTION_KEY (AES-256 key, base64url; optional)
# - PLATFORM_PAID_ENABLED ("true" to allow platform-paid mode; optional)
# - PLATFORM_OPENAI_API_KEY / PLATFORM_ANTHROPIC_API_KEY / PLATFORM_GOOGLE_API_KEY (optional)
# - STRICT_AUTH_HEADERS ("true" to disable Authorization overload; require X-CST + X-Provider-API-Key; optional)

[env.staging]
name = "clawproxy-staging"
routes = [
  { pattern = "staging.clawproxy.com/*", zone_name = "clawproxy.com" }
]

# CPX-US-031: Durable idempotency store (Wrangler does not inherit durable_objects into env.*).
[[env.staging.durable_objects.bindings]]
name = "IDEMPOTENCY"
class_name = "IdempotencyDurableObject"

[[env.staging.migrations]]
tag = "v1"
new_classes = ["IdempotencyDurableObject"]

[env.staging.vars]
PROXY_VERSION = "0.1.0"
CST_ISSUER_PUBLIC_KEY = "pwdA3cDDu9BF7vmFGs7E5m_aT8qRtMHe0QOIi5-ci90"
CST_AUDIENCE = "clawproxy.com"
