name = "clawproxy"
account_id = "b8f2c66f1848dff476faa874282d781e"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

routes = [
  { pattern = "clawproxy.com/*", zone_name = "clawproxy.com" },
  { pattern = "www.clawproxy.com/*", zone_name = "clawproxy.com" }
]

# CPX-US-031: Durable idempotency store
[[durable_objects.bindings]]
name = "IDEMPOTENCY"
class_name = "IdempotencyDurableObject"

[[migrations]]
tag = "v1"
new_classes = ["IdempotencyDurableObject"]

[vars]
PROXY_VERSION = "0.1.0"

# CST (Scoped Token) issuer public key (from clawscope)
CST_ISSUER_PUBLIC_KEY = "KhBwy4lBSKtd7M9eWyNnYfpIPl7sGnDWTSyJpmjYcjc"
# Audience override (stabilizes staging usage)
CST_AUDIENCE = "clawproxy.com"
STRICT_AUTH_HEADERS = "true"
PROXY_REQUIRE_CST = "true"
PROXY_REQUIRE_CANONICAL_CST = "true"

# WPC (Work Policy Contract) registry (clawcontrols)
WPC_REGISTRY_BASE_URL = "https://clawcontrols.com"
# Allowlisted WPC signer DIDs (did:key:...)
WPC_SIGNER_DIDS = "did:key:z6MkiLhU8t66whw5mvDbva7a6trcWw1RQXGzE96mMmnKUWdK"

# clawledger integration (platform-paid funding precheck)
LEDGER_BASE_URL = "https://clawledger.com"

# clawdelegate integration (delegated spend governance precheck)
CLAWDELEGATE_BASE_URL = "https://clawdelegate.com"
CLAWDELEGATE_TIMEOUT_MS = "5000"
CLAWDELEGATE_DEFAULT_SPEND_MINOR = "1"

# x402 internet-native payments (Phase 4)
# When enabled, requests without CST or BYOK key can pay via x402 protocol.
X402_ENABLED = "false"
# X402_FACILITATOR_URL — set via secret/var when enabled (default: Coinbase testnet)
# X402_RESOURCE_WALLET — set via secret when enabled (wallet to receive payments)
# X402_NETWORK — default: base-sepolia (testnet)

# Secrets/vars to be set via wrangler secret put (or via dashboard vars):
# - PROXY_SIGNING_KEY (Ed25519 seed, base64url; required)
# - PROXY_ENCRYPTION_KEY (AES-256 key, base64url; optional)
# - PLATFORM_PAID_ENABLED ("true" to allow platform-paid mode; optional)
# - PLATFORM_OPENAI_API_KEY / PLATFORM_ANTHROPIC_API_KEY / PLATFORM_GOOGLE_API_KEY (optional)
# - LEDGER_ADMIN_KEY (required when PLATFORM_PAID_ENABLED=true)
# - PLATFORM_PAID_MIN_AVAILABLE_MINOR (optional, default "1")
# - PLATFORM_PAID_REQUIRE_PAYMENT_ACCOUNT_CLAIM ("true" => require CST payment_account_did claim)
# - CLAWDELEGATE_PROXY_KEY (required when delegated CST spend checks are enabled)
# - STRICT_AUTH_HEADERS ("true" default/fail-closed; disable Authorization overload, require X-CST + X-Provider-API-Key)
# - PROXY_REQUIRE_CST ("true" default/fail-closed; require CST on proxy routes)
# - PROXY_REQUIRE_CANONICAL_CST ("true" default/fail-closed; require canonical owner/controller/agent claims)

[env.staging]
name = "clawproxy-staging"
routes = [
  { pattern = "staging.clawproxy.com/*", zone_name = "clawproxy.com" }
]

# CPX-US-031: Durable idempotency store (Wrangler does not inherit durable_objects into env.*).
[[env.staging.durable_objects.bindings]]
name = "IDEMPOTENCY"
class_name = "IdempotencyDurableObject"

[[env.staging.migrations]]
tag = "v1"
new_classes = ["IdempotencyDurableObject"]

[env.staging.vars]
PROXY_VERSION = "0.1.0"
CST_ISSUER_PUBLIC_KEY = "KhBwy4lBSKtd7M9eWyNnYfpIPl7sGnDWTSyJpmjYcjc"
CST_AUDIENCE = "clawproxy.com"
STRICT_AUTH_HEADERS = "true"
PROXY_REQUIRE_CST = "true"
PROXY_REQUIRE_CANONICAL_CST = "true"

WPC_REGISTRY_BASE_URL = "https://clawcontrols.com"
WPC_SIGNER_DIDS = "did:key:z6MkiLhU8t66whw5mvDbva7a6trcWw1RQXGzE96mMmnKUWdK,did:key:z6Mkoy4MkeFsYo2VTuRRVZ6QoguECQgT1wRJkhfoAu2bHKZt"

LEDGER_BASE_URL = "https://staging.clawledger.com"
CLAWDELEGATE_BASE_URL = "https://staging.clawdelegate.com"
CLAWDELEGATE_TIMEOUT_MS = "5000"
CLAWDELEGATE_DEFAULT_SPEND_MINOR = "1"

# x402 internet-native payments (Phase 4) — staging
X402_ENABLED = "false"
