{
  "project": "clawbureau",
  "branchName": "ralph/clawscope-phase2",
  "description": "clawscope.com (Scope + Observability) — PRD — Define and enforce scoped token access, issue/introspect CSTs, and provide mission + usage analytics across services.",
  "userStories": [
    {
      "id": "CSC-US-001",
      "title": "Issue scoped tokens",
      "description": "As a platform, I want time-bound tokens so that access is safe.",
      "acceptanceCriteria": [
        "Issue tokens bound to DID + audience + scope",
        "Enforce TTL and max scope length",
        "Return token hash + policy version",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented POST /v1/tokens/issue issuing Ed25519-signed JWT (alg=EdDSA). Enforces TTL + scope limits, supports optional policy_hash_b64u + payment_account_did claims, and computes deterministic token_scope_hash_b64u for receipt binding; returns token_hash + policy_version."
    },
    {
      "id": "CSC-US-002",
      "title": "Token introspection",
      "description": "As a service, I want introspection so that I can verify tokens.",
      "acceptanceCriteria": [
        "Validate signature + expiry",
        "Return scope + audience + owner_ref",
        "Fail closed on unknown version",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented POST /v1/tokens/introspect validating EdDSA signature + exp and returning scope/aud/owner_ref/payment_account_did (fail-closed on token_version and invalid claim shape)."
    },
    {
      "id": "CSC-US-003",
      "title": "Token revocation",
      "description": "As a security operator, I want revocation so that compromises stop.",
      "acceptanceCriteria": [
        "Revoke tokens immediately",
        "Broadcast revocation events",
        "Provide audit log",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented POST /v1/tokens/revoke (admin) backed by KV; records revocations immediately and appends to an event/audit feed (GET /v1/revocations/events). Introspection returns active=false for revoked tokens."
    },
    {
      "id": "CSC-US-004",
      "title": "Policy enforcement",
      "description": "As a platform, I want policy checks so that tokens stay narrow.",
      "acceptanceCriteria": [
        "Enforce allowed scopes per tier",
        "Enforce max TTL per policy",
        "Reject tokens that exceed limits",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Added tier-aware policy enforcement for token issuance: supports SCOPE_POLICY_JSON tiers or env-based allowlist/prefix knobs; enforces max TTL and rejects scopes outside policy (incl. optional wildcard bans)."
    },
    {
      "id": "CSC-US-005",
      "title": "JWKS / public keys",
      "description": "As a verifier, I want key discovery so that verification is easy.",
      "acceptanceCriteria": [
        "Publish JWKS endpoint",
        "Rotate keys with versioning",
        "Cache-control headers",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "JWKS endpoint publishes all active/rotated public keys with cache-control; added key rotation support via SCOPE_SIGNING_KEYS_JSON (first key used for signing) and introspection verifies by header.kid against the keyset."
    },
    {
      "id": "CSC-US-006",
      "title": "Token audit trail",
      "description": "As an auditor, I want logs so that issuance is traceable.",
      "acceptanceCriteria": [
        "Log token hash + issuance metadata",
        "Store revocation timestamps",
        "Export audit bundles",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Logs token_hash + issuance metadata to KV (events:issuance:*), stores revocation timestamps, and exports combined audit bundles via GET /v1/audit/bundle (admin)."
    },
    {
      "id": "CSC-US-007",
      "title": "Metrics dashboard",
      "description": "As an operator, I want real-time metrics so that I can monitor health.",
      "acceptanceCriteria": [
        "Service metrics",
        "Latency charts",
        "Error rates",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented observability ingestion + dashboard endpoint `GET /v1/metrics/dashboard` in `services/clawscope/src/observability.ts` backed by D1 event storage, queue consumers, and analytics writes. Token issue/revoke/introspect/matrix flows now emit best-effort observability events with latency/error context and mission correlation IDs. Validated in staging/prod M5 smoke with non-empty dashboard/report output."
    },
    {
      "id": "CSC-US-008",
      "title": "Usage reports",
      "description": "As an enterprise, I want usage reports so that I can track spend.",
      "acceptanceCriteria": [
        "Daily usage",
        "Export CSV",
        "Segment by service",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented daily rollups (`scope_daily_usage_rollups`) and usage APIs: `POST /v1/reports/rollups/run` and `GET /v1/reports/usage` (+ `format=csv` export with optional R2 persistence). Reports are segmented by service/route and generated from persisted observability events. Verified via staging/prod M5 smoke artifacts with JSON row sets and CSV export keys."
    },
    {
      "id": "CSC-US-009",
      "title": "Alerting",
      "description": "As an operator, I want alerts so that I can respond quickly.",
      "acceptanceCriteria": [
        "Threshold alerts",
        "Email/Slack",
        "Ack workflow",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Shipped deterministic alert rule/event pipeline: `POST /v1/alerts/rules` and `GET /v1/alerts/events` with metric thresholds (`error_rate_percent`, `p95_latency_ms`, `request_count`). Alert dedupe is coordinated through Durable Object `ScopeObservabilityCoordinator` and event records persist to D1 (`scope_alert_events`). Smoke evidence shows alert-event creation under M5 workloads in staging/prod."
    },
    {
      "id": "CSC-US-010",
      "title": "Cost analytics",
      "description": "As a finance team, I want cost analytics so that budgets are managed.",
      "acceptanceCriteria": [
        "Cost by service",
        "Trend charts",
        "Forecasting",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Implemented cost rollups (`scope_daily_cost_rollups`) and API `GET /v1/analytics/cost` providing service-level request and estimated compute/storage cost totals. Rollups run through scheduled/manual aggregation and are persisted/exportable for finance tracking. Validated in M5 smoke with populated cost totals for both staging and prod."
    },
    {
      "id": "CSC-US-011",
      "title": "Trace viewer",
      "description": "As an engineer, I want tracing so that I can debug issues.",
      "acceptanceCriteria": [
        "Trace search",
        "Span view",
        "Correlation IDs",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Implemented trace index + viewer APIs: `GET /v1/traces/{trace_id}` and `GET /v1/traces?correlation_id=...`. Request trace IDs/correlation IDs are persisted from emitted scope events into `scope_trace_index` with event timelines for root-cause workflows. M5 smoke validates deterministic trace retrieval (`trace_present=true`) across staging/prod."
    },
    {
      "id": "CSC-US-012",
      "title": "SLA reports",
      "description": "As an enterprise, I want SLA reports so that compliance is proven.",
      "acceptanceCriteria": [
        "SLA metrics",
        "Downtime logs",
        "Export reports",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Implemented SLA rollup/report pipeline (`scope_sla_reports`) with endpoint `GET /v1/reports/sla`, built from daily event error/latency aggregates. Scheduled/manual rollup execution exports report artifacts to R2 for compliance retention. Verified endpoint behavior in staging/prod M5 smoke runs."
    },
    {
      "id": "CSC-US-013",
      "title": "Mission aggregation",
      "description": "As an operator, I want mission rollups so that multi-agent work is visible.",
      "acceptanceCriteria": [
        "Group spend and receipts by mission_id",
        "Show per-role and per-agent breakdowns",
        "Export mission summary reports",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Implemented mission rollups (`scope_daily_mission_rollups`) and API `GET /v1/missions/aggregate?mission_id=...` aggregating request/error/token issuance activity per mission. Mission IDs are propagated from CST flows into observability events, then materialized through rollups for export/reporting. Staging/prod M5 smoke artifacts show non-zero mission rows after end-to-end issuance/introspection/revocation flows."
    },
    {
      "id": "CSC-US-014",
      "title": "Canonical CST lane hard cutover",
      "description": "As platform security, we want canonical controller-bound CST issuance with deterministic introspection controls so sensitive transitions are fail-closed.",
      "acceptanceCriteria": [
        "Add canonical CST issuance lane with controller/owner/agent chain binding",
        "Keep legacy /v1/tokens/issue only as migration path behind explicit mode gate",
        "Add sensitive-transition introspection matrix with deterministic allow/deny reasons",
        "Add revocation stream + key rotation overlap contract endpoints",
        "Typecheck and tests pass"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Implemented canonical lane in `services/clawscope/src/index.ts`: new `POST /v1/tokens/issue/canonical` enforces control-chain lookup + owner/controller/agent claims + sensitive policy gate; legacy `POST /v1/tokens/issue` is now migration-gated (`SCOPE_LEGACY_EXCHANGE_MODE`) with deterministic `LEGACY_EXCHANGE_DISABLED` / `LEGACY_SENSITIVE_SCOPE_FORBIDDEN`. Added `POST /v1/tokens/introspect/matrix`, `GET /v1/revocations/stream`, and `GET /v1/keys/rotation-contract`. Extended claim contract and hash binding for owner/controller/agent + control-plane policy hash. Passed `npm run typecheck && npm test` with new canonical lane tests. Updated deploys: staging `30cb1291-9cf1-467d-ac2c-f697a9a7b422`, prod `b45c4100-8ba5-44ba-b2e6-e715329bc744`; updated smoke artifacts: `artifacts/smoke/identity-control-plane/2026-02-11T22-42-34-634Z-staging/result.json`, `artifacts/smoke/identity-control-plane/2026-02-11T22-42-46-640Z-prod/result.json`."
    },
    {
      "id": "CSC-US-016",
      "title": "Cross-environment token kid interoperability",
      "description": "As platform operations, we need deterministic kid interoperability so introspection does not fail with TOKEN_UNKNOWN_KID during controlled staging/prod overlap windows.",
      "acceptanceCriteria": [
        "Support verify-only public keys for accepted overlap kids without granting signing rights",
        "Expose introspection kid diagnostics (`kid`, `kid_source`) for deterministic triage",
        "Staging-issued tokens introspect successfully in prod and vice versa during overlap",
        "Typecheck and tests pass"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Implemented verify-only key contract via `SCOPE_VERIFY_PUBLIC_KEYS_JSON` in `services/clawscope/src/index.ts`, added deterministic overlap expiry error `TOKEN_KID_EXPIRED`, and introspection diagnostics (`kid`, `kid_source`). Added test coverage in `services/clawscope/test/key-kid-interop.test.ts`. Interop smoke artifact: `artifacts/smoke/identity-control-plane/2026-02-11T22-43-00-300Z-kid-interop/result.json`."
    },
    {
      "id": "CSC-US-017",
      "title": "Deterministic key overlap contract v2",
      "description": "As integrators, we need explicit key overlap metadata so accepted kid windows are machine-readable and fail-closed.",
      "acceptanceCriteria": [
        "`GET /v1/keys/rotation-contract` includes signing_kids, verify_only_kids, and expiring_kids",
        "`GET /v1/jwks` publishes only currently accepted keys",
        "Overlap windows remain deterministic and auditable",
        "Typecheck and tests pass"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Upgraded rotation contract to `contract_version=2` with explicit `signing_kids`, `verify_only_kids`, and `expiring_kids`. JWKS now serves accepted keys only (respecting overlap expiry). Verified in unit tests + identity smoke artifacts (`2026-02-11T22-42-34-634Z-staging`, `2026-02-11T22-42-46-640Z-prod`, `2026-02-11T22-43-00-300Z-kid-interop`)."
    },
    {
      "id": "CSC-US-018",
      "title": "Deterministic kid-error taxonomy for downstream gates",
      "description": "As downstream services, we need stable kid-related introspection errors to avoid ambiguous retry behavior.",
      "acceptanceCriteria": [
        "Unknown kid returns `TOKEN_UNKNOWN_KID`",
        "Expired overlap kid returns `TOKEN_KID_EXPIRED`",
        "Error behavior remains fail-closed and documented for integrators",
        "Typecheck and tests pass"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Added deterministic introspection error `TOKEN_KID_EXPIRED` while preserving `TOKEN_UNKNOWN_KID`. Downstream compatibility validated through interop smoke and documented for Agent C in `scripts/identity/COMPATIBILITY-NOTE-AGENT-C-token-kid.md`."
    },
    {
      "id": "CSC-US-019",
      "title": "Canonical protected auth + governance transparency/SLO reports",
      "description": "As platform security, we need protected control endpoints to require canonical CST plus transparent key-state and revocation propagation SLO reporting.",
      "acceptanceCriteria": [
        "Protected routes enforce canonical CST mode by default (`SCOPE_PROTECTED_AUTH_MODE=canonical_cst`)",
        "Key transparency endpoints expose latest/history and signed snapshot generation",
        "Revocation SLO reports are queryable and persistable with deterministic schema",
        "Scheduled governance job refreshes transparency snapshots + revocation SLO materialization",
        "Typecheck and tests pass"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Shipped with governance migration `services/clawscope/migrations/0002_governance_transparency_revocation_slo.sql`, protected auth routing in `services/clawscope/src/index.ts`, and new endpoints `/v1/keys/transparency/{latest,history}`, `/v1/keys/transparency/snapshot`, `/v1/reports/revocation-slo`. Deploys: staging `028de033-b1ac-45b5-82f5-904cd517e5b7`, prod `89b90fad-84da-4920-aceb-27d46c45256a`. M6 ops evidence: `artifacts/ops/identity-control-plane/2026-02-12T00-52-18-553Z-staging/deploy-summary.json`, `.../2026-02-12T00-52-32-525Z-prod/deploy-summary.json`."
    }
  ]
}
