## Codebase Patterns
- Services live in `services/<service-name>/` and are typically Cloudflare Workers.
- Keep secrets in wrangler secrets; fail closed when required keys are missing.
- CST format: JWT (JWS compact) signed with Ed25519 (alg=EdDSA).

# Ralph Progress Log
Started: 2026-02-02T22:30:00Z
---

## 2026-02-02 - CSC-US-001
- Scaffolded clawscope Worker at `services/clawscope/`.
- Implemented admin-gated token issuance: `POST /v1/tokens/issue`.
  - Issues Ed25519-signed JWT (JWS compact, `alg=EdDSA`).
  - Claims align with `packages/schema/auth/scoped_token_claims.v1.json`.
  - Enforces TTL + scope size/length limits.
  - Returns `token_hash` (SHA-256 hex) + `policy_version`.
- Added key discovery:
  - `GET /v1/jwks` (OKP Ed25519)
  - `GET /v1/did`
- Typecheck: `npm run typecheck`.
- **Learnings for future iterations:**
  - Other services (e.g. clawproxy) validate CSTs as EdDSA JWT and require a configured issuer public key.
  - Keeping the issuer key discoverable via JWKS allows offline verification.
---

## 2026-02-02 - CSC-US-002
- Added token introspection endpoint: `POST /v1/tokens/introspect`.
  - Parses JWT segments (header/payload/signature)
  - Validates `alg=EdDSA`, `token_version=1`, and `exp`.
  - Verifies signature against issuer key (fail closed if signing key missing).
  - Returns `{active:true, token_hash, sub, aud, scope, owner_ref, iat, exp}`.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-003
- Added token revocation endpoint (admin): `POST /v1/tokens/revoke`.
  - Stores revocation record in KV under `revoked:hash:<token_hash>`.
  - Writes an event/audit record under `events:revocations:<invTs>:<token_hash>` (newest-first listing).
- Added revocation event feed (admin): `GET /v1/revocations/events?limit=&cursor=`.
- Introspection checks revocation KV and returns `{active:false, revoked:true, ...}` for revoked tokens.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-004
- Added tier-aware policy enforcement for token issuance.
  - Supports `SCOPE_POLICY_JSON` (structured tiers) OR simple env knobs:
    - `SCOPE_ALLOWED_SCOPES`, `SCOPE_ALLOWED_SCOPE_PREFIXES`, `SCOPE_ALLOW_WILDCARDS`
    - `SCOPE_POLICY_TIER` selects default tier
  - Enforces max TTL per tier/policy (passed into token issuance).
  - Rejects requests with scopes outside policy.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-006
- Implemented issuance audit trail (best-effort) using KV:
  - Writes `issued:hash:<token_hash>` and `events:issuance:<invTs>:<token_hash>` records on successful issuance.
  - Revocations already store timestamps (`revoked_at`).
- Added admin audit endpoints:
  - `GET /v1/audit/issuance` (list issuance events)
  - `GET /v1/audit/bundle` (combined issuance + revocations export)
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-005
- Implemented key rotation + discovery improvements:
  - Added `SCOPE_SIGNING_KEYS_JSON` (JSON array of Ed25519 seeds; first key is active signer).
  - `GET /v1/jwks` now publishes **all** rotated public keys (stable `kid` per key).
  - Introspection verifies signatures by `header.kid` against the keyset (fails closed on unknown kid).
  - Keeps cache-control headers on JWKS (`public, max-age=300`).
- Typecheck: `npm run typecheck`.
---

## 2026-02-10 - CSC-US-001 (policy binding + deterministic token_scope_hash_b64u)
- Token issuance now supports optional pinned policy hash:
  - `POST /v1/tokens/issue` accepts `policy_hash_b64u` (SHA-256 base64url, len=43).
- Issued tokens now include:
  - `policy_hash_b64u` (when provided)
  - `token_scope_hash_b64u` (always) computed deterministically as:
    - `sha256_b64u(JCS({token_version, sub, aud[], scope[], owner_ref?, policy_hash_b64u?, spend_cap?, mission_id?}))`
    - excludes `iat/exp/jti/nonce` so re-issuance yields the same scope hash.
- `/v1/tokens/issue` response and `/v1/tokens/introspect` now return `policy_hash_b64u` and `token_scope_hash_b64u`.
- Issuance audit records now include `policy_hash_b64u` and `token_scope_hash_b64u`.
- Tests:
  - `services/clawscope/test/token-scope-hash.test.ts`
- Quality checks:
  - `npm run typecheck`
  - `npm test`
---
