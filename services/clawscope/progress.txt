## Codebase Patterns
- Services live in `services/<service-name>/` and are typically Cloudflare Workers.
- Keep secrets in wrangler secrets; fail closed when required keys are missing.
- CST format: JWT (JWS compact) signed with Ed25519 (alg=EdDSA).

# Ralph Progress Log
Started: 2026-02-02T22:30:00Z
---

## 2026-02-02 - CSC-US-001
- Scaffolded clawscope Worker at `services/clawscope/`.
- Implemented admin-gated token issuance: `POST /v1/tokens/issue`.
  - Issues Ed25519-signed JWT (JWS compact, `alg=EdDSA`).
  - Claims align with `packages/schema/auth/scoped_token_claims.v1.json`.
  - Enforces TTL + scope size/length limits.
  - Returns `token_hash` (SHA-256 hex) + `policy_version`.
- Added key discovery:
  - `GET /v1/jwks` (OKP Ed25519)
  - `GET /v1/did`
- Typecheck: `npm run typecheck`.
- **Learnings for future iterations:**
  - Other services (e.g. clawproxy) validate CSTs as EdDSA JWT and require a configured issuer public key.
  - Keeping the issuer key discoverable via JWKS allows offline verification.
---

## 2026-02-02 - CSC-US-002
- Added token introspection endpoint: `POST /v1/tokens/introspect`.
  - Parses JWT segments (header/payload/signature)
  - Validates `alg=EdDSA`, `token_version=1`, and `exp`.
  - Verifies signature against issuer key (fail closed if signing key missing).
  - Returns `{active:true, token_hash, sub, aud, scope, owner_ref, iat, exp}`.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-003
- Added token revocation endpoint (admin): `POST /v1/tokens/revoke`.
  - Stores revocation record in KV under `revoked:hash:<token_hash>`.
  - Writes an event/audit record under `events:revocations:<invTs>:<token_hash>` (newest-first listing).
- Added revocation event feed (admin): `GET /v1/revocations/events?limit=&cursor=`.
- Introspection checks revocation KV and returns `{active:false, revoked:true, ...}` for revoked tokens.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-004
- Added tier-aware policy enforcement for token issuance.
  - Supports `SCOPE_POLICY_JSON` (structured tiers) OR simple env knobs:
    - `SCOPE_ALLOWED_SCOPES`, `SCOPE_ALLOWED_SCOPE_PREFIXES`, `SCOPE_ALLOW_WILDCARDS`
    - `SCOPE_POLICY_TIER` selects default tier
  - Enforces max TTL per tier/policy (passed into token issuance).
  - Rejects requests with scopes outside policy.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-006
- Implemented issuance audit trail (best-effort) using KV:
  - Writes `issued:hash:<token_hash>` and `events:issuance:<invTs>:<token_hash>` records on successful issuance.
  - Revocations already store timestamps (`revoked_at`).
- Added admin audit endpoints:
  - `GET /v1/audit/issuance` (list issuance events)
  - `GET /v1/audit/bundle` (combined issuance + revocations export)
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CSC-US-005
- Implemented key rotation + discovery improvements:
  - Added `SCOPE_SIGNING_KEYS_JSON` (JSON array of Ed25519 seeds; first key is active signer).
  - `GET /v1/jwks` now publishes **all** rotated public keys (stable `kid` per key).
  - Introspection verifies signatures by `header.kid` against the keyset (fails closed on unknown kid).
  - Keeps cache-control headers on JWKS (`public, max-age=300`).
- Typecheck: `npm run typecheck`.
---

## 2026-02-10 - CSC-US-001 (policy binding + deterministic token_scope_hash_b64u)
- Token issuance now supports optional pinned policy hash:
  - `POST /v1/tokens/issue` accepts `policy_hash_b64u` (SHA-256 base64url, len=43).
- Issued tokens now include:
  - `policy_hash_b64u` (when provided)
  - `token_scope_hash_b64u` (always) computed deterministically as:
    - `sha256_b64u(JCS({token_version, sub, aud[], scope[], owner_ref?, policy_hash_b64u?, spend_cap?, mission_id?}))`
    - excludes `iat/exp/jti/nonce` so re-issuance yields the same scope hash.
- `/v1/tokens/issue` response and `/v1/tokens/introspect` now return `policy_hash_b64u` and `token_scope_hash_b64u`.
- Issuance audit records now include `policy_hash_b64u` and `token_scope_hash_b64u`.
- Tests:
  - `services/clawscope/test/token-scope-hash.test.ts`
- Quality checks:
  - `npm run typecheck`
  - `npm test`
---

## 2026-02-11 - MPY-US-005 (CST payment account claim binding)
- What was implemented
  - Extended CST claim flow in `services/clawscope/src/index.ts`:
    - `POST /v1/tokens/issue` now accepts optional `payment_account_did`.
    - claim is validated as DID format at issuance time (deterministic 400 `PAYMENT_ACCOUNT_CLAIM_INVALID` on malformed input).
    - issued JWT claims include `payment_account_did` when provided.
    - `/v1/tokens/issue` response includes `payment_account_did`.
    - `/v1/tokens/introspect` now returns `payment_account_did` for active/revoked tokens.
    - issuance audit records now include `payment_account_did`.
  - Updated deterministic token scope hashing:
    - `services/clawscope/src/token-scope-hash.ts` now binds `payment_account_did` into canonical `token_scope_hash_b64u` derivation when present.
- Tests
  - Added `services/clawscope/test/payment-account-claim.test.ts`.
  - Extended `services/clawscope/test/token-scope-hash.test.ts` with payment-account hash binding coverage.
- Quality checks
  - `cd services/clawscope && npm test && npm run typecheck`
- Deploy evidence
  - Deployed `clawscope-staging` version: `202270d3-60f1-44ed-b2a6-af2de074b477`
  - Deployed `clawscope` production version: `64dfb32c-e3c7-482e-9f34-971b5ae7801e`
- Cross-service smoke evidence
  - `LEDGER_ADMIN_KEY=*** SCOPE_ADMIN_KEY=*** node scripts/poh/smoke-clawproxy-payment-account-binding.mjs --env staging`
  - `LEDGER_ADMIN_KEY=*** SCOPE_ADMIN_KEY=*** node scripts/poh/smoke-clawproxy-payment-account-binding.mjs --env prod`
  - both smokes successfully exercised clawscope issuance with/without `payment_account_did` and downstream enforcement outcomes.
---

## 2026-02-11 - CSC-US-014 / ICP-US-002 (canonical CST lane hard cutover)
- What was implemented
  - Added canonical issuance endpoint:
    - `POST /v1/tokens/issue/canonical`
    - requires owner/controller/agent DID chain claims
    - validates chain state via clawclaim control-plane read endpoint
    - enforces controller sensitive-scope policy and policy-hash consistency
  - Hardened legacy issuance as migration lane:
    - `POST /v1/tokens/issue` now honors `SCOPE_LEGACY_EXCHANGE_MODE` (`enabled|migration|disabled`)
    - deterministic deny codes for migration/disabled paths:
      - `LEGACY_SENSITIVE_SCOPE_FORBIDDEN`
      - `LEGACY_EXCHANGE_DISABLED`
  - Added deterministic sensitive-transition matrix endpoint:
    - `POST /v1/tokens/introspect/matrix`
    - returns per-transition allow/deny with reason codes
  - Added explicit revocation + key-rotation contracts:
    - `GET /v1/revocations/stream`
    - `GET /v1/keys/rotation-contract`
  - Extended CST claim contract + deterministic scope hashing with canonical lane fields:
    - owner/controller/agent DID claims
    - `control_plane_policy_hash_b64u`
    - `token_lane`
- Files changed
  - `services/clawscope/src/index.ts`
  - `services/clawscope/src/token-scope-hash.ts`
  - `services/clawscope/wrangler.toml`
  - `services/clawscope/test/canonical-cst.test.ts`
  - `services/clawscope/test/token-scope-hash.test.ts`
  - `packages/schema/auth/scoped_token_claims.v1.json`
- Quality checks
  - `cd services/clawscope && npm run typecheck && npm test`
- Staging deploy
  - `clawscope-staging` version `c250201a-bb1c-458f-8a87-e4f09270ab60`
- Smoke evidence
  - `artifacts/smoke/identity-control-plane/2026-02-11T21-24-17-199Z-staging/result.json`
---
