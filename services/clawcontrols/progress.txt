## Codebase Patterns
- clawcontrols is a Cloudflare Worker that hosts governance/policy contracts.
- Work Policy Contracts (WPC) are addressed by a content hash: policy_hash_b64u = sha256(JCS(payload)).
- Registry responses return signed envelopes (Ed25519) so clients can verify integrity.
- Storage is Durable Objects (single registry DO) for simple keyâ†’value lookup.

# Ralph Progress Log
Started: 2026-02-10T00:38:35Z
---

## 2026-02-10T00:38:35Z - CCO-US-021
- What was implemented
  - New service: `services/clawcontrols/`.
  - Signed Work Policy Contract (WPC) registry API:
    - `POST /v1/wpc` (admin-gated) creates/returns a signed envelope.
    - `GET /v1/wpc/:policy_hash_b64u` fetches by hash.
  - Canonical hashing: `policy_hash_b64u = sha256(JCS(wpc_payload))` (base64url).
- Files changed
  - services/clawcontrols/*
- Quality checks
  - cd services/clawcontrols && npm run typecheck && npm test
---

## 2026-02-11 - POHVN-US-005 (WPC hooks: model identity tier + audit packs)
- What was implemented
  - Extended the strict WPC v1 shape to include:
    - `minimum_model_identity_tier`
    - `required_audit_packs[]` (audit_pack_hash_b64u)
  - Validation remains fail-closed on unknown keys.
- Tests
  - Updated DO tests to ensure idempotent hashing still holds with new fields.
- Quality checks
  - cd services/clawcontrols && npm run typecheck && npm test
---

## 2026-02-12 - CCO-US-022 (canonical CST enforcement for WPC writes)
- `POST /v1/wpc` now enforces canonical CST verification via:
  - `POST /v1/verify/token-control` on clawverify
- Legacy admin token path is only available when canonical requirement is explicitly disabled.
- Canonical acceptance contract normalized for M6 conformance semantics (201 create is accepted).
- Deploy versions:
  - staging: `clawcontrols-staging` -> `48dc04b6-24ae-4cde-917d-48fd0781ef48`
  - prod: `clawcontrols` -> `0c6685f9-b82c-41fe-9d40-8b375f6bdde7`
- Evidence:
  - conformance matrices:
    - `artifacts/smoke/identity-control-plane/2026-02-12T00-52-18-553Z-staging/conformance-matrix.json`
    - `artifacts/smoke/identity-control-plane/2026-02-12T00-52-32-525Z-prod/conformance-matrix.json`
- Quality checks:
  - `cd services/clawcontrols && npm run typecheck && npm test`
---
