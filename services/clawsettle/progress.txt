# Ralph Progress Log
Started: 2026-02-12
---

## 2026-02-12T12:30:00Z - MPY-US-003 (staging ship)
- What was implemented
  - Scaffolded `services/clawsettle` Cloudflare Worker service with staging/prod wrangler environments.
  - Added fail-closed Stripe webhook flow:
    - `POST /v1/stripe/webhook`
    - strict Stripe signature verification (`SIGNATURE_INVALID` on missing/invalid/tampered signatures)
    - event parsing + canonical mapping into ledger settlement ingest payloads
    - deterministic forwarding idempotency key format: `stripe:event:<event_id>`
  - Added replay dedupe persistence table + repository:
    - migration `services/clawsettle/migrations/0001_create_stripe_webhook_events.sql`
    - table `stripe_webhook_events` keyed by `event_id`
    - stores response snapshot for deterministic replay responses
  - Added settlement forwarding client to clawledger:
    - `POST /v1/payments/settlements/ingest`
    - fail-closed `LEDGER_INGEST_FAILED` on non-2xx ledger responses
  - Added tests:
    - `services/clawsettle/test/stripe-webhook.test.ts`
      - valid signature + forward success
      - tampered signature rejection
      - replay dedupe (single ledger forward)
  - Added smoke script:
    - `scripts/poh/smoke-clawsettle-stripe-webhook.mjs`
    - validates end-to-end webhook accept, replay dedupe, tampered signature reject, ledger settlement visibility, and balance side effect
- Staging infra + deploy evidence
  - Created D1 databases:
    - `clawsettle` (prod)
    - `clawsettle-staging` (staging)
  - Applied staging migration:
    - `wrangler d1 migrations apply clawsettle-staging --env staging --remote`
  - Set staging secrets (names only):
    - `LEDGER_ADMIN_KEY`
    - `STRIPE_WEBHOOK_SIGNING_SECRET`
  - Deployed staging Worker:
    - service: `clawsettle-staging`
    - version: `286da496-1d1d-4b05-9f62-b121d69503a7`
  - Added missing staging DNS record:
    - `staging.clawsettle.com` CNAME -> `clawsettle.com` (proxied)
- Staging smoke evidence
  - Command:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-stripe-webhook.mjs --env staging --clawsettle-resolve-ip 104.21.55.125`
  - Result highlights:
    - webhook: `200`, `deduped:false`, `forwarded_to_ledger:true`
    - replay: `200`, `deduped:true`
    - tampered signature: `401`, code `SIGNATURE_INVALID`
    - settlement lookup: `200`, one settlement, status `confirmed`
    - account available after webhook: `1234`
- Quality checks
  - `cd services/clawsettle && npm test && npm run lint && npm run typecheck`
  - `node scripts/docs/lint-prds.mjs`
- Release status
  - MPY-US-003 shipped to staging only.
  - No production deployment executed in this phase.
---

## 2026-02-11T16:10:00Z - MPY-US-006 (production activation + livemode hardening)
- What was implemented
  - Added strict Stripe livemode environment policy in `services/clawsettle/src/stripe.ts`:
    - staging (`SETTLE_ENV=staging`) rejects `livemode=true` events
    - production (`SETTLE_ENV=production`) rejects `livemode=false` events by default
    - optional override for production test-mode acceptance:
      - `STRIPE_ALLOW_TESTMODE_EVENTS_IN_PROD=true`
  - Added deterministic fail-closed error path for livemode violations:
    - code: `LIVEMODE_MISMATCH`
    - status: `422`
  - Preserved webhook security semantics:
    - signature verification unchanged (`SIGNATURE_INVALID`)
    - replay dedupe unchanged (`event_id` persistence + deterministic deduped response)
  - Updated configs/docs:
    - `services/clawsettle/wrangler.toml` (`SETTLE_ENV`, `STRIPE_ALLOW_TESTMODE_EVENTS_IN_PROD`)
    - `services/clawsettle/README.md`
    - updated smoke script to assert livemode mismatch behavior
- Tests + quality checks
  - `cd services/clawsettle && npm test && npm run lint && npm run typecheck`
  - Added/extended tests in `services/clawsettle/test/stripe-webhook.test.ts`:
    - staging live-event reject
    - production test-event reject (default)
    - production test-event allow (override flag)
  - `node scripts/docs/lint-prds.mjs`
- Routing + deployment notes
  - clawsettle production routes were previously parked on `claw-domains`; moved route ownership to `services/clawsettle` by removing:
    - `clawsettle.com/*`
    - `www.clawsettle.com/*`
    from `services/claw-domains/wrangler.toml` and deploying `claw-domains`.
  - Also removed stale `clawea.com` route entries from `claw-domains` to keep route ownership conflict-free with `clawea-www`.
- Migration/deploy evidence
  - Staging migration apply:
    - `wrangler d1 migrations apply clawsettle-staging --env staging --remote` (no pending migrations)
  - Production migration apply:
    - `wrangler d1 migrations apply clawsettle --remote`
    - applied: `0001_create_stripe_webhook_events.sql`
  - Deployed staging service:
    - `clawsettle-staging` code version: `068cedf2-28bd-415b-93a1-16c397ddbbe1`
    - active version after secret updates: `914df775-4ca7-4ecb-925b-c7b54127af21`
  - Deployed production service:
    - `clawsettle` code version: `c3221d9d-b242-47c6-b70e-a9302f62a017`
    - active version after secret updates: `169a0407-1f5c-4aca-bf30-86732e909d59`
  - Secrets updated (names only):
    - staging: `LEDGER_ADMIN_KEY`, `STRIPE_WEBHOOK_SIGNING_SECRET`
    - production: `LEDGER_ADMIN_KEY`, `STRIPE_WEBHOOK_SIGNING_SECRET`
- Staging smoke evidence
  - Command:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-stripe-webhook.mjs --env staging`
  - Highlights:
    - webhook accepted + forwarded (`200`, `deduped:false`, `forwarded_to_ledger:true`)
    - replay dedupe (`200`, `deduped:true`)
    - tampered signature reject (`401 SIGNATURE_INVALID`)
    - livemode guard mismatch reject (`422 LIVEMODE_MISMATCH`, expected_livemode=false)
    - settlement lookup confirmed, account available `1234`
- Production smoke evidence
  - Command:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-stripe-webhook.mjs --env prod`
  - Highlights:
    - webhook accepted + forwarded (`200`, `deduped:false`, `forwarded_to_ledger:true`)
    - replay dedupe (`200`, `deduped:true`)
    - tampered signature reject (`401 SIGNATURE_INVALID`)
    - livemode guard mismatch reject (`422 LIVEMODE_MISMATCH`, expected_livemode=true)
    - settlement lookup confirmed, account available `1234`
- Release status
  - MPY-US-006 shipped to staging + production.
  - MPY-US-007 queued next (durable outbox + retry exact-once hardening).
---

## 2026-02-11T16:28:00Z - MPY-US-007 (durable forwarding outbox + retry)
- What was implemented
  - Added durable forwarding outbox persistence in `services/clawsettle/src/stripe.ts`:
    - verified + mapped settlement events are persisted before any ledger forwarding attempt
    - outbox rows track status (`pending|failed|forwarded`), attempts, next retry time, last error metadata, settlement id
  - Added reliable forwarding retry paths:
    - scheduled retry via Worker cron (`*/2 * * * *`)
    - admin-triggered retry endpoint: `POST /v1/stripe/forwarding/retry`
      - requires `SETTLE_ADMIN_KEY`
      - supports deterministic controls `{ limit, force, event_id }`
  - Added deterministic failure signaling on initial forward failure:
    - webhook returns `502 LEDGER_INGEST_FAILED`
    - details include `retry_scheduled: true`, `next_retry_at`, `ledger_status`
  - Preserved exact-once semantics under replay/retry races:
    - forwarding remains keyed by `stripe:event:<event_id>` idempotency key
    - once outbox is `forwarded`, further retries do not re-forward
    - webhook dedupe record persists successful forwarded result for deterministic replays
- Schema/migration
  - Added migration:
    - `services/clawsettle/migrations/0002_create_stripe_webhook_outbox.sql`
  - Applied migrations:
    - staging: `wrangler d1 migrations apply clawsettle-staging --env staging --remote` (applied 0002)
    - production: `wrangler d1 migrations apply clawsettle --remote` (applied 0002)
- Tests + quality checks
  - `cd services/clawsettle && npm test && npm run lint && npm run typecheck`
  - Extended tests (`services/clawsettle/test/stripe-webhook.test.ts`):
    - fail-first forward -> retry success -> replay dedupe -> no extra forwarding
    - livemode guard and signature/replay coverage preserved
  - `node scripts/docs/lint-prds.mjs`
- Deploy evidence
  - Deployed staging service:
    - `clawsettle-staging` version: `cf0acb43-52a3-415f-9b05-06d32db15636`
  - Deployed production service:
    - `clawsettle` version: `5ab4669c-3f86-4514-8b2a-36b259aea078`
  - Cron active in both environments:
    - `schedule: */2 * * * *`
  - Secrets updated (names only):
    - staging: `SETTLE_ADMIN_KEY`
    - production: `SETTLE_ADMIN_KEY`
- Staging smoke evidence
  - Livemode + webhook baseline:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-stripe-webhook.mjs --env staging`
    - pass: accept/replay/tamper/livemode mismatch/settlement/account all expected
  - Retry/outbox exact-once:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-forwarding-retry.mjs --env staging`
    - highlights:
      - first webhook: `502 LEDGER_INGEST_FAILED` with `retry_scheduled=true`
      - retry #1 for event: `attempted=1`, `forwarded=1`, `failed=0`
      - retry #2 for same event: `attempted=0`, `forwarded=0`
      - replay webhook: `200 deduped=true`
      - settlement confirmed; account available `1234` (no double-credit)
- Production smoke evidence
  - Livemode + webhook baseline:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-stripe-webhook.mjs --env prod`
    - pass: accept/replay/tamper/livemode mismatch/settlement/account all expected
  - Retry/outbox exact-once:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-forwarding-retry.mjs --env prod`
    - highlights:
      - first webhook: `502 LEDGER_INGEST_FAILED` with `retry_scheduled=true`
      - retry #1 for event: `attempted=1`, `forwarded=1`, `failed=0`
      - retry #2 for same event: `attempted=0`, `forwarded=0`
      - replay webhook: `200 deduped=true`
      - settlement confirmed; account available `1234` (no double-credit)
- Release status
  - MPY-US-007 shipped to staging + production.
  - M3 package (MPY-US-006 + MPY-US-007) complete.
---

## 2026-02-11T17:20:00Z - MPY-US-008/009/010 (payout initiation + lifecycle + reconciliation)
- What was implemented
  - Added payout domain module `services/clawsettle/src/payouts.ts` with:
    - deterministic payout initiation + idempotency key handling
    - deterministic lock-before-provider semantics via ledger bucket move (A -> H)
    - payout lifecycle state machine (`initiated`, `submitted`, `finalizing_paid`, `finalizing_failed`, `paid`, `failed`)
    - exact-once finalize/rollback semantics:
      - `payout.paid` -> held to clearing drain (`H -> clearing:A`)
      - `payout.failed` -> held rollback (`H -> A`)
    - lifecycle-safe retry API for stuck transitional statuses
    - daily reconciliation report generator + deterministic CSV exporter + artifact hash
    - ops visibility APIs for stuck/failed payouts
  - Added new HTTP endpoints in `services/clawsettle/src/index.ts`:
    - `POST /v1/payouts/connect/onboard`
    - `POST /v1/payouts`
    - `GET /v1/payouts/:id`
    - `POST /v1/payouts/:id/retry` (admin)
    - `GET /v1/payouts/ops/stuck` (admin)
    - `GET /v1/payouts/ops/failed` (admin)
    - `GET /v1/reconciliation/payouts/daily?date=YYYY-MM-DD&format=json|csv` (admin)
  - Integrated payout lifecycle hook into Stripe webhook forwarding path:
    - `StripeWebhookService` now runs lifecycle hook only after successful settlement ingest and retries hook failures through outbox retry lifecycle.
  - Added deterministic payout/reconciliation persistence schema:
    - `services/clawsettle/migrations/0003_create_payouts.sql`
    - tables:
      - `payout_connect_accounts`
      - `payouts`
      - `payout_audit_events`
- Config updates
  - `services/clawsettle/wrangler.toml` new vars:
    - `PAYOUTS_CLEARING_DOMAIN`
    - `PAYOUT_STUCK_MINUTES_DEFAULT`
    - `STRIPE_CONNECT_ONBOARD_BASE_URL`
- Tests + quality checks
  - `cd services/clawsettle && npm test && npm run lint && npm run typecheck`
  - Added test suite:
    - `services/clawsettle/test/payouts.test.ts`
      - onboarding + payout creation + idempotency reuse mismatch protection
      - payout.paid exact-once finalize semantics
      - payout.failed exact-once rollback + targeted retry from stuck finalizing state
      - deterministic reconciliation report + CSV export
  - Extended `services/clawsettle/test/stripe-webhook.test.ts`:
    - lifecycle-hook failure is retried via forwarding outbox without double side effects
  - `node scripts/docs/lint-prds.mjs`
- Migration/deploy evidence
  - Applied migrations:
    - staging: `wrangler d1 migrations apply clawsettle-staging --env staging --remote` (applied `0003_create_payouts.sql`)
    - production: `wrangler d1 migrations apply clawsettle --remote` (applied `0003_create_payouts.sql`)
  - Deployed staging:
    - `clawsettle-staging` version `291d87ef-b966-4248-bb2f-7fb16534fae6`
  - Deployed production:
    - `clawsettle` version `cc3bd7ed-9fc3-44d4-9ef4-f3638b0524fb`
- Staging smoke evidence
  - Payout lifecycle smoke:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-payout-lifecycle.mjs --env staging`
    - highlights:
      - payout create idempotent replay (`201` then `200 deduped=true`)
      - lock semantics visible (`available 3800`, `held 1200` after lock)
      - `payout.paid` finalizes exact-once (`status=paid`, held->0)
      - `payout.failed` rollbacks exact-once (`status=failed`, no double-credit on replay)
  - Reconciliation + ops smoke:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-payout-reconciliation.mjs --env staging`
    - highlights:
      - forced stuck state (failed webhook returns `502 LEDGER_INGEST_FAILED`)
      - stuck visibility includes payout (`GET /v1/payouts/ops/stuck`)
      - targeted retry transitions payout to `failed`
      - failed visibility endpoint lists payout (`GET /v1/payouts/ops/failed`)
      - reconciliation JSON and CSV hash match (`x-clawsettle-report-sha256` == `artifact_sha256`)
- Production smoke evidence
  - Payout lifecycle smoke:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-payout-lifecycle.mjs --env prod`
    - same deterministic outcomes as staging for idempotency/lock/finalize/rollback/replay.
  - Reconciliation + ops smoke:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-payout-reconciliation.mjs --env prod`
    - same deterministic outcomes as staging, including stuck visibility + targeted retry + hash-stable report exports.
- Release status
  - MPY-US-008 shipped to staging + production.
  - MPY-US-009 shipped to staging + production.
  - MPY-US-010 shipped to staging + production.
---

## 2026-02-11T17:55:00Z - MPY-US-011 (CST-US-002) deterministic netting engine
- What was implemented
  - Added deterministic netting domain module `services/clawsettle/src/netting.ts` with:
    - replay-safe run idempotency (`idempotency_key` + payload hash guard)
    - deterministic candidate selection (`paid`, `finalized_at <= selection_before`, stable ordering)
    - deterministic entry grouping + per-entry idempotency (`netting:entry:<entry_id>`)
    - one-way run/entry transitions (`created|failed -> running -> applied|failed`, `pending|failed -> applying -> applied|failed`)
    - fail-closed collision handling (`DUPLICATE_CONFLICT`, `INVALID_STATUS_TRANSITION`, `IDEMPOTENCY_KEY_REUSED`)
    - exact-once ledger side effects via `findEventByIdempotencyKey` + transfer CAS semantics
    - deterministic JSON/CSV report artifacts with stable hash
  - Added netting persistence migration:
    - `services/clawsettle/migrations/0004_create_netting_runs.sql`
    - tables: `netting_runs`, `netting_entries`, `netting_entry_payouts`
  - Added new endpoints in `services/clawsettle/src/index.ts`:
    - `POST /v1/netting/runs` (admin, idempotency required)
    - `GET /v1/netting/runs/:id` (admin)
    - `GET /v1/netting/runs/:id/report?format=json|csv` (admin)
  - Added tests:
    - `services/clawsettle/test/netting.test.ts`
      - deterministic grouping/ordering invariants
      - exact-once retry/replay behavior
      - overlapping run collision fail-closed behavior
      - stable report hash parity across repeated JSON/CSV exports
  - Added smoke:
    - `scripts/poh/smoke-clawsettle-netting-runs.mjs`
    - supports full bootstrap mode (with Stripe+Ledger env vars) and existing-data mode (SETTLE_ADMIN_KEY only)
  - Config/docs updates:
    - `services/clawsettle/wrangler.toml` (`NETTING_*` vars)
    - `services/clawsettle/README.md`
    - PRD tracker/docs updated before implementation and status-updated post-staging.
- Dependency hardening discovered during staging smoke
  - Initial staging netting runs failed with `LEDGER_INGEST_FAILED` and downstream ledger code `EVENT_WRITE_FAILED` on clearing-origin transfers.
  - Root cause: ledger `events.account_id` FK path expected `accounts.id`; clearing-origin transfers emit clearing IDs.
  - Added ledger compatibility patch in `services/ledger/src/index.ts`:
    - `ensureClearingMirrorUserAccount(...)` creates deterministic internal mirror rows in `accounts` for clearing IDs (`did:internal:clearing:<domain>`) before event writes.
    - unblocks clearing->clearing v1 transfer event persistence without weakening auth/validation.
- Quality checks
  - `cd services/clawsettle && npm run lint && npm run typecheck && npm test`
  - `cd services/ledger && npm run lint && npm run typecheck && npm test`
  - `node scripts/docs/lint-prds.mjs`
- Staging migration/deploy evidence
  - `clawsettle` staging migration:
    - `wrangler d1 migrations apply clawsettle-staging --env staging --remote`
    - applied: `0004_create_netting_runs.sql`
  - `clawsettle` staging deploy versions:
    - `09dbe2ed-a53e-4fca-9e26-fa107470fd7b`
    - `c06144f5-f598-4c16-af29-ac19e91c1a5c`
    - `5f2cc6d1-4611-4c5a-9851-27cd99887883` (current)
  - `clawledger` staging deploy (dependency compatibility fix):
    - `ba6e2082-ffe1-4308-a690-89b790e44023`
  - Staging secret updates (names only):
    - `SETTLE_ADMIN_KEY`
    - `STRIPE_WEBHOOK_SIGNING_SECRET`
- Staging smoke evidence
  - Command:
    - `SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-netting-runs.mjs --env staging`
  - Result highlights:
    - mode: `existing-paid-payouts`
    - run status: `applied`
    - replay: `deduped=true`
    - report hash parity: CSV header hash == JSON `artifact_sha256`
    - follow-up noop run: `candidate_count=0` (no duplicate side effects)
- Release status
  - MPY-US-011 implemented + staging validated.
  - Production migration/deploy/smoke intentionally NOT executed yet.
  - Await explicit **GO PROD** before production rollout and `passes=true` flip.
---

## 2026-02-11T18:35:00Z - MPY-US-011 GO PROD rollout (production window)
- Scope executed (ordered)
  1) ledger compatibility fix deployed to production first (dependency guard)
  2) ledger regression smoke executed
  3) clawsettle migration `0004_create_netting_runs.sql` applied in production
  4) clawsettle production deploy completed
  5) full clawsettle regression set executed in production:
     - webhook/livemode
     - forwarding retry exact-once
     - payout lifecycle
     - payout reconciliation
     - netting runs
  6) tracker flip: MPY-US-011 `passes=true`
- Production deploy/migration evidence
  - `clawledger` production deploy version: `7262d8df-6271-40bd-ae80-1b159a8c8d4b`
  - `clawsettle` production migration applied:
    - `0004_create_netting_runs.sql`
  - `clawsettle` production deploy version: `6abcb814-217b-4c61-b59f-452e3021e02e`
- Production smoke evidence
  - Ledger regression:
    - `LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-ledger-payment-settlements.mjs --env prod --parallel-burst 8`
    - pass: confirm/replay/reversal + burst exact-once invariants
  - clawsettle regression set:
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-stripe-webhook.mjs --env prod`
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-forwarding-retry.mjs --env prod`
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-payout-lifecycle.mjs --env prod`
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-payout-reconciliation.mjs --env prod`
    - `STRIPE_WEBHOOK_SIGNING_SECRET=*** LEDGER_ADMIN_KEY=*** SETTLE_ADMIN_KEY=*** node scripts/poh/smoke-clawsettle-netting-runs.mjs --env prod`
  - highlights:
    - webhook/livemode: signature reject + `LIVEMODE_MISMATCH` fail-closed + forward/replay OK
    - forwarding retry: fail-first (`LEDGER_INGEST_FAILED`) -> retry success -> replay dedupe -> no double-credit
    - payout lifecycle: paid finalize exact-once + failed rollback exact-once
    - reconciliation: JSON/CSV hash parity deterministic
    - netting: run applied, replay deduped, deterministic report hash parity, post-run no duplicate side effects
- Secrets ops (names only; values not logged)
  - production `LEDGER_ADMIN_KEY` updated for `clawledger`, `clawsettle`, `clawproxy`, `clawescrow`
  - production `SETTLE_ADMIN_KEY` and `STRIPE_WEBHOOK_SIGNING_SECRET` updated for `clawsettle`
- Release status
  - MPY-US-011 shipped to staging + production.
---

## 2026-02-12 - CIN-OPS-001 dependency extension
- Added admin payout listing endpoint `GET /v1/payouts` for clawincome integration:
  - required query: `from`, `to`
  - optional: `account_did`, `status`, `cursor`, `limit`
  - deterministic cursor pagination by `(created_at, payout_id)`
- Updated landing/docs endpoint list to include list API.
- Deploys:
  - `clawsettle-staging`: `6dcd7a27-ef74-43c1-a36f-872f172b69d0`
  - `clawsettle` (prod): `b0170168-a6a4-4843-bbe5-282e9be7ec9c`
- Secret rotation follow-up (staging+prod):
  - `SETTLE_ADMIN_KEY` rotated and aligned with clawincome integration.

## 2026-02-12 - MPY-US-012 (ECON-RISK-MAX-001) implementation in progress
- Added adverse loss-event normalization surface in clawsettle:
  - `POST /v1/loss-events` (idempotent, deterministic request hash)
  - `GET /v1/loss-events`
  - `GET /v1/loss-events/:id`
  - `GET /v1/loss-events/outbox`
  - `POST /v1/loss-events/ops/retry`
- Added durable outbox schema + processing logic:
  - migration `migrations/0005_create_loss_event_loop.sql`
  - tables: `loss_events`, `loss_event_outbox`
  - deterministic per-target idempotency fanout keys `loss-event:<id>:<target>`
- Added queue + cron retry path:
  - wrangler queue binding `LOSS_EVENTS` (+ staging variant)
  - queue consumer handler in worker
  - scheduled retry integrated with existing stripe forwarding retry loop
- Added new smoke/watch scripts:
  - `scripts/poh/smoke-econ-risk-loss-loop.mjs`
  - `scripts/poh/watch-econ-risk-loss-events.mjs`
- Validation (local):
  - `pnpm --dir services/clawsettle typecheck` ✅
  - `pnpm --dir services/clawsettle test` ✅
- Status:
  - MPY-US-012 remains `passes:false` until staging+prod migration/deploy + smoke/watch artifacts are captured.

## 2026-02-12 - MPY-US-012 rollout complete (staging + prod)
- Applied migration `migrations/0005_create_loss_event_loop.sql` remotely in staging+prod.
- Created Cloudflare queues for loss-event fanout + DLQ:
  - `clawsettle-loss-events`, `clawsettle-loss-events-dlq`
  - `clawsettle-loss-events-staging`, `clawsettle-loss-events-dlq-staging`
- Deployed clawsettle versions:
  - staging `5fcd9a2b-1ea8-4746-906a-a6019c49d698`
  - prod `2199a3d0-c889-4fb9-bbf2-d4a880d763df`
- ECON risk-loop smoke evidence (fully forwarded all 5 targets):
  - `artifacts/simulations/econ-risk-loss-loop/2026-02-12T04-56-17-530Z-staging/smoke.json`
  - `artifacts/simulations/econ-risk-loss-loop/2026-02-12T05-00-54-595Z-prod/smoke.json`
- Watch evidence (`event_failed_count=0`, `outbox_failed_count=0`):
  - `artifacts/ops/econ-risk/2026-02-12T05-01-24-573Z-staging-loss-event-watch/summary.json`
  - `artifacts/ops/econ-risk/2026-02-12T05-01-27-688Z-prod-loss-event-watch/summary.json`
- Consolidated rollout summary:
  - `artifacts/ops/econ-risk/2026-02-12T05-02-40Z-econ-risk-max-rollout/deploy-summary.json`

## 2026-02-12 - MPY-US-013 rollout complete (staging + prod)
- Applied migration `migrations/0006_loss_event_resolution.sql` remotely in staging+prod.
- Deployed clawsettle versions:
  - staging `0884e281-ef21-46e2-81e5-805082d22aee`
  - prod `738f89fc-774a-4ed5-b292-31151e6d7fb9`
- Added deterministic resolve/unfreeze lifecycle:
  - `POST /v1/loss-events/:id/resolve`
  - operation-aware outbox/retry (`operation=apply|resolve`)
  - resolve outbox targets: ledger release-by-source, escrow risk-hold release, clawbounties risk clear
- ECON apply→resolve smoke evidence:
  - `artifacts/simulations/econ-risk-loss-resolve-loop/2026-02-12T14-23-31-632Z-staging/smoke.json`
  - `artifacts/simulations/econ-risk-loss-resolve-loop/2026-02-12T14-28-29-206Z-prod/smoke.json`
- Watch evidence (deterministic failed buckets apply=0 resolve=0):
  - `artifacts/ops/econ-risk/2026-02-12T14-25-43-531Z-staging-loss-event-watch/summary.json` (limit=5)
  - `artifacts/ops/econ-risk/2026-02-12T14-28-43-320Z-prod-loss-event-watch/summary.json`
- Consolidated rollout summary:
  - `artifacts/ops/econ-risk/2026-02-12T14-29-11Z-econ-risk-max-002-rollout/deploy-summary.json`

## 2026-02-12 - Post-merge stabilization watch (MAX-002 merge + 2h soak)
- PR #175 merged (merge commit `45c9ffa`); PR #174 (Claw Verified pipeline) merged first (`215e12c`).
- Post-merge loss-event watch (apply+resolve outboxes, limit=5):
  - staging: `artifacts/ops/econ-risk/2026-02-12T17-02-22-661Z-staging-loss-event-watch/summary.json`
    - deterministic error buckets: event_failed=0, outbox_apply_failed=0, outbox_resolve_failed=0
  - prod: `artifacts/ops/econ-risk/2026-02-12T17-02-27-122Z-prod-loss-event-watch/summary.json`
    - deterministic error buckets: event_failed=0, outbox_apply_failed=0, outbox_resolve_failed=0
- Conclusion: apply+resolve pipelines stable post-merge. No regressions.

## 2026-02-12 - ECON-RISK-MAX-003 implementation + rollout (staging + prod)
- What was implemented:
  - Stripe dispute lifecycle → loss-event automation bridge (`services/clawsettle/src/disputes.ts`):
    - `charge.dispute.created` → creates loss event (apply freeze)
    - `charge.dispute.closed` (status=won) → resolves loss event (unfreeze)
    - `charge.dispute.closed` (status=lost) → marks permanent loss (stays frozen)
    - `charge.dispute.updated` → updates bridge metadata (no state change)
  - New `dispute_loss_event_bridge` table (`migrations/0007_create_dispute_loss_event_bridge.sql`):
    - Maps Stripe dispute IDs to loss event IDs for deterministic resolution lookups
    - UNIQUE on dispute_id, indexed by loss_event_id and status
  - Integrated bridge into webhook handler (`services/clawsettle/src/index.ts`):
    - After processWebhook, classifies dispute events and bridges to loss-event pipeline
    - Triggers inline forwarding for new loss events and resolve operations
  - Tests (`services/clawsettle/test/disputes.test.ts`):
    - 9 tests covering all action classifications, expanded charge objects,
      missing account_id fail-closed, invalid amounts
  - Smoke script (`scripts/poh/smoke-stripe-dispute-lifecycle.mjs`):
    - Full lifecycle: create dispute → verify → idempotency replay → forwarding → resolve gating → permanent loss
- Quality checks:
  - `npx tsc --noEmit` ✅
  - `npx vitest run` ✅ (32 tests, 5 suites, 0 failures)
  - `node scripts/docs/lint-prds.mjs` ✅
- Migration/deploy evidence:
  - Staging: migration 0007 applied, deployed version `28d87f92`
  - Prod: migration 0007 applied, deployed version `787c390d`
- Staging smoke evidence:
  - `artifacts/simulations/stripe-dispute-lifecycle/2026-02-12T17-13-31-299Z-staging/smoke.json`
  - All 8 steps passed: create (201), verify (200), idempotency replay (200 deduped),
    forwarding (1/3 forwarded, 2/3 failed for synthetic accounts),
    resolve gating (409 LOSS_EVENT_NOT_READY — correct MAX-002 behavior),
    permanent loss (201, stays recorded/not-resolved)
- Prod smoke evidence:
  - `artifacts/simulations/stripe-dispute-lifecycle/2026-02-12T17-14-25-050Z-prod/smoke.json`
  - Identical behavior: all 8 steps passed
- Post-deploy watch:
  - staging: `artifacts/ops/econ-risk/2026-02-12T17-14-29-625Z-staging-loss-event-watch/summary.json`
    - event_failed=1 (pre-existing), outbox_resolve_failed=0
  - prod: `artifacts/ops/econ-risk/2026-02-12T17-15-27-456Z-prod-loss-event-watch/summary.json`
    - event_failed=0, outbox_resolve_failed=0
