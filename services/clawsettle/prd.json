{
  "project": "clawbureau",
  "branchName": "feat/economy/MPY-US-011-clawsettle-netting-engine",
  "description": "clawsettle.com (Settlement) â€” provider adapter layer for external rails mapped into clawledger settlement semantics.",
  "userStories": [
    {
      "id": "MPY-US-003",
      "title": "Stripe webhook verification + ledger settlement forwarding",
      "description": "As a settlement adapter, I want to verify Stripe webhooks fail-closed and forward canonical settlement updates to clawledger using deterministic idempotency keys.",
      "acceptanceCriteria": [
        "Create services/clawsettle worker scaffold with staging/prod wrangler config",
        "Implement POST /v1/stripe/webhook with fail-closed signature verification",
        "Map verified Stripe events to clawledger POST /v1/payments/settlements/ingest with idempotency key stripe:event:<event_id>",
        "Add tests for valid signature, tampered signature, and replay dedupe",
        "Add staging smoke script and run staging deploy/smoke evidence",
        "Do not deploy production in this phase"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Shipped to staging only in MPY-US-003 phase. Later phases add production activation + reliability hardening."
    },
    {
      "id": "MPY-US-006",
      "title": "clawsettle production activation + livemode hardening",
      "description": "As an operator, I want clawsettle production-ready with strict Stripe livemode environment guardrails so test/live rails cannot cross-contaminate environments.",
      "acceptanceCriteria": [
        "Deploy clawsettle to production with migration + smoke evidence",
        "Staging rejects live Stripe events",
        "Production rejects Stripe test-mode events unless explicitly allowed by flag",
        "Return deterministic fail-closed livemode mismatch error",
        "Keep signature verification + replay dedupe semantics intact"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Shipped to staging + production: clawsettle activated on prod routes, strict livemode guard enforced with deterministic LIVEMODE_MISMATCH fail-closed behavior, signature verification and replay dedupe preserved."
    },
    {
      "id": "MPY-US-007",
      "title": "Reliable forwarding outbox + retry",
      "description": "As a settlement operator, I want verified webhook events persisted before forwarding with durable retry semantics so transient ledger failures cannot silently drop settlements.",
      "acceptanceCriteria": [
        "Persist verified webhook events in durable forwarding outbox before ledger forwarding",
        "Retry failed forwarding via cron/manual trigger",
        "Preserve exact-once economic side effects under replay/retry races",
        "Provide deterministic status/error outputs for retry lifecycle",
        "Add smoke: initial failure -> retry success -> no double-credit"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Shipped to staging + production: verified webhook events now persist in durable outbox before forwarding, failed forwards are retried (cron + admin endpoint), replay/retry races remain idempotent with exactly-once economic outcomes."
    },
    {
      "id": "MPY-US-008",
      "title": "CST-US-001 payout initiation + deterministic ledger lock",
      "description": "As a payout operator, I want deterministic payout initiation with pre-flight balance checks and lock-before-provider semantics so funds cannot be over-released under retries.",
      "acceptanceCriteria": [
        "Implement POST /v1/payouts/connect/onboard",
        "Implement POST /v1/payouts",
        "Enforce ledger balance checks before payout lock",
        "Apply deterministic lock semantics before external payout submission",
        "Enforce idempotent payout request keys with fail-closed deterministic errors"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Shipped to staging + production: added payout onboarding + payout initiation endpoints with deterministic idempotency keys, explicit balance checks, and lock-before-provider semantics."
    },
    {
      "id": "MPY-US-009",
      "title": "CST-US-003 payout lifecycle state machine + status endpoint",
      "description": "As finance ops, I want payout status transitions to be explicit and exact-once so webhook replay/retry races cannot cause double-release or double-credit outcomes.",
      "acceptanceCriteria": [
        "Implement payout state machine + GET /v1/payouts/:id",
        "Wire payout.paid to exact-once finalize behavior",
        "Wire payout.failed to exact-once rollback behavior",
        "Preserve deterministic lifecycle errors (including INVALID_STATUS_TRANSITION)",
        "Prove no double-credit / double-release under replay + retry races"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Shipped to staging + production: payout lifecycle state machine + GET /v1/payouts/:id + exact-once payout.paid finalize and payout.failed rollback behavior with replay/race safety."
    },
    {
      "id": "MPY-US-010",
      "title": "CST-US-004 payout reconciliation + ops reporting",
      "description": "As finance ops, I want deterministic reconciliation exports and stuck/failed payout controls so operational recovery is auditable and repeatable.",
      "acceptanceCriteria": [
        "Implement daily payout reconciliation report",
        "Add deterministic CSV/export output",
        "Provide stuck/failed payout visibility endpoints",
        "Add targeted payout retry controls",
        "Emit deterministic audit artifacts for finance operations"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Shipped to staging + production: daily payout reconciliation JSON/CSV with deterministic artifact hash, stuck/failed ops visibility, and targeted payout retry controls."
    },
    {
      "id": "MPY-US-011",
      "title": "CST-US-002 deterministic netting engine",
      "description": "As finance ops, I want deterministic and replay-safe payout netting runs so settlement batching is auditable and cannot double-apply under retries or races.",
      "acceptanceCriteria": [
        "Add netting persistence schema (`netting_runs`, `netting_entries`) with replay-safe uniques/indexes",
        "Implement POST /v1/netting/runs (admin) for deterministic run create/execute",
        "Implement GET /v1/netting/runs/:id status/summary endpoint",
        "Implement GET /v1/netting/runs/:id/report?format=json|csv with stable report hash",
        "Deterministically select eligible payouts, compute minor-unit net amounts, and emit stable idempotency keys per netting entry",
        "Prevent duplicate economic side effects under replay/retry/race conditions (including overlapping run collisions)"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Shipped to staging + production: netting schema/endpoints/replay hardening live, production migration/deploy complete, and full regression smoke set passed (webhook/livemode, forwarding retry, payout lifecycle, payout reconciliation, netting runs)."
    }
  ]
}
