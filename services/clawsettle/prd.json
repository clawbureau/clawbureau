{
  "project": "clawbureau",
  "branchName": "feat/economy/MPY-US-011-clawsettle-netting-engine",
  "description": "clawsettle.com (Settlement) — provider adapter layer for external rails mapped into clawledger settlement semantics.",
  "userStories": [
    {
      "id": "MPY-US-003",
      "title": "Stripe webhook verification + ledger settlement forwarding",
      "description": "As a settlement adapter, I want to verify Stripe webhooks fail-closed and forward canonical settlement updates to clawledger using deterministic idempotency keys.",
      "acceptanceCriteria": [
        "Create services/clawsettle worker scaffold with staging/prod wrangler config",
        "Implement POST /v1/stripe/webhook with fail-closed signature verification",
        "Map verified Stripe events to clawledger POST /v1/payments/settlements/ingest with idempotency key stripe:event:<event_id>",
        "Add tests for valid signature, tampered signature, and replay dedupe",
        "Add staging smoke script and run staging deploy/smoke evidence",
        "Do not deploy production in this phase"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Shipped to staging only in MPY-US-003 phase. Later phases add production activation + reliability hardening."
    },
    {
      "id": "MPY-US-006",
      "title": "clawsettle production activation + livemode hardening",
      "description": "As an operator, I want clawsettle production-ready with strict Stripe livemode environment guardrails so test/live rails cannot cross-contaminate environments.",
      "acceptanceCriteria": [
        "Deploy clawsettle to production with migration + smoke evidence",
        "Staging rejects live Stripe events",
        "Production rejects Stripe test-mode events unless explicitly allowed by flag",
        "Return deterministic fail-closed livemode mismatch error",
        "Keep signature verification + replay dedupe semantics intact"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Shipped to staging + production: clawsettle activated on prod routes, strict livemode guard enforced with deterministic LIVEMODE_MISMATCH fail-closed behavior, signature verification and replay dedupe preserved."
    },
    {
      "id": "MPY-US-007",
      "title": "Reliable forwarding outbox + retry",
      "description": "As a settlement operator, I want verified webhook events persisted before forwarding with durable retry semantics so transient ledger failures cannot silently drop settlements.",
      "acceptanceCriteria": [
        "Persist verified webhook events in durable forwarding outbox before ledger forwarding",
        "Retry failed forwarding via cron/manual trigger",
        "Preserve exact-once economic side effects under replay/retry races",
        "Provide deterministic status/error outputs for retry lifecycle",
        "Add smoke: initial failure -> retry success -> no double-credit"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Shipped to staging + production: verified webhook events now persist in durable outbox before forwarding, failed forwards are retried (cron + admin endpoint), replay/retry races remain idempotent with exactly-once economic outcomes."
    },
    {
      "id": "MPY-US-008",
      "title": "CST-US-001 payout initiation + deterministic ledger lock",
      "description": "As a payout operator, I want deterministic payout initiation with pre-flight balance checks and lock-before-provider semantics so funds cannot be over-released under retries.",
      "acceptanceCriteria": [
        "Implement POST /v1/payouts/connect/onboard",
        "Implement POST /v1/payouts",
        "Enforce ledger balance checks before payout lock",
        "Apply deterministic lock semantics before external payout submission",
        "Enforce idempotent payout request keys with fail-closed deterministic errors"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Shipped to staging + production: added payout onboarding + payout initiation endpoints with deterministic idempotency keys, explicit balance checks, and lock-before-provider semantics."
    },
    {
      "id": "MPY-US-009",
      "title": "CST-US-003 payout lifecycle state machine + status endpoint",
      "description": "As finance ops, I want payout status transitions to be explicit and exact-once so webhook replay/retry races cannot cause double-release or double-credit outcomes.",
      "acceptanceCriteria": [
        "Implement payout state machine + GET /v1/payouts/:id",
        "Wire payout.paid to exact-once finalize behavior",
        "Wire payout.failed to exact-once rollback behavior",
        "Preserve deterministic lifecycle errors (including INVALID_STATUS_TRANSITION)",
        "Prove no double-credit / double-release under replay + retry races"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Shipped to staging + production: payout lifecycle state machine + GET /v1/payouts/:id + exact-once payout.paid finalize and payout.failed rollback behavior with replay/race safety."
    },
    {
      "id": "MPY-US-010",
      "title": "CST-US-004 payout reconciliation + ops reporting",
      "description": "As finance ops, I want deterministic reconciliation exports and stuck/failed payout controls so operational recovery is auditable and repeatable.",
      "acceptanceCriteria": [
        "Implement daily payout reconciliation report",
        "Add deterministic CSV/export output",
        "Provide stuck/failed payout visibility endpoints",
        "Add targeted payout retry controls",
        "Emit deterministic audit artifacts for finance operations"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Shipped to staging + production: daily payout reconciliation JSON/CSV with deterministic artifact hash, stuck/failed ops visibility, and targeted payout retry controls."
    },
    {
      "id": "MPY-US-011",
      "title": "CST-US-002 deterministic netting engine",
      "description": "As finance ops, I want deterministic and replay-safe payout netting runs so settlement batching is auditable and cannot double-apply under retries or races.",
      "acceptanceCriteria": [
        "Add netting persistence schema (`netting_runs`, `netting_entries`) with replay-safe uniques/indexes",
        "Implement POST /v1/netting/runs (admin) for deterministic run create/execute",
        "Implement GET /v1/netting/runs/:id status/summary endpoint",
        "Implement GET /v1/netting/runs/:id/report?format=json|csv with stable report hash",
        "Deterministically select eligible payouts, compute minor-unit net amounts, and emit stable idempotency keys per netting entry",
        "Prevent duplicate economic side effects under replay/retry/race conditions (including overlapping run collisions)"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Shipped to staging + production: netting schema/endpoints/replay hardening live, production migration/deploy complete, and full regression smoke set passed (webhook/livemode, forwarding retry, payout lifecycle, payout reconciliation, netting runs)."
    },
    {
      "id": "MPY-US-012",
      "title": "Adverse loss-event normalization + fanout outbox",
      "description": "As economy ops, I want clawsettle to canonicalize adverse financial loss events and fan them out through a replay-safe outbox so downstream risk controls are deterministic and auditable.",
      "acceptanceCriteria": [
        "Implement POST /v1/loss-events with strict idempotency and deterministic request hash",
        "Persist canonical loss_events + loss_event_outbox records with replay-safe uniqueness",
        "Forward to ledger/escrow/insurance/income/bounties risk handlers with deterministic per-target idempotency keys",
        "Support queue + cron/manual retry execution paths with deterministic error buckets",
        "Expose GET /v1/loss-events, GET /v1/loss-events/:id, GET /v1/loss-events/outbox, POST /v1/loss-events/ops/retry"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Shipped to staging+prod with migration 0005 + queue fanout bindings live. Evidence: smokes artifacts/simulations/econ-risk-loss-loop/2026-02-12T04-56-17-530Z-staging/smoke.json and artifacts/simulations/econ-risk-loss-loop/2026-02-12T05-00-54-595Z-prod/smoke.json; watches artifacts/ops/econ-risk/2026-02-12T05-01-24-573Z-staging-loss-event-watch/summary.json and artifacts/ops/econ-risk/2026-02-12T05-01-27-688Z-prod-loss-event-watch/summary.json (failed buckets = 0)."
    },
    {
      "id": "MPY-US-013",
      "title": "Loss-event resolution + deterministic unfreeze",
      "description": "As economy ops, I want a deterministic loss-event resolve lifecycle that releases downstream risk holds (ledger/escrow/bounties) via a separate replay-safe outbox so freezes can be cleared safely and audibly.",
      "acceptanceCriteria": [
        "Implement POST /v1/loss-events/:id/resolve (admin, idempotency required)",
        "Fail-closed: resolve returns 409 unless the loss event apply status is forwarded",
        "Persist loss_event_resolutions + loss_event_resolution_outbox with replay-safe uniqueness",
        "Forward resolve fanout to ledger (release-by-source), escrow (risk-hold release), and clawbounties (risk clear record)",
        "Support operation=apply|resolve on GET /v1/loss-events/outbox and POST /v1/loss-events/ops/retry",
        "Cron + queue retry paths cover both apply and resolve outboxes",
        "Capture staging + production deploy + smoke + watch evidence (deterministic error buckets zero)"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Shipped to staging+prod with migration 0006 loss_event_resolutions + loss_event_resolution_outbox and operation-aware outbox/retry controls. Evidence: deploy summary artifacts/ops/econ-risk/2026-02-12T14-29-11Z-econ-risk-max-002-rollout/deploy-summary.json; smokes artifacts/simulations/econ-risk-loss-resolve-loop/2026-02-12T14-23-31-632Z-staging/smoke.json and artifacts/simulations/econ-risk-loss-resolve-loop/2026-02-12T14-28-29-206Z-prod/smoke.json; watches artifacts/ops/econ-risk/2026-02-12T14-25-43-531Z-staging-loss-event-watch/summary.json (limit=5) and artifacts/ops/econ-risk/2026-02-12T14-28-43-320Z-prod-loss-event-watch/summary.json (failed buckets apply=0 resolve=0)."
    },
    {
      "id": "MPY-US-014",
      "title": "Stripe dispute lifecycle → loss-event automation bridge",
      "description": "As economy ops, I want Stripe dispute webhooks to automatically create/resolve loss events so chargebacks trigger deterministic risk holds and dispute wins release them without manual intervention.",
      "acceptanceCriteria": [
        "Wire charge.dispute.created to create loss event with dispute metadata (dispute_id, charge_id, reason, severity)",
        "Wire charge.dispute.closed (status=won) to resolve the corresponding loss event",
        "Wire charge.dispute.closed (status=lost) to mark permanent loss (leave frozen, no resolve call)",
        "Wire charge.dispute.updated to update bridge metadata without state changes",
        "Persist dispute_loss_event_bridge table for deterministic resolution lookups",
        "Fail-closed when dispute metadata is missing account_id",
        "Idempotent replay-safe on all paths (bridge UNIQUE + loss-event idempotency keys)",
        "Inline forwarding for new loss events and resolve operations when enabled",
        "Capture staging + production deploy + smoke evidence"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Shipped to staging+prod with migration 0007 dispute_loss_event_bridge. Evidence: staging smoke artifacts/simulations/stripe-dispute-lifecycle/2026-02-12T17-13-31-299Z-staging/smoke.json; prod smoke artifacts/simulations/stripe-dispute-lifecycle/2026-02-12T17-14-25-050Z-prod/smoke.json; post-deploy watches artifacts/ops/econ-risk/2026-02-12T17-14-29-625Z-staging-loss-event-watch/summary.json and artifacts/ops/econ-risk/2026-02-12T17-15-27-456Z-prod-loss-event-watch/summary.json."
    },
    {
      "id": "MPY-US-015",
      "title": "Settlement reconciliation hardening — partial disputes, fees, aging, recon",
      "description": "As economy ops, I want dispute tracking to handle partial disputes correctly, record Stripe dispute fees separately, provide aging reports by bucket, and run reconciliation checks comparing dispute bridge records against loss events.",
      "acceptanceCriteria": [
        "Dispute bridge tracks disputed_amount_minor separately from charge amount_minor",
        "Loss event risk hold sized to disputed_amount_minor (partial dispute support)",
        "Stripe dispute fee ($15 standard) recorded in dispute_fees table on dispute.created",
        "Chargeback fee recorded on permanent loss (dispute.closed status=lost)",
        "GET /v1/disputes/aging returns age-bucketed report (0-7d, 7-30d, 30-60d, 60+d)",
        "GET /v1/reconciliation/disputes flags mismatches (missing loss events, amount mismatches, unresolved holds, missing fees)",
        "GET /v1/disputes/fees returns fee records with status/limit filtering",
        "All new endpoints admin-token-gated (SETTLE_ADMIN_KEY)",
        "Migration 0008 applied to staging + production",
        "Staging + production smoke tests passing"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Migration 0008 (dispute_recon_hardening) applied staging (DB 9edcb398) + prod (DB 1f2be28f). Staging deploy 37993c99, prod deploy 8f00eca0. Smoke: 5/5 both envs. Watch: prod event_failed=0, outbox_resolve_failed=0."
    }
  ]
}
