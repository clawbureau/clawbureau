{
  "project": "clawbureau",
  "branchName": "feat/economy/MPY-US-007-clawsettle-forwarding-outbox-retry",
  "description": "clawsettle.com (Settlement) â€” provider adapter layer for external rails mapped into clawledger settlement semantics.",
  "userStories": [
    {
      "id": "MPY-US-003",
      "title": "Stripe webhook verification + ledger settlement forwarding",
      "description": "As a settlement adapter, I want to verify Stripe webhooks fail-closed and forward canonical settlement updates to clawledger using deterministic idempotency keys.",
      "acceptanceCriteria": [
        "Create services/clawsettle worker scaffold with staging/prod wrangler config",
        "Implement POST /v1/stripe/webhook with fail-closed signature verification",
        "Map verified Stripe events to clawledger POST /v1/payments/settlements/ingest with idempotency key stripe:event:<event_id>",
        "Add tests for valid signature, tampered signature, and replay dedupe",
        "Add staging smoke script and run staging deploy/smoke evidence",
        "Do not deploy production in this phase"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Shipped to staging only in MPY-US-003 phase. Later phases add production activation + reliability hardening."
    },
    {
      "id": "MPY-US-006",
      "title": "clawsettle production activation + livemode hardening",
      "description": "As an operator, I want clawsettle production-ready with strict Stripe livemode environment guardrails so test/live rails cannot cross-contaminate environments.",
      "acceptanceCriteria": [
        "Deploy clawsettle to production with migration + smoke evidence",
        "Staging rejects live Stripe events",
        "Production rejects Stripe test-mode events unless explicitly allowed by flag",
        "Return deterministic fail-closed livemode mismatch error",
        "Keep signature verification + replay dedupe semantics intact"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Shipped to staging + production: clawsettle activated on prod routes, strict livemode guard enforced with deterministic LIVEMODE_MISMATCH fail-closed behavior, signature verification and replay dedupe preserved."
    },
    {
      "id": "MPY-US-007",
      "title": "Reliable forwarding outbox + retry",
      "description": "As a settlement operator, I want verified webhook events persisted before forwarding with durable retry semantics so transient ledger failures cannot silently drop settlements.",
      "acceptanceCriteria": [
        "Persist verified webhook events in durable forwarding outbox before ledger forwarding",
        "Retry failed forwarding via cron/manual trigger",
        "Preserve exact-once economic side effects under replay/retry races",
        "Provide deterministic status/error outputs for retry lifecycle",
        "Add smoke: initial failure -> retry success -> no double-credit"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Shipped to staging + production: verified webhook events now persist in durable outbox before forwarding, failed forwards are retried (cron + admin endpoint), replay/retry races remain idempotent with exactly-once economic outcomes."
    }
  ]
}
