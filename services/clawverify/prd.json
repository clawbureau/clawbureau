{
  "project": "clawbureau",
  "branchName": "ralph/clawverify-phase1-trust",
  "description": "clawverify.com (Verification API) \u2014 PRD \u2014 Universal signature verifier for artifacts, messages, receipts, and attestations. Fail-closed on unknown schema/versions.",
  "userStories": [
    {
      "id": "CVF-US-001",
      "title": "Verify artifact signatures",
      "description": "As a verifier, I want to validate artifact envelopes so that I can prove authorship.",
      "acceptanceCriteria": [
        "Reject unknown version/type/algo",
        "Recompute hash and match envelope",
        "Return VALID/INVALID with reason",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented Cloudflare Worker with fail-closed validation and Ed25519 verification"
    },
    {
      "id": "CVF-US-002",
      "title": "Verify message signatures",
      "description": "As a platform, I want to validate signed messages so that I can bind DIDs to accounts.",
      "acceptanceCriteria": [
        "Support message_signature envelopes",
        "Fail if signature invalid",
        "Return signer DID",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented /v1/verify/message endpoint with account_binding, ownership_proof, and challenge_response message types"
    },
    {
      "id": "CVF-US-003",
      "title": "Verify gateway receipts",
      "description": "As a marketplace, I want to validate proxy receipts so that I can enforce proof-of-harness.",
      "acceptanceCriteria": [
        "Validate receipt signature",
        "Check receipt schema",
        "Return verified provider/model",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented /v1/verify/receipt endpoint with GatewayReceiptPayload validation and provider/model return"
    },
    {
      "id": "CVF-US-004",
      "title": "Batch verification",
      "description": "As a auditor, I want to submit multiple envelopes so that I can verify at scale.",
      "acceptanceCriteria": [
        "POST /v1/verify/batch",
        "Return per-item results",
        "Limit batch size to prevent abuse",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Implemented /v1/verify/batch endpoint with 100 item limit, auto-detects envelope type, returns per-item results with valid/invalid counts"
    },
    {
      "id": "CVF-US-005",
      "title": "Verification provenance",
      "description": "As a compliance officer, I want verification results logged so that audits are traceable.",
      "acceptanceCriteria": [
        "Write hash-chained audit log entry",
        "Include request hash + timestamp",
        "Allow retrieval by receipt id",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Implemented D1-backed audit log with hash chaining, /v1/provenance/{receipt_id} retrieval endpoint, and chain verification"
    },
    {
      "id": "CVF-US-006",
      "title": "Public docs and schema registry",
      "description": "As a developer, I want clear verification docs so that I can integrate quickly.",
      "acceptanceCriteria": [
        "Publish schema versions",
        "Provide example payloads",
        "Include fail-closed rules",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Implemented /v1/schemas and /v1/schemas/{id} endpoints with schema definitions, examples, and fail-closed rules for all 8 envelope types"
    },
    {
      "id": "CVF-US-007",
      "title": "Verify proof bundles",
      "description": "As a marketplace, I want proof bundle verification so that trust tiers are automated.",
      "acceptanceCriteria": [
        "Validate URM + event chain + receipts + attestations",
        "Fail closed on unknown schema/version",
        "Return computed trust tier",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented /v1/verify/bundle endpoint with URM, event chain, receipts, and attestations validation. Trust tier computation (unknown/basic/verified/attested/full) based on validated components."
    },
    {
      "id": "CVF-US-008",
      "title": "Verify event chains",
      "description": "As a auditor, I want event chain verification so that logs are tamper-evident.",
      "acceptanceCriteria": [
        "Validate hash chain and root",
        "Enforce run_id consistency",
        "Return chain_root_hash and error codes",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented /v1/verify/event-chain endpoint with hash chain integrity validation, run_id consistency checks, chain_root_hash return, and dedicated error codes (EMPTY_CHAIN, INCONSISTENT_RUN_ID, HASH_CHAIN_BREAK, INVALID_ROOT)"
    },
    {
      "id": "CVF-US-009",
      "title": "Schema registry allowlist",
      "description": "As a developer, I want a schema registry so that validation is deterministic.",
      "acceptanceCriteria": [
        "Publish allowlisted schema ids + versions",
        "Reject unknown ids by default",
        "Provide example payloads per schema",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Implemented SCHEMA_ALLOWLIST with 8 schema IDs and versions. Added GET /v1/schemas/allowlist (list with examples), POST /v1/schemas/validate (fail-closed validation), GET /v1/schemas/:id/example endpoints. Unknown schema IDs return 422 with error details."
    },
    {
      "id": "CVF-US-010",
      "title": "Verify owner attestations",
      "description": "As a platform, I want owner verification so that sybil resistance is possible.",
      "acceptanceCriteria": [
        "Validate owner attestation envelope",
        "Check expiry and provider reference",
        "Return verified/expired/unknown status",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Implemented /v1/verify/owner-attestation endpoint with fail-closed owner_attestation envelope validation, expiry handling (EXPIRED), and owner_status (verified/expired/unknown) semantics."
    },
    {
      "id": "CVF-US-011",
      "title": "Verify commit proofs",
      "description": "As a reviewer, I want commit proof verification so that agent work is trusted.",
      "acceptanceCriteria": [
        "Validate commit proof envelope",
        "Ensure repo claim exists in clawclaim",
        "Return repo + commit + signer DID",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Implemented /v1/verify/commit-proof endpoint with fail-closed commit_proof envelope validation, repo_claim_id allowlist check (clawclaim registry), and response includes repository + commit_sha + signer_did."
    },
    {
      "id": "CVF-US-012",
      "title": "One-call agent verification",
      "description": "As a platform, I want a single verify call so that integrations are easy.",
      "acceptanceCriteria": [
        "Return DID validity + owner status + PoH tier",
        "Include policy compliance (if WPC present)",
        "Include risk flags (optional)",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Added POST /v1/verify/agent endpoint aggregating DID validity, owner attestation status, and PoH tier (mapped from proof bundle trust_tier). Optional policy_hash support returns policy_compliance when present and includes risk_flags + component results; verification fails closed (422) when provided components fail or mismatched subjects."
    },
    {
      "id": "CVF-US-013",
      "title": "Scoped token introspection",
      "description": "As a service, I want token introspection so that authorization is safe.",
      "acceptanceCriteria": [
        "Validate token signature + expiry",
        "Return scope + audience + owner_ref",
        "Log token hash to clawlogs",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Added POST /v1/introspect/scoped-token: validates scoped_token envelope signature + expires_at, returns scope/audience/owner_ref and token_hash_b64u. Logs token hash via structured console log and anchors audit log request_hash_b64u to token_hash_b64u for correlation."
    },
    {
      "id": "CVF-US-014",
      "title": "Public landing + skill docs",
      "description": "As a developer, I want public landing/docs/skill endpoints so that I can discover and integrate clawverify quickly.",
      "acceptanceCriteria": [
        "GET / returns an HTML landing page with links to /docs and /skill.md",
        "GET /docs returns minimal human-readable docs (HTML or markdown)",
        "GET /skill.md returns an OpenClaw-compatible skill file (frontmatter + markdown)",
        "OpenClaw frontmatter: metadata is a single-line JSON object string",
        "GET /robots.txt and /sitemap.xml exist (minimal)",
        "GET /.well-known/security.txt exists",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Added public endpoints to clawverify worker: GET /, /docs, /skill.md (OpenClaw frontmatter with metadata as single-line JSON object string), /robots.txt, /sitemap.xml, and /.well-known/security.txt."
    },
    {
      "id": "CVF-US-015",
      "title": "Golden vector crypto correctness gate",
      "description": "As a platform engineer, I want an authoritative golden vector test so did:key derivation, JCS canonicalization, and Ed25519 signature verification remain compatible across implementations.",
      "acceptanceCriteria": [
        "Load the protocol-m golden vector fixture from packages/schema/fixtures",
        "Verify did:key extraction yields the expected public key",
        "Verify RFC 8785-style JCS canonicalization yields the expected canonical string",
        "Verify Ed25519 signature over the canonical UTF-8 bytes",
        "Test suite passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Added vitest coverage using packages/schema/fixtures/protocol-m-golden-vector.v1.json. Test validates did:key extraction, JCS canonicalization, and Ed25519 signature verification, plus a tamper-negative case."
    },
    {
      "id": "CVF-US-016",
      "title": "Verify DID rotation certificates",
      "description": "As a platform, I want to verify dual-signed DID rotation certificates so trust can survive key rotation without weakening the threat model.",
      "acceptanceCriteria": [
        "Add POST /v1/verify/did-rotation endpoint",
        "Verify both old and new did:key Ed25519 signatures over RFC 8785 JCS canonical bytes (signatures blanked during canonicalization)",
        "Fail closed on unknown fields and malformed certificates",
        "Test suite passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Implemented did_rotation certificate verification (dual signatures) with a small RFC 8785 JCS canonicalizer, plus vitest coverage for valid/tampered/unknown-field cases. Added endpoint to docs and /skill.md metadata."
    },
    {
      "id": "CVF-US-017",
      "title": "Rotation-aware /v1/verify/agent",
      "description": "As a platform, I want /v1/verify/agent to accept DID rotation certificates so older proof components can be used after key rotation without lowering security.",
      "acceptanceCriteria": [
        "VerifyAgentRequest accepts did_rotation_certificates[]",
        "Fail closed if any provided rotation certificate is invalid",
        "Allow owner attestation subject_did mismatch only when it rotates forward to agent_did",
        "Allow proof bundle agent_did mismatch only when it rotates forward to agent_did",
        "Add tests for rotation and no-rotation mismatch cases"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Added optional did_rotation_certificates to VerifyAgentRequest. verifyAgent now verifies provided rotation certs (fail-closed) and allows subject binding mismatches only when old\u2192new rotation is proven. Added vitest coverage for rotated owner attestations."
    },
    {
      "id": "CVF-US-018",
      "title": "Identity control-chain + token-control verification",
      "description": "As an operator, I want deterministic verification of owner/controller/agent chains and token-control claims so sensitive auth decisions are auditable and fail-closed.",
      "acceptanceCriteria": [
        "Add one-call owner/controller/agent chain verification endpoint",
        "Add token-control verification endpoint (scope hash, aud/scope, exp, revocation, transition matrix)",
        "Return deterministic remediation hints for invalid outcomes",
        "Typecheck and tests pass"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Implemented `POST /v1/verify/control-chain` and `POST /v1/verify/token-control` in `services/clawverify/src/index.ts` with new modules `verify-control-chain.ts` and `verify-token-control.ts`. Verification is fail-closed with deterministic error codes (`CONTROL_CHAIN_NOT_FOUND`, `CONTROL_CHAIN_CONTEXT_MISMATCH`, `TOKEN_CONTROL_SCOPE_HASH_MISMATCH`, `TOKEN_CONTROL_SCOPE_MISSING`, `TOKEN_CONTROL_AUDIENCE_MISMATCH`, `TOKEN_CONTROL_TRANSITION_FORBIDDEN`, etc.) and deterministic remediation hints. Added tests `test/control-chain.test.ts` and `test/token-control.test.ts`; passed `npm run typecheck && npm test`. Updated deploys: staging `c2602134-d6ad-4110-b71e-2837edf59082`, prod `8d79f1f9-1a97-4b61-a796-0d1622f0181e`; updated smoke artifacts: `artifacts/smoke/identity-control-plane/2026-02-11T22-42-34-634Z-staging/result.json`, `artifacts/smoke/identity-control-plane/2026-02-11T22-42-46-640Z-prod/result.json`."
    },
    {
      "id": "CVF-US-031",
      "title": "Deterministic key-interoperability error mapping",
      "description": "As downstream gates, we need token-control verifier errors to map upstream kid failures deterministically for automated remediation.",
      "acceptanceCriteria": [
        "Map clawscope `TOKEN_UNKNOWN_KID` to `TOKEN_CONTROL_KEY_UNKNOWN`",
        "Map clawscope `TOKEN_KID_EXPIRED` to `TOKEN_CONTROL_KEY_EXPIRED`",
        "Preserve fail-closed verification behavior",
        "Typecheck and tests pass"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Implemented in `services/clawverify/src/verify-token-control.ts` with new deterministic mapping logic. Added tests in `services/clawverify/test/token-control.test.ts` covering both mappings."
    },
    {
      "id": "CVF-US-032",
      "title": "Verifier remediation semantics for key-overlap operations",
      "description": "As operators, we need remediation hints that explicitly point to key-overlap synchronization and reissue flows.",
      "acceptanceCriteria": [
        "Key-unknown and key-expired failures include deterministic remediation hints",
        "Hints reference overlap contract/jwks refresh semantics",
        "Typecheck and tests pass"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Added deterministic remediation hints for key overlap failures (`REISSUE_TOKEN`, `SYNC_REVOCATION_STREAM`) in token-control verification responses."
    },
    {
      "id": "CVF-US-033",
      "title": "Token-control compatibility contract for downstream integrators",
      "description": "As integration teams, we need a stable compatibility note for kid-overlap transitions and deterministic fail-closed behavior.",
      "acceptanceCriteria": [
        "Publish compatibility guidance with explicit error semantics",
        "Demonstrate behavior with staging/prod interop smoke evidence",
        "Typecheck/tests/smoke pass"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Published compatibility guidance in `scripts/identity/COMPATIBILITY-NOTE-AGENT-C-token-kid.md` and identity runbook `scripts/identity/RUNBOOK-identity-control-plane-operations.md`; validated cross-environment interop via `scripts/identity/smoke-scope-kid-interop.mjs` artifact `artifacts/smoke/identity-control-plane/2026-02-11T22-43-00-300Z-kid-interop/result.json`."
    }
  ]
}
