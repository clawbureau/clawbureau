## Codebase Patterns
- Cloudflare Worker service under `services/clawclaim/`.
- Prefer KV for short-lived challenge storage (10-minute TTL).
- Keep responses JSON and fail closed when required bindings are missing.

# Ralph Progress Log
Started: 2026-02-02T22:45:00Z
---

## 2026-02-02 - CCL-US-001
- Scaffolded `services/clawclaim` Worker.
- Implemented `POST /v1/challenges`:
  - Issues short-lived nonce + deterministic signing message.
  - Stores challenge record in KV with TTL (default 600s).
- Added `GET /health` + `GET /skill.md`.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CCL-US-002
- Added `POST /v1/bind`:
  - Loads stored challenge from KV, validates expiry + DID match.
  - Verifies Ed25519 signature for `did:key` DIDs.
  - Stores a binding record in KV and marks it `active: true`.
  - Deletes challenge on success to prevent replay.
- Added crypto helpers for did:key Ed25519 verification.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CCL-US-003
- Added revoke-capable challenges via `POST /v1/challenges` with optional `purpose` (default: `bind`).
- Implemented `POST /v1/bindings/revoke`:
  - Loads stored challenge from KV, validates expiry + DID match + purpose.
  - Verifies did:key (Ed25519) signature over the challenge message.
  - Marks binding revoked (`active: false`) with `revoked_at` metadata.
  - Logs KV audit event (`events:bindings:*`).
  - Deletes challenge on success to prevent replay.
- Prevent new sessions:
  - Blocks new bind challenges when a binding is revoked.
  - Rejects bind attempts if binding is revoked.
- Typecheck: `npm run typecheck`.
---

## 2026-02-11 - CCL-US-011 / ICP-US-001 (controller-first provisioning hard cutover)
- Added control-plane challenge issuance endpoint:
  - `POST /v1/control-plane/challenges`
  - supports deterministic challenge purposes: `register_controller`, `register_agent`, `update_sensitive_policy`
  - preserves legacy bind/revoke challenge message shape for backwards compatibility
- Added owner-signed control-plane mutation endpoints:
  - `POST /v1/control-plane/controllers/register`
  - `POST /v1/control-plane/controllers/{controller_did}/agents/register`
  - `POST /v1/control-plane/controllers/{controller_did}/sensitive-policy`
- Added deterministic chain read endpoints:
  - `GET /v1/control-plane/controllers/{controller_did}`
  - `GET /v1/control-plane/controllers/{controller_did}/agents`
  - `GET /v1/control-plane/controllers/{controller_did}/agents/{agent_did}`
- Added owner-bound sensitive policy artifacts (`policy_hash_b64u`) and chain records for downstream canonical CST checks.
- Tests:
  - `services/clawclaim/test/control-plane.test.ts`
- Quality checks:
  - `cd services/clawclaim && npm run typecheck && npm test`
- Staging deploy:
  - `clawclaim-staging` version `b5c965a6-eb1d-46a4-b5d5-22152e0bc08b`
- Cross-service smoke evidence:
  - `artifacts/smoke/identity-control-plane/2026-02-11T21-24-17-199Z-staging/result.json`
---

## 2026-02-11 - M1 productionize ICP baseline (post-PR #145)
- Rolled merged ICP baseline to staging + production.
- Deploy versions:
  - staging: `clawclaim-staging` -> `7c1cf0b7-af77-4d21-b29d-b902055519a5`
  - prod: `clawclaim` -> `4af46ea4-05b7-43de-ae1f-6f100b4fde56`
- Smoke evidence (cross-service):
  - staging: `artifacts/smoke/identity-control-plane/2026-02-11T21-47-01-985Z-staging/result.json`
  - prod: `artifacts/smoke/identity-control-plane/2026-02-11T21-47-11-161Z-prod/result.json`
---

## 2026-02-11 - CCL-US-012/013/014/015 (claim lifecycle + portability)
- Added lifecycle challenge purposes in `POST /v1/control-plane/challenges`:
  - `confirm_rotation`
  - `transfer_controller_request`
  - `transfer_controller_confirm`
  - `export_identity`
  - `import_identity`
- Added owner-confirmed rotation continuity endpoint:
  - `POST /v1/control-plane/rotations/confirm`
  - supports `rotation_role=controller|agent`
  - writes deterministic alias records (`control-plane:rotation-alias:*`)
  - chain/list reads now resolve aliases for continuity
- Added controller transfer state machine endpoints:
  - `POST /v1/control-plane/controllers/{controller_did}/transfer/request`
  - `POST /v1/control-plane/controllers/{controller_did}/transfer/confirm`
  - controller state transitions: `active -> transfer_pending -> transferred`
  - freeze semantics enforced: mutation flows fail with `CONTROLLER_TRANSFER_FROZEN` while pending
- Added signed identity export/import endpoints:
  - `POST /v1/control-plane/identity/export`
  - `POST /v1/control-plane/identity/import`
  - signed via `CLAIM_EXPORT_SIGNING_KEY` (HMAC-SHA256)
  - fail-closed checks for tamper/stale/revoked payloads + deterministic import idempotency
- Added config support:
  - `CLAIM_EXPORT_SIGNING_KEY` (secret)
  - `CLAIM_EXPORT_MAX_AGE_SECONDS` (var)
- Tests:
  - `services/clawclaim/test/claim-lifecycle-portability.test.ts`
- Quality checks:
  - `cd services/clawclaim && npm run typecheck && npm test`
  - `cd services/clawscope && npm run typecheck && npm test`
  - `cd services/clawverify && npm run typecheck && npm test`
- Deploy versions:
  - staging: `clawclaim-staging` -> `ace3a741-85e3-4fcb-b582-aac6993d974f`
  - prod: `clawclaim` -> `2b45efe3-7bfd-48b2-a9c2-df5250f51488`
- Cross-service smoke evidence:
  - staging: `artifacts/smoke/identity-control-plane/2026-02-11T22-10-50-682Z-staging/result.json`
  - prod: `artifacts/smoke/identity-control-plane/2026-02-11T22-11-02-225Z-prod/result.json`
---

## 2026-02-11 - M3/M4 Cloudflare runtime hygiene uplift
- Updated Worker runtime compatibility baseline:
  - `services/clawclaim/wrangler.toml` now uses `compatibility_date = "2026-02-11"`
- Re-deployed clawclaim to keep staging/prod runtime parity with identity lane hardening rollout:
  - staging: `clawclaim-staging` -> `d8df6360-b7b8-4800-9bf7-c7a899c4dd73`
  - prod: `clawclaim` -> `247f3971-fbb1-4e31-8cd0-1287ac960b07`
- Cross-service smoke evidence (same tranche):
  - staging: `artifacts/smoke/identity-control-plane/2026-02-11T22-42-34-634Z-staging/result.json`
  - prod: `artifacts/smoke/identity-control-plane/2026-02-11T22-42-46-640Z-prod/result.json`
---

## 2026-02-11 - ICP-M5 CCL-US-004..009 (identity claim productization)
- Added new M5 identity module + route wiring:
  - `services/clawclaim/src/m5-identity.ts`
  - `services/clawclaim/src/index.ts`
- Delivered APIs:
  - platform claims: `POST /v1/platform-claims/register`, `GET /v1/platform-claims/{owner_did}`
  - primary DID/profile: `POST /v1/accounts/{account_id}/primary-did`, `GET /v1/accounts/{account_id}/profile`
  - binding audit: `GET /v1/bindings/audit`, `GET /v1/bindings/audit/export`
  - owner attestations: `POST /v1/owner-attestations/register`, `GET /v1/owner-attestations/{owner_did}`, `GET /v1/owner-attestations/lookup`
  - challenge->CST exchange: `POST /v1/scoped-tokens/challenges`, `POST /v1/scoped-tokens/exchange`
  - org roster claims: `POST /v1/orgs/{org_id}/roster-manifests`, `GET /v1/orgs/{org_id}/roster/latest`
- Provisioned/used Cloudflare storage stack:
  - D1: `clawclaim-identity-registry` + `clawclaim-identity-registry-staging` (migration `0001_identity_registry.sql`)
  - KV cache namespace bindings for profile caching
  - R2 exports: `clawclaim-identity-audit-exports` + `...-staging`
- Added schema contracts:
  - `packages/schema/identity/platform_claim.v1.json`
  - `packages/schema/identity/org_roster_claim_manifest.v1.json`
- Deterministic fail-closed contracts validated in smoke:
  - `TOKEN_EXCHANGE_CHALLENGE_USED`
  - `TRANSITION_UNKNOWN` (from downstream matrix path during exchange smoke)
- Quality checks:
  - `cd services/clawclaim && npm run typecheck && npm test`
  - `cd services/clawscope && npm run typecheck && npm test`
  - `cd services/clawverify && npm run typecheck && npm test`
  - `wrangler deploy --dry-run` (staging/prod env separation checks)
- Deploy versions:
  - staging: `clawclaim-staging` -> `2204a9ff-2376-4910-944c-8b517a526122`
  - prod: `clawclaim` -> `b2be579c-eb85-4c41-b3cd-80a439848368`
- Cross-service M5 smoke evidence:
  - staging: `artifacts/smoke/identity-control-plane/2026-02-11T23-49-28-476Z-staging-m5/result.json`
  - prod: `artifacts/smoke/identity-control-plane/2026-02-11T23-49-48-765Z-prod-m5/result.json`
- Baseline identity release-gate revalidation:
  - hard-cutover staging: `artifacts/smoke/identity-control-plane/2026-02-11T23-57-12-636Z-staging/result.json`
  - hard-cutover prod: `artifacts/smoke/identity-control-plane/2026-02-11T23-57-22-079Z-prod/result.json`
  - kid interop: `artifacts/smoke/identity-control-plane/2026-02-11T23-57-43-712Z-kid-interop/result.json`
---

## 2026-02-12 - CCL-US-016 (M6 scoped-token exchange bootstrap reliability)
- Updated release evidence path to use claim challenge/exchange as canonical CST bootstrap for M6 suite automation.
- Verified deterministic dependency behavior remains fail-closed:
  - `SCOPE_DEPENDENCY_NOT_CONFIGURED` when scope bridge vars/secrets are missing.
- Runtime operations:
  - synchronized scope exchange secret binding (name only): `CLAIM_SCOPE_ADMIN_KEY` in staging + prod.
- Evidence:
  - staging conformance: `artifacts/smoke/identity-control-plane/2026-02-12T00-52-18-553Z-staging/conformance-matrix.json`
  - prod conformance: `artifacts/smoke/identity-control-plane/2026-02-12T00-52-32-525Z-prod/conformance-matrix.json`
- Quality checks:
  - `cd services/clawclaim && npm run typecheck && npm test`
---
