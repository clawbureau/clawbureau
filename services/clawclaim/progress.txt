## Codebase Patterns
- Cloudflare Worker service under `services/clawclaim/`.
- Prefer KV for short-lived challenge storage (10-minute TTL).
- Keep responses JSON and fail closed when required bindings are missing.

# Ralph Progress Log
Started: 2026-02-02T22:45:00Z
---

## 2026-02-02 - CCL-US-001
- Scaffolded `services/clawclaim` Worker.
- Implemented `POST /v1/challenges`:
  - Issues short-lived nonce + deterministic signing message.
  - Stores challenge record in KV with TTL (default 600s).
- Added `GET /health` + `GET /skill.md`.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CCL-US-002
- Added `POST /v1/bind`:
  - Loads stored challenge from KV, validates expiry + DID match.
  - Verifies Ed25519 signature for `did:key` DIDs.
  - Stores a binding record in KV and marks it `active: true`.
  - Deletes challenge on success to prevent replay.
- Added crypto helpers for did:key Ed25519 verification.
- Typecheck: `npm run typecheck`.
---

## 2026-02-02 - CCL-US-003
- Added revoke-capable challenges via `POST /v1/challenges` with optional `purpose` (default: `bind`).
- Implemented `POST /v1/bindings/revoke`:
  - Loads stored challenge from KV, validates expiry + DID match + purpose.
  - Verifies did:key (Ed25519) signature over the challenge message.
  - Marks binding revoked (`active: false`) with `revoked_at` metadata.
  - Logs KV audit event (`events:bindings:*`).
  - Deletes challenge on success to prevent replay.
- Prevent new sessions:
  - Blocks new bind challenges when a binding is revoked.
  - Rejects bind attempts if binding is revoked.
- Typecheck: `npm run typecheck`.
---

## 2026-02-11 - CCL-US-011 / ICP-US-001 (controller-first provisioning hard cutover)
- Added control-plane challenge issuance endpoint:
  - `POST /v1/control-plane/challenges`
  - supports deterministic challenge purposes: `register_controller`, `register_agent`, `update_sensitive_policy`
  - preserves legacy bind/revoke challenge message shape for backwards compatibility
- Added owner-signed control-plane mutation endpoints:
  - `POST /v1/control-plane/controllers/register`
  - `POST /v1/control-plane/controllers/{controller_did}/agents/register`
  - `POST /v1/control-plane/controllers/{controller_did}/sensitive-policy`
- Added deterministic chain read endpoints:
  - `GET /v1/control-plane/controllers/{controller_did}`
  - `GET /v1/control-plane/controllers/{controller_did}/agents`
  - `GET /v1/control-plane/controllers/{controller_did}/agents/{agent_did}`
- Added owner-bound sensitive policy artifacts (`policy_hash_b64u`) and chain records for downstream canonical CST checks.
- Tests:
  - `services/clawclaim/test/control-plane.test.ts`
- Quality checks:
  - `cd services/clawclaim && npm run typecheck && npm test`
- Staging deploy:
  - `clawclaim-staging` version `b5c965a6-eb1d-46a4-b5d5-22152e0bc08b`
- Cross-service smoke evidence:
  - `artifacts/smoke/identity-control-plane/2026-02-11T21-24-17-199Z-staging/result.json`
---
