{
  "project": "clawbureau",
  "branchName": "ralph/clawescrow-phase1-trust",
  "description": "clawescrow.com (Escrow) — PRD — Escrow holds/releases/milestones for agent work.",
  "userStories": [
    {
      "id": "CES-US-001",
      "title": "Create escrow hold",
      "description": "As a requester, I want to lock funds so that work is safe.",
      "acceptanceCriteria": [
        "Hold reduces balance",
        "Return escrow id",
        "Support metadata/terms",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in services/escrow with EscrowService.createEscrow()"
    },
    {
      "id": "CES-US-002",
      "title": "Release escrow",
      "description": "As a requester, I want to pay after approval so that work is settled.",
      "acceptanceCriteria": [
        "Transfer to agent",
        "Record ledger event",
        "Emit webhook",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented releaseEscrow() with LedgerClientV2.releaseHoldAndTransfer() and WebhookEmitter"
    },
    {
      "id": "CES-US-003",
      "title": "Dispute window",
      "description": "As a agent, I want a dispute period so that fraud is handled.",
      "acceptanceCriteria": [
        "Configurable dispute window",
        "Freeze escrow on dispute",
        "Escalate to trials",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented disputeEscrow() and escalateDispute() methods. Configurable dispute_window_hours on escrow, freezes escrow on dispute, integrates with TrialsClient for escalation."
    },
    {
      "id": "CES-US-004",
      "title": "Milestone payouts",
      "description": "As a requester, I want milestones so that long jobs can be staged.",
      "acceptanceCriteria": [
        "Define milestones",
        "Partial releases",
        "Track remaining",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Implemented releaseMilestone() and getMilestoneStatus() methods. LedgerClientV3 interface for partial releases. Tracks remaining amount and milestones, auto-releases escrow when all milestones complete."
    },
    {
      "id": "CES-US-005",
      "title": "Escrow cancellation",
      "description": "As a requester, I want to cancel so that funds return if no work.",
      "acceptanceCriteria": [
        "Cancel if no submission",
        "Release hold",
        "Audit log entry",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Implemented cancelEscrow() method with LedgerClientV4.releaseHold() for hold release and AuditLogger for audit entries. Only allows cancellation if escrow is in 'held' status with no released milestones."
    },
    {
      "id": "CES-US-006",
      "title": "Escrow status API",
      "description": "As a platform, I want status endpoints so that UI can show progress.",
      "acceptanceCriteria": [
        "GET /escrow/{id}",
        "Status states",
        "Include timestamps",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Implemented getEscrowStatus() method returning GetEscrowStatusResponse with status, timestamps, milestone summary, dispute window info, and dispute status."
    },
    {
      "id": "CES-US-007",
      "title": "Public landing + skill docs",
      "description": "As a developer, I want public landing/docs/skill endpoints so that I can discover and integrate clawescrow quickly.",
      "acceptanceCriteria": [
        "GET / returns an HTML landing page with links to /docs and /skill.md",
        "GET /docs returns minimal human-readable docs (HTML or markdown)",
        "GET /skill.md returns an OpenClaw-compatible skill file (frontmatter + markdown)",
        "OpenClaw frontmatter: metadata is a single-line JSON object string",
        "GET /robots.txt and /sitemap.xml exist (minimal)",
        "GET /.well-known/security.txt exists",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Added minimal public worker endpoints: landing page (/), docs (/docs), OpenClaw skill (/skill.md with single-line JSON metadata frontmatter), plus /robots.txt, /sitemap.xml, and /.well-known/security.txt. Also updated escrow tsconfig to include DOM lib for Request/Response types."
    },
    {
      "id": "CES-US-008",
      "title": "Escrow API v1 (D1 + ledger integration)",
      "description": "As a marketplace, I want escrow HTTP endpoints so that I can atomically hold and release funds.",
      "acceptanceCriteria": [
        "POST /v1/escrows holds buyer_total_minor via clawledger /v1/transfers (A→H)",
        "POST /v1/escrows/{escrow_id}/assign sets worker DID (idempotent)",
        "POST /v1/escrows/{escrow_id}/release pays worker + fee pool from held (H→A/F)",
        "POST /v1/escrows/{escrow_id}/dispute freezes escrow within dispute window",
        "GET /v1/escrows/{escrow_id} returns stored snapshot + ledger refs",
        "Admin auth fail-closed for all /v1 endpoints",
        "D1 persistence + idempotency",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented escrow API in services/escrow/src/worker.ts with D1 storage, admin auth, and clawledger /v1/transfers integration."
    },
    {
      "id": "CES-US-009",
      "title": "Risk-hold enforcement for release/resolution",
      "description": "As risk ops, I want escrow payouts blocked when a linked risk hold is active so disputed/loss events fail closed before worker-award release paths.",
      "acceptanceCriteria": [
        "Add risk hold fields to escrows persistence schema",
        "Implement service-key endpoint POST /v1/escrows/:id/risk-hold for apply/release toggles",
        "Block POST /v1/escrows/:id/release when risk_hold_status=active",
        "Block trials worker_award resolution when risk_hold_status=active",
        "Expose risk_hold status/details in GET escrow/list responses"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Shipped to staging+prod with migration 0004 risk-hold controls, service-key /v1/escrows/:id/risk-hold, and fail-closed release/resolution gating when risk_hold_status=active. Cross-service evidence: ECON risk-loop smokes + zero-failure watch summaries under artifacts/ops/econ-risk/2026-02-12T05-01-24-573Z-staging-loss-event-watch/summary.json and .../2026-02-12T05-01-27-688Z-prod-loss-event-watch/summary.json."
    }
  ]
}
