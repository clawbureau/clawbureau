{
  "slug": "tools/microsoft-graph",
  "title": "Microsoft Graph for Permissioned Agents | Claw EA",
  "category": "tools",
  "html": "<p>Microsoft Graph lets an agent read and write across Microsoft 365 and Entra ID, which makes it powerful and risky. For enterprise agents, prompt-only guardrails are not enough because a single mis-scoped OAuth grant can turn a bad prompt into real mailbox, file, or directory changes.</p>\n<p>Claw EA runs OpenClaw as the baseline agent runtime and uses permissioned execution: a WPC (Work Policy Contract) to define what Graph actions are allowed, CST (scoped token) to bind a job to that policy, and gateway receipts plus proof bundles to audit model-assisted decisions. Microsoft Graph connectivity is implementable via official API with enterprise buildout controls, not a native connector.</p>\n\n<h2>Step-by-step runbook</h2>\n<p><strong>1) Pick an agent identity strategy in Entra ID.</strong> Decide whether the agent uses delegated permissions (acts as a signed-in user) or application permissions (no user). For most unattended agents, application permissions are operationally simpler but raise the blast radius, so start with the minimum application scopes.</p>\n<p><strong>2) Define least-privilege Graph permissions and admin consent boundaries.</strong> Create an app registration and request only the Graph permissions you can justify, avoiding broad scopes like full mailbox or full site control unless there is a gated workflow. Use PIM for the humans who can grant admin consent, and treat consent as a change-controlled event.</p>\n<p><strong>3) Write a WPC that encodes what the agent is allowed to do.</strong> The WPC should constrain Graph endpoints, allowed verbs, target tenants, and any high-risk write operations that require a human approval gate. Store the signed, hash-addressed WPC in the WPC registry served by clawcontrols.</p>\n<p><strong>4) Bind execution to the WPC with CST.</strong> Issue a CST (scoped token) from clawscope for the specific job, with optional policy hash pinning to the WPC hash. Use the marketplace anti-replay binding so the CST is job-scoped and cannot be replayed across runs.</p>\n<p><strong>5) Run the agent in OpenClaw with tool policy and sandboxing enabled.</strong> Use OpenClaw tool allowlists to ensure the agent can only invoke the Graph tool surface you intend, and prefer sandboxed tool execution to reduce local filesystem and process exposure. Run OpenClaw’s security audit as part of deployment checks when configs change.</p>\n<p><strong>6) Route model calls through clawproxy and keep the Graph side auditable.</strong> Model calls can be routed through clawproxy to produce gateway receipts, and the run can emit a proof bundle that ties together job identifiers, WPC hash, CST scope hash, and the model call receipts. For Graph API calls (via official API), log request metadata and correlate it to the job id for post-incident reconstruction.</p>\n\n<h2>Threat model</h2>\n<p>Microsoft Graph is a protected API gateway into Microsoft 365 and Entra ID. The failure mode for agents is usually not “Graph was hacked”, it is “the agent got permissions and exercised them after prompt injection, plugin abuse, or misconfiguration”.</p>\n<table>\n  <thead>\n    <tr>\n      <th>Threat</th>\n      <th>What happens</th>\n      <th>Control</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Over-scoped Graph permissions</td>\n      <td>An agent intended to read calendar events can also read mail, enumerate users, or access SharePoint content, depending on granted scopes.</td>\n      <td>Least-privilege Graph permissions, documented consent process, and a WPC that denies out-of-scope endpoints even if OAuth scopes allow them.</td>\n    </tr>\n    <tr>\n      <td>Prompt injection causes unauthorized writes</td>\n      <td>The model is tricked into sending emails, creating inbox rules, modifying Teams messages, or changing calendar entries in ways that look legitimate.</td>\n      <td>WPC approval gates for write and admin actions, plus OpenClaw tool allowlists so “write” tools are not available during read-only tasks.</td>\n    </tr>\n    <tr>\n      <td>Credential replay or token leakage</td>\n      <td>A leaked token is replayed later to call Graph outside of the intended job window, possibly from a different environment.</td>\n      <td>Issue CST per job with anti-replay binding, keep Entra secrets out of prompts, and design for short-lived tokens where feasible.</td>\n    </tr>\n    <tr>\n      <td>Malicious or compromised plugin/tool wrapper</td>\n      <td>A tool wrapper silently expands queries, calls extra endpoints, or exfiltrates response bodies to other destinations.</td>\n      <td>Permissioned execution with WPC constraints on allowed endpoints and verbs, plus OpenClaw sandboxing to reduce local exfil paths.</td>\n    </tr>\n    <tr>\n      <td>“Human admin” escalation path</td>\n      <td>An operator grants broad consent during an incident and forgets to roll it back, leaving durable power behind.</td>\n      <td>Use PIM for admin roles and enforce an explicit rollback checklist, with the WPC updated to block high-risk operations until reviewed.</td>\n    </tr>\n  </tbody>\n</table>\n\n<h2>Policy-as-code example</h2>\n<p>This example shows the idea: a WPC expresses what Graph calls are permitted for a specific job class, and the run is bound to that exact policy hash. The goal is to make “what the agent can do” machine-checkable, not dependent on prompt text.</p>\n<pre>\n{\n  \"wpc_version\": \"1\",\n  \"policy_name\": \"m365-calendar-read-and-draft-email\",\n  \"allow\": [\n    { \"service\": \"microsoft_graph\", \"method\": \"GET\", \"path\": \"/v1.0/me/events\" },\n    { \"service\": \"microsoft_graph\", \"method\": \"GET\", \"path\": \"/v1.0/users/{userId}/calendar/events\" },\n    { \"service\": \"microsoft_graph\", \"method\": \"POST\", \"path\": \"/v1.0/me/messages\", \"constraints\": { \"send\": false } }\n  ],\n  \"deny\": [\n    { \"service\": \"microsoft_graph\", \"method\": \"POST\", \"path\": \"/v1.0/me/sendMail\" },\n    { \"service\": \"microsoft_graph\", \"method\": \"POST\", \"path\": \"/v1.0/users\" },\n    { \"service\": \"microsoft_graph\", \"method\": \"PATCH\", \"path\": \"/v1.0/users/{userId}\" }\n  ],\n  \"approvals\": [\n    { \"match\": { \"service\": \"microsoft_graph\", \"method\": \"POST\", \"path\": \"/v1.0/me/sendMail\" }, \"required\": true }\n  ],\n  \"token_binding\": {\n    \"cst_policy_hash_pinning\": true\n  }\n}\n</pre>\n<p>If the model tries to “just send the email”, prompt-only rules can fail quietly. With a WPC, the execution layer can fail closed because the tool call is not permitted under the signed policy.</p>\n\n<h2>What proof do you get?</h2>\n<p>For model activity, clawproxy emits gateway receipts for model calls. Those receipts can be bundled into a proof bundle that includes job identifiers, CST scope hash, and the WPC policy hash used for the run.</p>\n<p>For Microsoft Graph activity (via official API in an enterprise buildout), you typically preserve request metadata and correlate it to the job id included in the run context. The proof bundle can carry those correlations alongside the gateway receipts so an auditor can verify what the model was asked, what it answered, and what the job attempted to do next.</p>\n<p>When you want a stable place to view audit artifacts, you can store the resulting proof bundle as a Trust Pulse artifact for later review. This is useful when an incident review needs a single, shareable record tied to a specific job run.</p>\n\n<h2>Rollback posture</h2>\n<p>Rollback is where permissioned execution matters most: you need fast, concrete levers that do not depend on the model cooperating. Design rollback across three layers: Entra ID, the agent runtime (OpenClaw), and Claw Bureau policy and tokens.</p>\n<table>\n  <thead>\n    <tr>\n      <th>Action</th>\n      <th>Safe rollback</th>\n      <th>Evidence</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>OAuth permissions were too broad</td>\n      <td>Remove the unnecessary Microsoft Graph permissions, revoke admin consent as needed, and re-issue the app credentials.</td>\n      <td>Entra ID audit events plus the WPC version that justified the final scope set.</td>\n    </tr>\n    <tr>\n      <td>Agent is behaving unexpectedly mid-run</td>\n      <td>Stop the job, revoke the CST in clawscope, and re-run under a tighter WPC that removes write paths.</td>\n      <td>CST issuance and revocation records, plus the proof bundle for the run that triggered rollback.</td>\n    </tr>\n    <tr>\n      <td>Prompt injection caused risky tool attempts</td>\n      <td>Change the WPC to require approvals for the targeted operations and deny the specific endpoint paths until reviewed.</td>\n      <td>WPC hash history and proof bundle correlations showing attempted tool intent versus permitted execution.</td>\n    </tr>\n    <tr>\n      <td>Local host exposure concerns</td>\n      <td>Move tool execution into OpenClaw sandbox mode and remove any elevated host escape hatches not strictly required.</td>\n      <td>OpenClaw configuration diffs and security audit outputs for the environment.</td>\n    </tr>\n  </tbody>\n</table>\n\n<h2>FAQ</h2>\n<h3>Is this a native Claw EA connector to Microsoft Graph?</h3>\n<p>No. Microsoft Graph can be connected via official API with enterprise buildout controls, and the connection should be treated as an integration project with explicit permission scoping and audit requirements.</p>\n\n<h3>Why is prompt-only control not sufficient for Graph?</h3>\n<p>Because Microsoft Graph permissions and admin consent determine what is possible, regardless of what the prompt says. Policy-as-code (WPC) lets the execution layer block disallowed operations even when the model produces a plausible but unsafe instruction.</p>\n\n<h3>Should agents use delegated or application permissions?</h3>\n<p>Delegated permissions can reduce blast radius but require a signed-in user context and careful session handling. Application permissions support unattended automation but must be tightly scoped, with explicit gates for write and admin actions.</p>\n\n<h3>How do Conditional Access and PIM fit?</h3>\n<p>Use PIM to control who can grant consent and manage high-privilege Entra roles. Conditional Access can be applied to agent access patterns; Conditional Access for Agent ID is documented by Microsoft as a preview capability, so validate your tenant behavior before relying on it for enforcement.</p>\n\n<h3>What do gateway receipts prove in this setup?</h3>\n<p>Gateway receipts prove what model calls were made when routed through clawproxy and let you verify that the recorded outputs match what was returned. They do not automatically prove Graph API side effects, so you should log Graph request metadata and attach it to the same job context in the proof bundle.</p>\n\n<h2>Sources</h2>\n<ul>\n  <li><a href=\"https://github.com/openclaw/openclaw/blob/5d4f42016f3afdbd5218843648d3ea594541dedc/docs/gateway/security/index.md\">OpenClaw Gateway Security (audit + footguns)</a></li>\n  <li><a href=\"https://github.com/openclaw/openclaw/blob/5d4f42016f3afdbd5218843648d3ea594541dedc/docs/gateway/sandboxing.md\">OpenClaw: Sandboxing</a></li>\n  <li><a href=\"https://learn.microsoft.com/en-us/graph/auth/auth-concepts\">Authentication and authorization basics - Microsoft Graph</a></li>\n  <li><a href=\"https://learn.microsoft.com/en-us/graph/permissions-overview\">Overview of Microsoft Graph permissions</a></li>\n  <li><a href=\"https://learn.microsoft.com/en-us/entra/identity/conditional-access/agent-id?tabs=custom-security-attributes\">Conditional Access for Agent Identities in Microsoft Entra (Preview)</a></li>\n</ul>\n\n<div class=\"cta-banner\" data-cta=\"bofu-endcap\">\n  <h2>Ready to put this workflow into production?</h2>\n  <p>Get a scoped deployment plan with Work Policy Contracts, approval gates, and cryptographic proof bundles for your team.</p>\n  <a href=\"/contact\" class=\"cta-btn cta-btn-lg\" data-cta=\"bofu-talk-to-sales\">Talk to Sales</a>\n  <a href=\"/trust\" class=\"cta-btn cta-btn-outline cta-btn-lg\" style=\"margin-left:.75rem\" data-cta=\"bofu-trust-layer\">Review Trust Layer</a>\n</div>\n",
  "description": "Microsoft Graph lets an agent read and write across Microsoft 365 and Entra ID, which makes it powerful and risky. For enterprise agents, prompt-only guardrails are not enough because a single mis-scoped OAuth grant can ",
  "faqs": [
    {
      "q": "Is this a native Claw EA connector to Microsoft Graph?",
      "a": "No. Microsoft Graph can be connected via official API with enterprise buildout controls, and the connection should be treated as an integration project with explicit permission scoping and audit requirements."
    },
    {
      "q": "Why is prompt-only control not sufficient for Graph?",
      "a": "Because Microsoft Graph permissions and admin consent determine what is possible, regardless of what the prompt says. Policy-as-code (WPC) lets the execution layer block disallowed operations even when the model produces a plausible but unsafe instruction."
    },
    {
      "q": "Should agents use delegated or application permissions?",
      "a": "Delegated permissions can reduce blast radius but require a signed-in user context and careful session handling. Application permissions support unattended automation but must be tightly scoped, with explicit gates for write and admin actions."
    },
    {
      "q": "How do Conditional Access and PIM fit?",
      "a": "Use PIM to control who can grant consent and manage high-privilege Entra roles. Conditional Access can be applied to agent access patterns; Conditional Access for Agent ID is documented by Microsoft as a preview capability, so validate your tenant behavior before relying on it for enforcement."
    },
    {
      "q": "What do gateway receipts prove in this setup?",
      "a": "Gateway receipts prove what model calls were made when routed through clawproxy and let you verify that the recorded outputs match what was returned. They do not automatically prove Graph API side effects, so you should log Graph request metadata and attach it to the same job context in the proof bundle."
    }
  ],
  "sources": [
    {
      "title": "What's new in Microsoft Graph",
      "uri": "https://learn.microsoft.com/en-us/graph/whats-new-overview"
    },
    {
      "title": "Authorization and the Microsoft Graph Security API",
      "uri": "https://learn.microsoft.com/en-us/graph/security-authorization"
    },
    {
      "title": "Conditional Access for Agent Identities in Microsoft Entra - Microsoft Entra ID",
      "uri": "https://learn.microsoft.com/en-us/entra/identity/conditional-access/agent-id?tabs=custom-security-attributes"
    },
    {
      "title": "Use the Microsoft Graph security API",
      "uri": "https://learn.microsoft.com/en-us/graph/api/resources/security-api-overview?view=graph-rest-1.0"
    },
    {
      "title": "Microsoft Graph security API overview",
      "uri": "https://learn.microsoft.com/en-us/graph/security-concept-overview"
    },
    {
      "title": "Authentication and authorization basics - Microsoft Graph",
      "uri": "https://learn.microsoft.com/en-us/graph/auth/auth-concepts"
    },
    {
      "title": "Data architecture for AI agents across your organization",
      "uri": "https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ai-agents/data-architecture-plan"
    },
    {
      "title": "Overview of Microsoft Graph permissions",
      "uri": "https://learn.microsoft.com/en-us/graph/permissions-overview"
    }
  ],
  "model": "candidate-01",
  "generatedAt": "2026-02-11T16:47:18.903Z",
  "indexable": true
}