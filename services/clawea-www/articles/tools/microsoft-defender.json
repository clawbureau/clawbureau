{
  "slug": "tools/microsoft-defender",
  "title": "Microsoft Defender for Permissioned Agents | Claw EA",
  "category": "tools",
  "html": "<p>Microsoft Defender helps you discover AI agents, monitor risky behavior, and investigate incidents, but it does not make an agent safe to run by itself. For enterprise agents that can change security settings or query sensitive telemetry, you need a permissioned execution layer that enforces policy-as-code, not prompt-only instructions.</p>\n<p>Claw EA runs OpenClaw as the baseline agent runtime and adds enforceable controls using WPC = Work Policy Contract (signed, hash-addressed policy artifact; served by clawcontrols), CST = scoped token (issued by clawscope), and gateway receipts emitted by clawproxy. Microsoft Defender can be connected via official API with enterprise buildout controls, with write and admin actions gated by WPC approval and least-privilege auth scopes.</p>\n\n<h2>Step-by-step runbook</h2>\n<ol>\n  <li>\n    <p>Define the “Defender surface” the agent is allowed to touch. Split read-only use cases (incident triage, hunting queries, inventory) from write use cases (tagging, status changes, isolation actions) and treat write as a separate policy tier.</p>\n  </li>\n  <li>\n    <p>Create a WPC that states allowed tools, allowed Microsoft Graph permissions/scopes, and which Defender workloads are in scope (for example Defender for XDR versus Defender for Cloud Apps). Pin the WPC hash for the job so the agent cannot silently switch policies mid-run.</p>\n  </li>\n  <li>\n    <p>Issue a CST from clawscope for the specific job and bind it to the WPC scope hash. Keep the CST TTL short and require a fresh CST for each run that can change state.</p>\n  </li>\n  <li>\n    <p>Implement the Defender connection via official API in an enterprise buildout, using Entra ID OAuth where possible. Require explicit Graph permissions/scopes and avoid broad directory scopes unless the WPC explicitly allows them.</p>\n  </li>\n  <li>\n    <p>Route model calls through clawproxy so you get gateway receipts for every model interaction. Keep “tool execution” and “model reasoning” separated so you can later prove what the model was asked and what was executed.</p>\n  </li>\n  <li>\n    <p>Run the agent in OpenClaw with sandboxing and tight tool policy profiles. Validate the effective sandbox and tool policy with OpenClaw’s own audit and inspector commands before enabling any Defender write actions.</p>\n  </li>\n  <li>\n    <p>Emit a proof bundle for each run and store it in your evidence system or as a Trust Pulse for review. Treat Defender changes as change-managed actions and attach the proof bundle to the ticket.</p>\n  </li>\n</ol>\n\n<h2>Threat model</h2>\n<p>Defender data is high leverage: it can reveal incident timelines, device identities, user behavior, and security configuration. If an agent can query or mutate that data based on prompts alone, prompt injection and mis-scoped credentials turn into real operational impact.</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Threat</th>\n      <th>What happens</th>\n      <th>Control</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Prompt injection triggers unintended Defender actions</td>\n      <td>An attacker embeds instructions in an alert description or ticket so the agent “helpfully” runs a write action, changes a policy, or expands scope.</td>\n      <td>Permissioned execution: WPC must explicitly allow the write tool, the Graph scopes, and the target resource types. Require separate WPC approval gates for any state-changing action.</td>\n    </tr>\n    <tr>\n      <td>Over-broad Entra ID app permissions</td>\n      <td>The agent’s token can access unrelated security data, or it can modify tenant configuration beyond the intended workflow.</td>\n      <td>Least-privilege Microsoft Graph permissions/scopes, enforced by WPC. Use separate app registrations for read-only and write paths and prefer PIM for human elevation outside the agent path.</td>\n    </tr>\n    <tr>\n      <td>Credential replay across jobs or environments</td>\n      <td>A token obtained in one run is reused later, bypassing intended approvals and making incident timelines ambiguous.</td>\n      <td>Job-scoped CST binding (anti-replay) and short TTL. Pin the policy hash so the CST is only valid for the approved WPC.</td>\n    </tr>\n    <tr>\n      <td>Misconfigured OpenClaw tools or sandbox escape hatch</td>\n      <td>The agent gains host-level execution or reads local secrets, then uses Defender APIs with higher impact than planned.</td>\n      <td>OpenClaw sandboxing and strict tool allow/deny profiles. Avoid elevated tool paths except under a separate WPC tier and only for constrained operations.</td>\n    </tr>\n    <tr>\n      <td>Disputed audit trail after an incident</td>\n      <td>You cannot prove whether the model was called with a specific prompt, which policy was active, or which credentials were used when a change occurred.</td>\n      <td>Gateway receipts for model calls plus a proof bundle that binds receipts, job metadata, CST scope hash, and the WPC hash. Verification becomes a mechanical check, not a narrative.</td>\n    </tr>\n  </tbody>\n</table>\n\n<h2>Policy-as-code example</h2>\n<p>This is an example WPC that permits read-only hunting and inventory, while forcing explicit approval for write operations. Treat the snippet as a template; exact Microsoft Graph permissions/scopes depend on your tenant configuration and the Defender workload you are calling via official API.</p>\n\n<pre>{\n  \"wpc_version\": \"1\",\n  \"policy_name\": \"defender-agent-readonly\",\n  \"purpose\": \"Run incident triage and hunting queries via official API; no tenant changes\",\n  \"openclaw\": {\n    \"tools_profile\": \"readonly\",\n    \"tools_allow\": [\"http\", \"defender_api_call\", \"report_write\"],\n    \"tools_deny\": [\"shell\", \"filesystem_write\", \"elevated_exec\"],\n    \"sandbox\": { \"mode\": \"all\", \"workspaceAccess\": \"ro\" }\n  },\n  \"auth\": {\n    \"provider\": \"entra_id\",\n    \"token_type\": \"oauth\",\n    \"graph_permissions_scopes_allow\": [\n      \"SecurityEvents.Read.All\",\n      \"ThreatHunting.Read.All\"\n    ],\n    \"graph_permissions_scopes_deny\": [\n      \"Directory.ReadWrite.All\",\n      \"Policy.ReadWrite.ConditionalAccess\"\n    ]\n  },\n  \"claw_bureau\": {\n    \"cst_require\": true,\n    \"cst_scope_hash_pin\": true,\n    \"wpc_policy_hash_pin\": true\n  },\n  \"approvals\": {\n    \"write_actions\": { \"require\": true, \"reason\": \"Any change to Defender state must be approved\" }\n  },\n  \"logging\": {\n    \"gateway_receipts\": \"required\",\n    \"proof_bundle\": \"required\"\n  }\n}</pre>\n\n<p>For write paths, create a second WPC such as <span>defender-agent-write</span> that allows only specific endpoints and specific Graph scopes, and require an approval gate before issuing the CST. If you rely on Conditional Access or PIM, keep that in the human operator path and do not assume an agent can satisfy interactive requirements without enterprise buildout.</p>\n\n<h2>What proof do you get?</h2>\n<p>Every model call routed through clawproxy produces gateway receipts, which you can later verify to confirm what model was called and under what job context. Those receipts are bundled into a proof bundle along with job metadata, the CST scope hash, and the pinned WPC hash.</p>\n<p>Operationally, this gives you two checks during incident response: confirm the run was bound to the approved WPC, and confirm the model traffic matches the job that executed the Defender calls. If you publish it, the proof bundle can be stored and viewed as a Trust Pulse for audit and review workflows.</p>\n\n<h2>Rollback posture</h2>\n<p>Rollback for permissioned agents is mostly about making unsafe actions impossible to repeat, then reverting the affected configuration with a controlled playbook. Do this in layers: revoke credentials first, then disable tools and policies, then remediate Defender-side changes.</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Action</th>\n      <th>Safe rollback</th>\n      <th>Evidence</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Stop further agent runs</td>\n      <td>Revoke the CST in clawscope and rotate the underlying Entra ID secret or certificate for the app registration used by the agent.</td>\n      <td>Proof bundle shows the CST scope hash and issuance context for the run you are investigating.</td>\n    </tr>\n    <tr>\n      <td>Prevent policy drift</td>\n      <td>Freeze to a known-good WPC hash and require policy hash pinning for all jobs. Remove any WPC that allows write scopes until reviewed.</td>\n      <td>WPC hash is recorded in the run metadata and can be compared across runs.</td>\n    </tr>\n    <tr>\n      <td>Contain tool blast radius</td>\n      <td>Tighten OpenClaw tool policy and sandbox mode to remove elevated and filesystem-write tools from the agent profile used for security workflows.</td>\n      <td>OpenClaw audit output plus job configuration snapshots associated with the proof bundle.</td>\n    </tr>\n    <tr>\n      <td>Undo Defender-side changes</td>\n      <td>Revert the specific Defender or Graph changes using a human-run procedure with PIM elevation, then re-run the agent in read-only mode to verify state.</td>\n      <td>Defender audit logs and the agent’s proof bundle together show what was attempted and when.</td>\n    </tr>\n  </tbody>\n</table>\n\n<h2>FAQ</h2>\n\n<h3>Is this a native Microsoft Defender connector in Claw EA?</h3>\n<p>No. Microsoft Defender can be connected via official API with enterprise buildout controls, and you should plan for a scoped integration that matches your tenant’s Entra ID and Graph permission model.</p>\n\n<h3>Why is prompt-only control not enough for Defender-capable agents?</h3>\n<p>Because prompts are not enforceable when the agent sees untrusted text, such as alert descriptions, emails, or tickets. Policy-as-code in a WPC gives you a machine-checked allowlist of tools and scopes, so “the agent promised not to” is not your control.</p>\n\n<h3>How do you keep Graph permissions from quietly expanding over time?</h3>\n<p>Put allowed Microsoft Graph permissions/scopes inside the WPC and require policy hash pinning for the job. Any change to scopes becomes a WPC change, which you can review and sign before issuing a CST.</p>\n\n<h3>What do gateway receipts cover versus Defender audit logs?</h3>\n<p>Defender audit logs show actions inside Microsoft services. Gateway receipts show the model calls used to decide actions, and the proof bundle binds those receipts to the exact WPC and CST that authorized the run.</p>\n\n<h3>Can we enforce network egress allowlists for Defender integrations?</h3>\n<p>It can be implemented as an additional control outside clawproxy, but it is not a shipped default. Most teams start with strict tool policy plus WPC scope pinning, then add egress controls where required.</p>\n\n<h2>Sources</h2>\n<ul>\n  <li><a href=\"https://learn.microsoft.com/en-us/defender-xdr/ai-agent-inventory\">Protect your AI agents (Preview)</a></li>\n  <li><a href=\"https://learn.microsoft.com/en-us/defender-cloud-apps/ai-agent-protection\">Protect your Microsoft Copilot Studio AI agents (Preview) - Microsoft Defender for Cloud Apps</a></li>\n  <li><a href=\"https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ai-agents/governance-security-across-organization\">Governance and security for AI agents across the organization</a></li>\n  <li><a href=\"https://github.com/openclaw/openclaw/blob/5d4f42016f3afdbd5218843648d3ea594541dedc/docs/gateway/security/index.md\">OpenClaw Gateway Security (audit + footguns)</a></li>\n  <li><a href=\"https://github.com/openclaw/openclaw/blob/5d4f42016f3afdbd5218843648d3ea594541dedc/docs/gateway/sandbox-vs-tool-policy-vs-elevated.md\">OpenClaw: Sandbox vs Tool Policy vs Elevated</a></li>\n</ul>\n\n<div class=\"cta-banner\" data-cta=\"bofu-endcap\">\n  <h2>Ready to put this workflow into production?</h2>\n  <p>Get a scoped deployment plan with Work Policy Contracts, approval gates, and cryptographic proof bundles for your team.</p>\n  <a href=\"/contact\" class=\"cta-btn cta-btn-lg\" data-cta=\"bofu-talk-to-sales\">Talk to Sales</a>\n  <a href=\"/trust\" class=\"cta-btn cta-btn-outline cta-btn-lg\" style=\"margin-left:.75rem\" data-cta=\"bofu-trust-layer\">Review Trust Layer</a>\n</div>\n",
  "description": "Microsoft Defender helps you discover AI agents, monitor risky behavior, and investigate incidents, but it does not make an agent safe to run by itself. For enterprise agents that can change security settings or query se",
  "faqs": [
    {
      "q": "Is this a native Microsoft Defender connector in Claw EA?",
      "a": "No. Microsoft Defender can be connected via official API with enterprise buildout controls, and you should plan for a scoped integration that matches your tenant’s Entra ID and Graph permission model."
    },
    {
      "q": "Why is prompt-only control not enough for Defender-capable agents?",
      "a": "Because prompts are not enforceable when the agent sees untrusted text, such as alert descriptions, emails, or tickets. Policy-as-code in a WPC gives you a machine-checked allowlist of tools and scopes, so “the agent promised not to” is not your control."
    },
    {
      "q": "How do you keep Graph permissions from quietly expanding over time?",
      "a": "Put allowed Microsoft Graph permissions/scopes inside the WPC and require policy hash pinning for the job. Any change to scopes becomes a WPC change, which you can review and sign before issuing a CST."
    },
    {
      "q": "What do gateway receipts cover versus Defender audit logs?",
      "a": "Defender audit logs show actions inside Microsoft services. Gateway receipts show the model calls used to decide actions, and the proof bundle binds those receipts to the exact WPC and CST that authorized the run."
    },
    {
      "q": "Can we enforce network egress allowlists for Defender integrations?",
      "a": "It can be implemented as an additional control outside clawproxy, but it is not a shipped default. Most teams start with strict tool policy plus WPC scope pinning, then add egress controls where required."
    }
  ],
  "sources": [
    {
      "title": "Protect your AI agents (Preview)",
      "uri": "https://learn.microsoft.com/en-us/defender-xdr/ai-agent-inventory"
    },
    {
      "title": "Governance and security for AI agents across the organization",
      "uri": "https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ai-agents/governance-security-across-organization"
    },
    {
      "title": "What's new - Microsoft Defender for Cloud Apps",
      "uri": "https://learn.microsoft.com/en-us/defender-cloud-apps/release-notes"
    },
    {
      "title": "Protect your Microsoft Copilot Studio AI agents (Preview) - Microsoft Defender for Cloud Apps",
      "uri": "https://learn.microsoft.com/en-us/defender-cloud-apps/ai-agent-protection"
    },
    {
      "title": "Discover and protect your AI Agents (Preview)",
      "uri": "https://learn.microsoft.com/en-us/defender-cloud-apps/ai-agent-inventory"
    },
    {
      "title": "Microsoft Defender for Cloud Overview",
      "uri": "https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-cloud-introduction"
    }
  ],
  "model": "candidate-01",
  "generatedAt": "2026-02-11T12:30:22.380Z",
  "indexable": true
}