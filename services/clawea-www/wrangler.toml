# clawea-www -- Enterprise marketing + SEO site for clawea.com
#
# This worker serves the public-facing marketing pages, programmatic SEO
# content, sitemap, and robots.txt. The platform API worker handles /v1/*
# routes on the same domain.
#
# Route precedence: this worker catches /* EXCEPT /v1/*, /health, /staging/*
# which the platform API worker handles via its own route bindings.

name = "clawea-www"
account_id = "b8f2c66f1848dff476faa874282d781e"
main = "src/index.ts"
compatibility_date = "2026-02-01"
workers_dev = true

routes = [
  { pattern = "clawea.com/*", zone_name = "clawea.com" },
  { pattern = "www.clawea.com/*", zone_name = "clawea.com" }
]

[[migrations]]
tag = "v1-lead-submit-lock-do"
new_classes = ["LeadSubmitLockDO"]

[vars]
ENVIRONMENT = "production"
SITE_URL = "https://www.clawea.com"
INDEXNOW_KEY = "edf20368863e485aa92e1b95fa15872a"
INDEXNOW_MAX_ATTEMPTS = "4"
INDEXNOW_RETRY_BASE_MS = "900"
INDEXNOW_RETRY_MAX_MS = "30000"
GOOGLE_INDEX_MAX_ATTEMPTS = "4"
GOOGLE_INDEX_RETRY_BASE_MS = "1200"
GOOGLE_INDEX_RETRY_MAX_MS = "45000"
INDEX_QUEUE_ENABLED = "1"
INDEX_QUEUE_MAX_ENTRIES_PER_RUN = "40"
INDEX_QUEUE_INDEXNOW_MAX_ATTEMPTS = "8"
INDEX_QUEUE_GOOGLE_MAX_ATTEMPTS = "6"
INDEX_QUEUE_RETRY_BASE_MS = "60000"
INDEX_QUEUE_RETRY_MAX_MS = "3600000"
TURNSTILE_REQUIRED = "1"
LEAD_SUBMIT_IP_WINDOW_LIMIT = "24"
LEAD_SUBMIT_EMAIL_WINDOW_LIMIT = "8"
LEAD_SUBMIT_WINDOW_MINUTES = "10"
ROUTING_MAX_ATTEMPTS = "5"
CRM_PROVIDER_CONFIG_KEY = "crm-provider-config-v1"
LEAD_RESPONSE_SLA_MINUTES = "45"
ROUTING_QUEUE_LAG_ALERT_MINUTES = "20"
EXPERIMENT_SEED = "aeo-rev-007-default"
EXPERIMENT_CONFIG_KEY = "experiment-config-v1"
EXPERIMENT_WINNER_MIN_IMPRESSIONS = "40"
EXPERIMENT_WINNER_MIN_BOOKED = "2"
EXPERIMENT_WINNER_MIN_CONFIDENCE = "0.12"
EXPERIMENT_HOLDOUT_PERCENT = "5"

# Secrets (set with `wrangler secret put <NAME>`):
# - INDEX_AUTOMATION_TOKEN
# - LEADS_API_TOKEN
# - GOOGLE_INDEXING_SERVICE_ACCOUNT_JSON
# - TURNSTILE_SECRET_KEY
# - TURNSTILE_SITE_KEY
# - LEAD_ID_HASH_SALT
# - CRM_HANDOFF_SIGNING_SECRET
# - CRM_PROVIDER_AUTH_JSON

[[durable_objects.bindings]]
name = "LEAD_SUBMIT_LOCK"
class_name = "LeadSubmitLockDO"

[[d1_databases]]
binding = "DB"
database_name = "clawea-www"
database_id = "f4e6a39b-1894-4554-b682-e0c719719aa4"
preview_database_id = "82781bed-d57c-4fe7-8269-74f54c12f69d"
migrations_dir = "migrations"

[[kv_namespaces]]
binding = "VARIANT_CONFIG"
id = "c026646d19914778b9c438f007485383"
preview_id = "36e71f3724914ab09ffda6425edf6bc8"

[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "clawea_www"

[[queues.producers]]
binding = "LEAD_JOBS"
queue = "clawea-www-lead-jobs"

[[queues.producers]]
binding = "LEAD_ROUTE_ENTERPRISE"
queue = "clawea-www-route-enterprise"

[[queues.producers]]
binding = "LEAD_ROUTE_SMB"
queue = "clawea-www-route-smb"

[[queues.producers]]
binding = "LEAD_ROUTE_PARTNER"
queue = "clawea-www-route-partner"

[[queues.consumers]]
queue = "clawea-www-lead-jobs"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[[queues.consumers]]
queue = "clawea-www-route-enterprise"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[[queues.consumers]]
queue = "clawea-www-route-smb"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[[queues.consumers]]
queue = "clawea-www-route-partner"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[placement]
mode = "smart"

[triggers]
crons = ["*/20 * * * *"]

# ---------- R2 (article storage) ----------
[[r2_buckets]]
binding = "ARTICLES"
bucket_name = "clawea-www"
preview_bucket_name = "clawea-www-staging"

# ---------- Staging ----------
[env.staging]
name = "clawea-www-staging"
workers_dev = true
routes = [
  { pattern = "staging-www.clawea.com/*", zone_name = "clawea.com" }
]

[env.staging.triggers]
crons = ["*/20 * * * *"]

[env.staging.vars]
ENVIRONMENT = "staging"
SITE_URL = "https://staging-www.clawea.com"
INDEXNOW_KEY = "edf20368863e485aa92e1b95fa15872a"
INDEXNOW_MAX_ATTEMPTS = "4"
INDEXNOW_RETRY_BASE_MS = "900"
INDEXNOW_RETRY_MAX_MS = "30000"
GOOGLE_INDEX_MAX_ATTEMPTS = "4"
GOOGLE_INDEX_RETRY_BASE_MS = "1200"
GOOGLE_INDEX_RETRY_MAX_MS = "45000"
INDEX_QUEUE_ENABLED = "1"
INDEX_QUEUE_MAX_ENTRIES_PER_RUN = "20"
INDEX_QUEUE_INDEXNOW_MAX_ATTEMPTS = "6"
INDEX_QUEUE_GOOGLE_MAX_ATTEMPTS = "6"
INDEX_QUEUE_RETRY_BASE_MS = "30000"
INDEX_QUEUE_RETRY_MAX_MS = "1800000"
TURNSTILE_REQUIRED = "1"
LEAD_SUBMIT_IP_WINDOW_LIMIT = "30"
LEAD_SUBMIT_EMAIL_WINDOW_LIMIT = "10"
LEAD_SUBMIT_WINDOW_MINUTES = "10"
ROUTING_MAX_ATTEMPTS = "5"
CRM_PROVIDER_CONFIG_KEY = "crm-provider-config-v1"
LEAD_RESPONSE_SLA_MINUTES = "30"
ROUTING_QUEUE_LAG_ALERT_MINUTES = "15"
EXPERIMENT_SEED = "aeo-rev-007-staging"
EXPERIMENT_CONFIG_KEY = "experiment-config-v1"
EXPERIMENT_WINNER_MIN_IMPRESSIONS = "20"
EXPERIMENT_WINNER_MIN_BOOKED = "1"
EXPERIMENT_WINNER_MIN_CONFIDENCE = "0.08"
EXPERIMENT_HOLDOUT_PERCENT = "8"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "clawea-www-staging"
database_id = "82781bed-d57c-4fe7-8269-74f54c12f69d"
preview_database_id = "82781bed-d57c-4fe7-8269-74f54c12f69d"
migrations_dir = "migrations"

[[env.staging.kv_namespaces]]
binding = "VARIANT_CONFIG"
id = "1051001c69364031be8fc0f79324fefc"
preview_id = "fff86d64d9b442e180daecbb2e09fdcc"

[[env.staging.durable_objects.bindings]]
name = "LEAD_SUBMIT_LOCK"
class_name = "LeadSubmitLockDO"

[[env.staging.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "clawea_www_staging"

[[env.staging.queues.producers]]
binding = "LEAD_JOBS"
queue = "clawea-www-lead-jobs-staging"

[[env.staging.queues.producers]]
binding = "LEAD_ROUTE_ENTERPRISE"
queue = "clawea-www-route-enterprise-staging"

[[env.staging.queues.producers]]
binding = "LEAD_ROUTE_SMB"
queue = "clawea-www-route-smb-staging"

[[env.staging.queues.producers]]
binding = "LEAD_ROUTE_PARTNER"
queue = "clawea-www-route-partner-staging"

[[env.staging.queues.consumers]]
queue = "clawea-www-lead-jobs-staging"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[[env.staging.queues.consumers]]
queue = "clawea-www-route-enterprise-staging"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[[env.staging.queues.consumers]]
queue = "clawea-www-route-smb-staging"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[[env.staging.queues.consumers]]
queue = "clawea-www-route-partner-staging"
max_batch_size = 25
max_batch_timeout = 10
max_retries = 8

[[env.staging.r2_buckets]]
binding = "ARTICLES"
bucket_name = "clawea-www-staging"
preview_bucket_name = "clawea-www-staging"
