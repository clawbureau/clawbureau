## Codebase Patterns
- Use Zod for runtime validation of all schemas
- TypeScript types are derived from Zod schemas using `z.infer<>`
- Service clients implement interfaces for testability (EscrowService, FeeService, EligibilityService)
- JSON schemas in packages/schema/ follow the naming pattern: `{entity}.v{version}.json`
- Actions take a deps object for dependency injection (repository, services)
- Use `crypto.randomUUID()` for ID generation (works in modern runtimes)
- tsconfig needs `lib: ["ES2022", "DOM"]` for fetch/AbortController support
- BountyRepository interface is shared across actions via types/repository.ts (avoid duplicate interfaces)
- Stake rules are tier-based: higher trust = lower stake; use STAKE_RULES constant for percentages
- Proof tiers: submissions classify as self/gateway/sandbox based on presence of proof_evidence.receipts/attestations; store proof_tier on Submission

# Ralph Progress Log
Started: 2026-02-02T03:08:26.937005
---

## 2026-02-02 - CBT-US-001
- **What was implemented:** Post bounty action with escrow hold integration
- **Files changed:**
  - packages/schema/bounties/bounty.v1.json - Main bounty schema
  - packages/schema/bounties/post_bounty_request.v1.json - API request schema
  - packages/schema/bounties/post_bounty_response.v1.json - API response schema
  - packages/schema/bounties/escrow_hold_request.v1.json - Escrow integration schema
  - packages/bounties/src/types/*.ts - TypeScript types with Zod validation
  - packages/bounties/src/actions/postBounty.ts - Main action implementation
  - packages/bounties/src/services/*.ts - Escrow and fee service clients
- **Learnings for future iterations:**
  - The codebase follows a schema-first approach: define JSON schema, then derive TS types
  - Escrow integration requires idempotency keys with `escrow:` prefix
  - Fee calculation happens before escrow hold to show all-in cost
  - BountyRepository interface allows persistence layer to be swapped
  - Closure type "test" requires test_harness_id (validated via Zod refinement)
---

## 2026-02-02 - CBT-US-002
- **What was implemented:** Accept bounty action with eligibility checking
- **Files changed:**
  - packages/bounties/src/types/bounty.ts - Added AcceptBountyRequest/Response, AcceptanceReceipt schemas
  - packages/bounties/src/types/eligibility.ts - EligibilityCheckRequest/Response schemas for clawtrust
  - packages/bounties/src/types/repository.ts - Shared BountyRepository interface
  - packages/bounties/src/actions/acceptBounty.ts - Main action implementation
  - packages/bounties/src/services/eligibilityClient.ts - HTTP client for clawtrust
  - packages/bounties/src/actions/postBounty.ts - Refactored to use shared repository
- **Learnings for future iterations:**
  - BountyRepository interface was duplicated in postBounty.ts; moved to shared types/repository.ts
  - EligibilityService checks PoH tier via clawtrust with simple is_eligible boolean
  - AcceptanceReceipt captures bounty snapshot (title, reward, difficulty_scalar, closure_type) at acceptance time
  - Bounty status transitions: open -> accepted (with accepted_at, accepted_by fields)
  - min_poh_tier defaults to 0 (no requirement) if not set on bounty
---

## 2026-02-02 - CBT-US-003
- **What was implemented:** Submit work action with signature envelope and proof bundle
- **Files changed:**
  - packages/bounties/src/types/bounty.ts - Added SignatureEnvelope, ProofBundle, Submission, SubmitWorkRequest/Response schemas
  - packages/bounties/src/types/repository.ts - Added findSubmissionByIdempotencyKey and saveSubmission methods
  - packages/bounties/src/actions/submitWork.ts - Main action implementation
  - packages/bounties/src/actions/index.ts - Export new action
- **Learnings for future iterations:**
  - SignatureEnvelope requires signer_did matching the agent context for verification
  - ProofBundle uses sha256 hash algorithm (required literal, not flexible)
  - Bounty status transitions: accepted -> pending_review (on submission)
  - Only the agent who accepted the bounty (bounty.accepted_by) can submit work
  - Submission records store both the output and cryptographic proof references
---

## 2026-02-02 - CBT-US-004
- **What was implemented:** Test-based auto-approval action for bounties with test closure type
- **Files changed:**
  - packages/bounties/src/types/testHarness.ts - TestHarnessService interface, RunTestHarnessRequest/Response schemas
  - packages/bounties/src/services/testHarnessClient.ts - HTTP client for test harness service
  - packages/bounties/src/types/bounty.ts - Added TestResult, AutoApproveRequest/Response schemas
  - packages/bounties/src/types/repository.ts - Added findSubmissionById and saveTestResult methods
  - packages/bounties/src/actions/autoApprove.ts - Main action implementation
  - packages/bounties/src/types/index.ts - Export testHarness types
  - packages/bounties/src/services/index.ts - Export testHarnessClient
  - packages/bounties/src/actions/index.ts - Export autoApprove action
- **Learnings for future iterations:**
  - TestHarnessService follows same HTTP client pattern as other services (EscrowClient, FeeClient)
  - autoApprove requires bounty closure_type="test" and test_harness_id to be set
  - Bounty status transitions: pending_review -> approved (if tests pass) or rejected (if tests fail)
  - TestResult stores test execution summary (total/passed/failed tests, execution time)
  - Repository needs findSubmissionById to look up submissions for approval
---

## 2026-02-02 - CBT-US-005
- **What was implemented:** Quorum review system for bounties with quorum-based closure type
- **Files changed:**
  - packages/bounties/src/types/quorum.ts - ReviewerVote, QuorumState, InitiateQuorum/CastVote/FinalizeQuorum request/response schemas
  - packages/bounties/src/types/repository.ts - Added quorum persistence methods (saveQuorumState, findQuorumStateById, etc.)
  - packages/bounties/src/services/reviewerClient.ts - HTTP client for clawrep reviewer service
  - packages/bounties/src/actions/quorumReview.ts - Main actions: initiateQuorum, castVote, finalizeQuorum
  - packages/bounties/src/types/index.ts - Export quorum types
  - packages/bounties/src/services/index.ts - Export reviewerClient
  - packages/bounties/src/actions/index.ts - Export quorumReview actions
- **Learnings for future iterations:**
  - ReviewerService selects reviewers by reputation, excluding requester and worker DIDs
  - QuorumState tracks selected reviewers, collected votes, and quorum progress
  - Majority threshold for quorum: Math.ceil(required_votes / 2)
  - Bounty status transitions: pending_review -> approved/rejected (on quorum reached)
  - Votes are signed with DID signature envelopes (same pattern as submissions)
  - Owner-verified voting is optional (bounty.require_owner_verified_votes)
  - Each reviewer can only vote once (checked via findVoteByReviewerAndSubmission)
---

## 2026-02-02 - CBT-US-006
- **What was implemented:** Bounty search action with filtering, sorting, and pagination
- **Files changed:**
  - packages/bounties/src/types/bounty.ts - Added BountySortField, SortDirection, SearchBountiesRequest/Response, TrustRequirements, BountyListing schemas
  - packages/bounties/src/types/repository.ts - Added BountySearchFilters, BountySearchOptions, BountySearchResult interfaces and search() method
  - packages/bounties/src/actions/searchBounties.ts - Main action implementation
  - packages/bounties/src/actions/index.ts - Export searchBounties action
- **Learnings for future iterations:**
  - Search types (filters, sort, pagination) added to bounty.ts; repository-specific interfaces in repository.ts
  - BountyListing includes TrustRequirements (min_poh_tier, require_owner_verified_votes) for agent decision-making
  - Repository.search() takes BountySearchOptions with filters, sorting, and pagination params
  - Default sort by created_at desc, page_size 20, max page_size 100
  - Filter by tags checks if bounty has at least one matching tag (implemented by repository)
---

## 2026-02-02 - CBT-US-007
- **What was implemented:** Dispute handling system for rejected bounties
- **Files changed:**
  - packages/bounties/src/types/dispute.ts - Dispute, OpenDisputeRequest/Response, RouteToTrialsRequest/Response, FreezePayoutRequest/Response, TrialsService interface
  - packages/bounties/src/types/escrow.ts - Added EscrowFreezeRequest/Response schemas and freezeHold method to EscrowService
  - packages/bounties/src/types/repository.ts - Added dispute persistence methods (saveDispute, findDisputeById, findDisputeBySubmissionId, etc.)
  - packages/bounties/src/services/trialsClient.ts - HTTP client for clawtrial service
  - packages/bounties/src/services/escrowClient.ts - Added freezeHold implementation
  - packages/bounties/src/actions/dispute.ts - Main actions: openDispute, routeToTrials, freezePayout
  - packages/bounties/src/types/index.ts - Export dispute types
  - packages/bounties/src/services/index.ts - Export trialsClient
  - packages/bounties/src/actions/index.ts - Export dispute actions
- **Learnings for future iterations:**
  - Disputes can only be opened on bounties with status "rejected"
  - Only the agent who submitted the work can open a dispute
  - openDispute automatically freezes escrow payout via escrowService.freezeHold()
  - Bounty status transitions: rejected -> disputed (on dispute open)
  - TrialsService follows same HTTP client pattern as other services
  - DisputeReason enum provides structured reasons: unfair_rejection, incorrect_test_results, quorum_manipulation, scope_disagreement, other
  - Dispute record stores signature envelope for non-repudiation
---

## 2026-02-02 - CBT-US-008
- **What was implemented:** Stake requirements system for bad-faith behavior deterrence
- **Files changed:**
  - packages/bounties/src/types/stake.ts - StakeRequirement, StakeHold, StakeService interface, calculateStakeAmount function, STAKE_RULES config
  - packages/bounties/src/services/stakeClient.ts - HTTP client for ledger bonded bucket operations (lockStake, releaseStake, slashStake)
  - packages/bounties/src/actions/stake.ts - Main actions: calculateStake, lockBountyStakes, releaseBountyStakes, resolveStakesForTrial
  - packages/bounties/src/types/repository.ts - Added stake persistence methods (saveStake, findStakeById, findStakesByBountyId, findStakeByIdempotencyKey)
  - packages/bounties/src/types/index.ts - Export stake types
  - packages/bounties/src/services/index.ts - Export stakeClient
  - packages/bounties/src/actions/index.ts - Export stake actions
- **Learnings for future iterations:**
  - Stake percentages scale with trust tier (higher tier = lower stake requirement)
  - Worker stakes: Tier 0 = 25%, Tier 5 = 0%; Requester stakes: Tier 0 = 15%, Tier 5 = 0%
  - StakeService interacts with ledger bonded bucket for lock/release/slash operations
  - Trial outcomes determine stake disposition: approve = slash requester/release worker, reject = slash worker/release requester, split = 50% slash for both
  - StakeHold tracks ledger_tx_id for audit trail
  - StakeClient can optionally use EligibilityService for trust tier lookups
  - Minimum stake amounts enforced (10 CLAW, 5 USD) to prevent trivially low stakes
  - Maximum stake cap at 50% of bounty to prevent excessive stake requirements
---

## 2026-02-02 - CBT-US-009
- **What was implemented:** Proof tier classification for fair reputation weighting
- **Files changed:**
  - packages/bounties/src/types/bounty.ts - Added ProofTier/ProofEvidence schemas; stored proof_tier + proof_evidence on Submission; returned proof_tier on SubmitWorkResponse
  - packages/bounties/src/actions/submitWork.ts - Classified proof tier from receipts/attestations references and persisted it with the submission
  - packages/bounties/src/types/quorum.ts - Extended reviewer selection request to include submission_proof_tier
  - packages/bounties/src/actions/quorumReview.ts - Passed submission_proof_tier to clawrep reviewer selection
  - prd.json
  - progress.txt
- **Learnings for future iterations:**
  - Keep proof tier classification deterministic and local (based on presence of evidence references), and leave cryptographic verification to specialized services
  - When integrating with external services (clawrep), prefer explicit fields (submission_proof_tier) rather than overloading metadata blobs
---

## 2026-02-02T05:23:09Z - CBT-US-010
- What was implemented
  - Fee disclosure now surfaces end-to-end:
    - Posting already returns all_in_cost (principal + platform_fee + total) and fee_policy_version from clawcuts.
    - Acceptance receipts now include:
      - worker_net (agent payout; currently equals reward principal)
      - fee_policy_version (from clawcuts at posting)
      - all_in_cost (requester total cost)
  - Tightened schema invariants so fee_policy_version + all_in_cost are required on stored Bounty records.
- Files changed
  - packages/bounties/src/types/bounty.ts
  - packages/bounties/src/actions/acceptBounty.ts
  - packages/bounties/src/actions/postBounty.ts
  - prd.json
  - progress.txt
- **Learnings for future iterations:**
  - Cost transparency is easiest when fee fields are required at persistence boundaries (not optional), and then echoed into downstream receipts.
---

## 2026-02-02T05:37:35Z - CBT-US-011
- What was implemented
  - Difficulty scalar (K) is now included wherever it needs to be visible/usable:
    - Post bounty response (posting receipt) now returns `difficulty_scalar`
    - Quorum reviewer selection request forwarded to clawrep now includes `difficulty_scalar` for weighting/transparent scoring
  - Immutability:
    - K remains part of the persisted bounty record and is not modified by later lifecycle actions (accept/submit/review)
- Files changed
  - packages/bounties/src/types/bounty.ts
  - packages/bounties/src/actions/postBounty.ts
  - packages/bounties/src/types/quorum.ts
  - packages/bounties/src/actions/quorumReview.ts
  - prd.json
  - progress.txt
- Quality checks
  - cd packages/bounties && npm run typecheck
---

## 2026-02-02T05:49:47Z - CBT-US-012
- What was implemented
  - Code bounties (bounty.is_code_bounty=true) now require a commit proof at submission:
    - Added SubmitWorkRequest.commit_sig (did-work commit.sig.json envelope)
    - Enforced in submitWork(): missing commit_sig => COMMIT_PROOF_REQUIRED
  - Verification
    - Verified commit_sig using Ed25519 signature verification (did:key → public key)
    - Enforced message format: commit:<sha>
  - Linking
    - Stored commit_sig and extracted commit_sha on Submission alongside proof_bundle
    - This ties the commit proof to the proof bundle used for the submission
- Files changed
  - packages/bounties/src/types/bounty.ts
  - packages/bounties/src/services/commitProof.ts
  - packages/bounties/src/services/index.ts
  - packages/bounties/src/actions/submitWork.ts
  - prd.json
  - progress.txt
- Quality checks
  - cd packages/bounties && npm run typecheck
---

## 2026-02-02T05:52:55Z - CBT-US-013
- What was implemented
  - PoH tier gating (trust requirements) is now marked complete:
    - Requesters can set `min_poh_tier` on PostBountyRequest (default 0)
    - Acceptance enforces PoH tier via clawtrust eligibilityService (`required_poh_tier`)
    - Search listings expose `trust_requirements.min_poh_tier`
- Files changed
  - prd.json
  - progress.txt
- Quality checks
  - cd packages/bounties && npm run typecheck
---

## 2026-02-02T05:57:33Z - CBT-US-014
- What was implemented
  - Owner-verified voting for quorum review:
    - Quorum initiation prefers owner-verified reviewers when `require_owner_verified_votes=true`, but can fall back to non-verified reviewers if there aren’t enough verified reviewers.
    - Vote casting records reviewer owner verification + owner_attestation_ref from the selected reviewer info.
    - If owner-verified votes are required:
      - owner-verified reviewers must have `owner_attestation_ref` (fail closed if missing)
      - non-owner-verified reviewers can still vote only by providing `fallback_stake` (amount/currency) meeting a minimum threshold.
  - Added request/record fields:
    - CastVoteRequest.fallback_stake
    - ReviewerVote.fallback_stake
- Files changed
  - packages/bounties/src/types/quorum.ts
  - packages/bounties/src/actions/quorumReview.ts
  - prd.json
  - progress.txt
- Quality checks
  - cd packages/bounties && npm run typecheck
---

## 2026-02-02T06:01:14Z - CBT-US-015
- What was implemented
  - Added a minimal public worker for clawbounties:
    - GET / (HTML landing linking to /docs and /skill.md)
    - GET /docs (minimal HTML docs)
    - GET /skill.md (OpenClaw skill; frontmatter `metadata` is a single-line JSON object string)
    - GET /robots.txt, GET /sitemap.xml, GET /.well-known/security.txt
- Files changed
  - services/clawbounties/src/index.ts
  - services/clawbounties/package.json
  - services/clawbounties/tsconfig.json
  - prd.json
  - progress.txt
- Quality checks
  - cd services/clawbounties && npm run typecheck
---

## 2026-02-03 - CBT-US-016
- Deployed clawbounties discovery worker to real domains:
  - Added `services/clawbounties/wrangler.toml` with prod + staging routes.
  - Added `GET /health` endpoint.
  - Added Wrangler + Workers types tooling to `services/clawbounties/package.json`.
  - Created Cloudflare DNS records for:
    - `clawbounties.com`
    - `www.clawbounties.com`
    - `staging.clawbounties.com`
  - Deployed to:
    - https://clawbounties.com
    - https://staging.clawbounties.com

## 2026-02-03 - CBT-US-017
- Implemented minimal marketplace API (admin-gated) for Agent Economy MVP:
  - `POST /v1/bounties`:
    - requires `idempotency_key`, title/description, `reward_minor`, `job_type`, `closure_type`
    - calls `clawcuts /v1/fees/simulate`
    - calls `clawescrow /v1/escrows` to hold `buyer_total_minor`
    - persists bounty + escrow_id + fee quote in D1
  - `GET /v1/bounties?status=open&job_type=code` lists bounties
- Infra:
  - D1 DBs:
    - `clawbounties` (cfdc9fe2-cbed-4d13-9362-67363a8857df)
    - `clawbounties-staging` (6b04a8f1-75ba-414f-afd8-36067db109a1)
  - Secrets set (prod + staging):
    - `BOUNTIES_ADMIN_KEY`
    - `ESCROW_SERVICE_KEY` (uses clawescrow admin key)

## 2026-02-04 - CBT-US-017 (v2 API upgrade)
- Breaking upgrade: switched clawbounties marketplace API to **schema v2** shapes (no backwards compatibility).
  - Post bounty request uses `reward.amount_minor` + `closure_type` + `difficulty_scalar`.
  - Job “flavor” modeled via `is_code_bounty` + `tags[]` (no legacy `job_type`).
  - Direct hire modeled via `metadata.requested_worker_did`.
- Updated integration:
  - clawcuts `/v1/fees/simulate` called with `params.is_code_bounty + params.closure_type`.
  - Stores fee policy snapshot + all-in cost breakdown on the bounty record.
- Persistence:
  - Added D1 migration `migrations/0002_bounties_v2.sql` (drops & recreates `bounties` table with v2 columns).
- Typecheck: `npm run typecheck`.

## 2026-02-04 - CBT-US-018
- Added worker registry endpoints (OpenClaw Worker plugin bootstrap):
  - `POST /v1/workers/register` (public) upserts worker record and issues a short-lived bearer token.
    - Token is stored as `sha256(token)` (hex) in D1; plaintext token is never persisted.
    - Re-register rotates the token.
  - `GET /v1/workers?job_type=code&tag=typescript` lists workers for discovery.
  - `GET /v1/workers/self` returns the caller worker record (requires `Authorization: Bearer <token>`).
- Persistence:
  - Added D1 migration `migrations/0003_workers.sql` (workers table + token hash index).
- Docs:
  - Updated `/docs` + `/skill.md` to include worker endpoints.
- Typecheck: `npm run typecheck`.

## 2026-02-04 - CBT-US-019
- Added worker-authenticated bounty acceptance:
  - `POST /v1/bounties/{bounty_id}/accept` (requires `Authorization: Bearer <worker_token>`)
    - Enforces `worker_did` matches token.
    - Enforces direct-hire via `metadata.requested_worker_did` when set.
    - Calls `clawescrow /v1/escrows/{escrow_id}/assign`.
    - Persists acceptance (`worker_did`, `accepted_at`, `accept_idempotency_key`, `status=accepted`) on the bounty.
- Persistence:
  - Added D1 migration `migrations/0004_bounty_accept.sql`.
- Docs:
  - Updated `/docs` + `/skill.md` to include accept endpoint.
- Typecheck: `npm run typecheck`.

## 2026-02-04 - CBT-US-020
- Added worker-authenticated bounty listing:
  - `GET /v1/bounties?status=open` requires worker bearer token auth.
  - Filters by `is_code_bounty` + `tag` query params.
  - Direct-hire bounties only appear to the requested worker.
  - Worker response omits requester/admin-only fields (no requester_did/escrow_id).
- Docs:
  - Updated `/docs` + `/skill.md` to include worker bounty listing.
- Typecheck: `npm run typecheck`.

## 2026-02-04 - CBT-US-021
- Added worker-authenticated submission endpoint:
  - `POST /v1/bounties/{bounty_id}/submit` (requires `Authorization: Bearer <worker_token>`).
  - Requires `proof_bundle_envelope`; `commit_proof_envelope` required for code bounties.
  - Calls clawverify `/v1/verify/bundle` (fail-closed) and `/v1/verify/commit-proof` for code bounties.
  - Persists submission records with verification status + proof_tier.
  - Valid submissions move bounty status to `pending_review`.
- Persistence:
  - Added D1 migration `migrations/0005_bounty_submissions.sql`.
- Docs:
  - Updated `/docs` + `/skill.md` to include submit endpoint.
- Typecheck: `npm run typecheck`.

## 2026-02-09 - Trust Pulse: submission storage + auto-load viewer
- Added optional Trust Pulse ingestion at submission time:
  - `POST /v1/bounties/{bounty_id}/submit` accepts optional `trust_pulse` (trust_pulse.v1 JSON).
  - Enforces non-tier invariants (`evidence_class=self_reported`, `tier_uplift=false`).
  - Binds Trust Pulse to proof bundle context (`run_id` + `agent_did`) and authenticated `worker_did`.
  - If URM includes `metadata.trust_pulse.artifact_hash_b64u`, hash must match (fail-closed).
- Added auth-gated retrieval endpoint:
  - `GET /v1/submissions/{submission_id}/trust-pulse` (admin key OR owning worker token).
- Updated `/trust-pulse` viewer:
  - Supports `?submission_id=sub_...` + fetch via `Authorization: Bearer ...` header (token is never in URL).
- Persistence:
  - Added D1 migration `migrations/0009_submission_trust_pulse.sql`.
- Docs:
  - Updated `/docs` + `/skill.md`.
- Typecheck: `npm run typecheck`.

## 2026-02-10 - CWC-US-001 (Confidential Work Contract)
- Added optional Confidential Work Contract (CWC) support for direct-hire bounties:
  - `POST /v1/bounties` accepts `cwc_buyer_envelope` (buyer-signed CWC envelope).
  - Stores `cwc_hash_b64u`, pinned `wpc_policy_hash_b64u`, and required tier on the bounty.
- Acceptance requires worker countersign when a CWC is pinned:
  - `POST /v1/bounties/{bounty_id}/accept` requires `cwc_worker_envelope` when `cwc_hash_b64u` is set.
  - Stores the worker countersign on the bounty (idempotent accept can backfill it).
- Submission enforces policy binding:
  - For otherwise-valid proof bundles, requires verified+bound receipts to include `binding.policy_hash` matching the pinned WPC hash.
- Persistence:
  - Added D1 migration `migrations/0010_confidential_work_contract.sql`.
- Typecheck: `npm run typecheck`.

## 2026-02-11 - CBT-OPS-001 / CEA-US-049H (requester scoped auth + simulation launcher)
- Replaced temporary requester identity path for requester closure actions with scoped requester CST/JWT auth:
  - `POST /v1/bounties`
  - `POST /v1/bounties/{bounty_id}/approve`
  - `POST /v1/bounties/{bounty_id}/reject`
- Fail-closed requester auth behavior:
  - Token introspection via `clawscope /v1/tokens/introspect`
  - DID-bound `sub` enforcement with deterministic mismatch code (`REQUESTER_SUB_MISMATCH`)
  - Explicit scope enforcement (`REQUESTER_SCOPE_REQUIRED`)
  - Missing token fail-closed (`REQUESTER_TOKEN_REQUIRED`)
  - Audience enforcement via `REQUESTER_AUTH_REQUIRED_AUDIENCE`
- Compatibility path retained behind explicit flag:
  - `REQUESTER_AUTH_COMPAT_LEGACY=true` allows legacy `admin + x-requester-did`
  - Default remains disabled (staging var set to false)
- Added reviewer ergonomics endpoints (fail-closed auth):
  - `GET /v1/bounties/{bounty_id}/submissions`
  - `GET /v1/submissions/{submission_id}`
- Added requester auth usage context persistence:
  - D1 migration `migrations/0014_requester_auth_events.sql`
  - table `requester_auth_events` captures action, requester DID, auth mode, token hash, scope/audience snapshot.
- Added staging simulation launcher:
  - `scripts/clawbounties/smoke-requester-closure-simulation.mjs`
  - Runs real post/accept/submit/review/approve-or-reject flow with `closure_type=requester` (no D1 injection)
  - Parameterized run size (`--runs`) and writes artifacts under `artifacts/simulations/clawbounties-requester-closure/...`
- Docs:
  - Updated `/docs` + `/skill.md` auth guidance for scoped requester tokens and new reviewer endpoints.
- Typecheck:
  - `cd services/clawbounties && npm run typecheck`

## 2026-02-11 - CBT-OPS-001 follow-up (staging route shadow fix + smoke evidence)
- Resolved staging-only `POST /v1/bounties` regression returning legacy `UNAUTHORIZED/Invalid admin token`:
  - Added explicit staging route mapping `staging.clawbounties.com/v1/bounties*` in `services/clawbounties/wrangler.toml` before wildcard route.
  - Redeployed clawbounties-staging and validated requester token path now reaches scoped-auth handler (legacy admin-token error removed).
- Added deterministic auth smoke artifact:
  - `artifacts/smoke/requester-auth/2026-02-11T19-25-45Z-staging/result.json`
  - Confirms:
    - missing token => `401 REQUESTER_TOKEN_REQUIRED`
    - scope mismatch => `403 REQUESTER_SCOPE_REQUIRED`
    - requester DID mismatch => `401 REQUESTER_SUB_MISMATCH`
- Simulation evidence:
  - PASS runset artifact: `artifacts/simulations/clawbounties-requester-closure/2026-02-11T19-20-52-597Z-staging-runs-3/result.json` (3/3 success, mixed approve/reject).
  - Updated simulation launcher to accept `--reward-minor` and tolerate `accept` 200/201 responses for endpoint shape parity.
- Ops note:
  - Staging requester account is low-balance; larger runsets can fail at post with deterministic upstream `ESCROW_FAILED -> LEDGER_TRANSFER_FAILED -> INSUFFICIENT_FUNDS`.

## 2026-02-11 - CBT-OPS-002 (simulation activation tranche, staging)
- Truth-first tracker/docs updates:
  - Added `CBT-US-022`, `CBT-US-023`, `CBT-US-024` in `services/clawbounties/prd.json` (all `passes=false`).
  - Updated `docs/prds/clawbounties.md` status/scope to reflect queued activation tranche.
- Test-lane fail-closed hardening in clawbounties:
  - `autoApproveTestSubmission(...)` now returns deterministic failure envelopes (not boolean-only).
  - Deterministic harness error codes surfaced to submit callers, including idempotent replay path.
  - Added deterministic classification for harness failures (`TEST_HARNESS_UNAVAILABLE`, `TEST_HARNESS_INVALID`, etc.).
- Reviewer ergonomics endpoints implemented:
  - `GET /v1/bounties/{bounty_id}/submissions`
  - `GET /v1/submissions/{submission_id}`
  - Auth boundaries: admin OR worker token OR requester scoped token (with ownership checks).
- New API-only simulation tooling added (no D1 injection):
  - `scripts/poh/smoke-clawbounties-e2e-requester.mjs`
  - `scripts/poh/smoke-clawbounties-e2e-test.mjs`
  - `scripts/poh/simulate-clawbounties-batch.mjs`
  - shared helper: `scripts/poh/_clawbounties-sim-common.mjs`
- Staging deploy:
  - clawbounties-staging version `cfd928ce-eb7a-493f-aa0c-5620aff1d8ad`.
  - note: detected cross-lane staging overwrite (`3da99ebc-6215-4281-9e75-442c24840621`) and restored CBT-OPS-002 build to keep auth-lane isolation.
- Validation:
  - `npm --prefix services/clawbounties run typecheck` ✅
  - `node scripts/docs/lint-prds.mjs` ✅
  - `node scripts/poh/smoke-clawbounties-e2e-requester.mjs --env staging --requester-did did:key:zsimrequesterbatch0001` ✅
  - `node scripts/poh/smoke-clawbounties-e2e-test.mjs --env staging --requester-did did:key:zsimrequesterbatch0001 --clawtrials-base-url https://clawtrials-staging.generaite.workers.dev` ✅
  - `node scripts/poh/simulate-clawbounties-batch.mjs --env staging --total 10 --concurrency 4 --label cbt-ops-002-batch10 --requester-did did:key:zsimrequesterbatch0001 --clawtrials-base-url https://clawtrials-staging.generaite.workers.dev` ✅
  - `node scripts/poh/simulate-clawbounties-batch.mjs --env staging --total 50 --concurrency 6 --label cbt-ops-002-batch50 --requester-did did:key:zsimrequesterbatch0001 --clawtrials-base-url https://clawtrials-staging.generaite.workers.dev` ✅
  - deterministic fail-closed replay check for invalid harness id (`TEST_HARNESS_INVALID`) ✅
- Artifacts:
  - `artifacts/simulations/clawbounties/2026-02-11T19-28-51-613Z-requester-e2e/requester-smoke.json`
  - `artifacts/simulations/clawbounties/2026-02-11T19-29-09-547Z-test-e2e/test-smoke.json`
  - `artifacts/simulations/clawbounties/2026-02-11T19-29-29-194Z-batch-10/{summary.json,jobs.ndjson}`
  - `artifacts/simulations/clawbounties/2026-02-11T19-30-09-452Z-batch-50/{summary.json,jobs.ndjson}`
  - `artifacts/simulations/clawbounties/2026-02-11T19-31-19-823Z-failclosed-invalid/invalid-harness-replay.json`
  - `artifacts/simulations/clawbounties/2026-02-11T19-31-34-792Z-clawtrials-domain-check/staging-clawtrials-domain-check.json`
- Remaining before flipping passes true:
  - explicit GO PROD only (no prod deploy/smoke or pass flip yet).

## 2026-02-11 - CBT-OPS-002 rebase on main + post-merge staging rerun
- Rebases `feat/marketplace/CBT-OPS-002-clawbounties-simulation-activation` onto `origin/main` (after #141 merge) and resolved requested conflicts in:
  - `services/clawbounties/src/index.ts`
  - `services/clawbounties/prd.json`
  - `services/clawbounties/progress.txt`
- Preserved both lanes:
  - requester scoped auth + compat behavior from #141,
  - CBT-OPS-002 test-lane/reviewer/simulation tranche behavior.
- `services/clawbounties/src/index.ts` merge outcomes:
  - unified submission viewer auth (`admin | worker | requester scoped token`) via `resolveSubmissionViewerContext(...)` + `requireRequesterAuth(...)`.
  - requester submission read endpoints now persist requester auth events (list + detail).
  - reconciled route wiring to use `handleGetSubmissionDetail(...)` and the filtered list endpoint signature.
- Reconciled simulation scripts with requester scoped auth requirements:
  - updated `scripts/poh/_clawbounties-sim-common.mjs` to support explicit requester bearer token across post/review/list/detail polling flows.
  - updated requester/batch runners to send requester bearer token for `GET /v1/bounties/{id}/submissions` and `GET /v1/submissions/{id}` (fail-closed #141 behavior).
- Staging deploys after rebase merge:
  - clawtrials-staging version `4f576033-a246-403d-b08f-5bbe39d64394`
  - clawbounties-staging version `00b65ef5-7254-4467-ac38-ac3b12b8c9f0`
- Validation gates (post-merge):
  - `npm --prefix services/clawbounties run typecheck` ✅
  - `npm --prefix services/clawtrials run typecheck` ✅
  - `node scripts/docs/lint-prds.mjs` ✅
- Re-ran staging evidence suite:
  - requester smoke: `artifacts/simulations/clawbounties/2026-02-11T21-12-08-350Z-requester-e2e/requester-smoke.json`
  - test-lane smoke: `artifacts/simulations/clawbounties/2026-02-11T21-12-22-842Z-test-e2e/test-smoke.json`
  - batch (10): `artifacts/simulations/clawbounties/2026-02-11T21-12-44-628Z-batch-10/{summary.json,jobs.ndjson}`
  - batch (50): `artifacts/simulations/clawbounties/2026-02-11T21-13-25-032Z-batch-50/{summary.json,jobs.ndjson}`
  - deterministic invalid harness replay: `artifacts/simulations/clawbounties/2026-02-11T21-14-43-946Z-failclosed-invalid/invalid-harness-replay.json`
  - clawtrials domain check: `artifacts/simulations/clawbounties/2026-02-11T21-15-21-606Z-clawtrials-domain-check/staging-clawtrials-domain-check.json`
- Policy/tracker state kept truthful:
  - `CBT-US-022/023/024` remain `passes=false` (staging complete, explicit GO PROD still required).

## 2026-02-11 - CBT-OPS-003 (marketplace production gate + scale reliability pipeline, staging)
- Added tracker stories for CBT-OPS-003 tranche (all `passes=false` pending GO PROD):
  - `CBT-US-025` production gate preflight pack
  - `CBT-US-026` 200+ batch reliability mode
  - `CBT-US-027` funding-aware orchestration
- Added one-command deterministic gate pack:
  - `scripts/poh/gate-clawbounties-prod-readiness.mjs`
  - checks include routes/health, auth contracts, harness availability, and integration checks
  - outputs:
    - `gate-report.json`
    - `gate-report.md`
    under `artifacts/simulations/clawbounties/<timestamp>-prod-gate/`
- Extended batch simulation runner (`scripts/poh/simulate-clawbounties-batch.mjs`):
  - bounded concurrency (`--max-concurrency`)
  - adaptive backpressure knobs (`--backpressure-*`)
  - deterministic classified error buckets + raw buckets
  - expanded stuck-state reporting with sampled stuck jobs
  - 200+ mode exercised on staging (`--total 200`)
- Funding-aware orchestration implemented:
  - funding preflight probe before job wave
  - configurable abort/continue behavior on funding preflight failure
  - dedicated `INSUFFICIENT_FUNDS` classification path in summary logic
- Staging deploys for this tranche:
  - `clawtrials-staging`: `2a7af0d8-d91e-45ba-8d9d-48af3846d016`
  - `clawbounties-staging`: `d00fe272-c0a7-466c-947e-a5a8966f576a`
- Staging artifacts captured:
  - prod gate report: `artifacts/simulations/clawbounties/2026-02-11T21-54-21-876Z-prod-gate/{gate-report.json,gate-report.md}`
  - 200-run reliability (continue mode): `artifacts/simulations/clawbounties/2026-02-11T21-52-02-488Z-batch-200/{summary.json,jobs.ndjson}`
  - funding-gated abort mode: `artifacts/simulations/clawbounties/2026-02-11T21-52-17-670Z-batch-200/{summary.json,jobs.ndjson}`
- Deterministic blocker surfaced:
  - requester scoped token rejected with `REQUESTER_TOKEN_INVALID` + `TOKEN_UNKNOWN_KID` on staging, blocking requester-authenticated post/approve/reject path until requester token issuance path is restored.
- Validation:
  - `npm --prefix services/clawbounties run typecheck` ✅
  - `npm --prefix services/clawtrials run typecheck` ✅
  - `node scripts/docs/lint-prds.mjs` ✅
- Governance status:
  - keep `CBT-US-025/026/027` as `passes=false` until explicit GO PROD and production verification.

## 2026-02-11 - CBT-OPS-003 production activation closeout (M1/M2/M3)
- Root-cause + interoperability fix (M1):
  - Determined `REQUESTER_TOKEN_INVALID` (`TOKEN_UNKNOWN_KID`) blocker was caused by simulation flow drift: locally minted requester tokens were signed with stale key material while clawscope active signing kids had rotated.
  - Updated simulation stack to support deterministic requester token issuance directly via clawscope issuer API:
    - `scripts/poh/_clawbounties-sim-common.mjs`
      - added `resolveScopeBaseUrl`, `resolveRequesterAudience`, `resolveRequesterScopes`, `issueRequesterScopedToken(...)`
    - updated runners/gate to auto-issue requester token when direct token not provided:
      - `scripts/poh/gate-clawbounties-prod-readiness.mjs`
      - `scripts/poh/simulate-clawbounties-batch.mjs`
      - `scripts/poh/smoke-clawbounties-e2e-requester.mjs`
      - `scripts/poh/smoke-clawbounties-e2e-test.mjs`
  - Cross-service config updates (explicit):
    - rotated/standardized `SCOPE_ADMIN_KEY` secret for:
      - `clawscope-staging`
      - `clawscope` (prod)
      - `clawbounties-staging`
      - `clawbounties` (prod)
  - Staging gate re-run after fix is green:
    - `artifacts/simulations/clawbounties/2026-02-11T22-14-08-561Z-prod-gate/gate-report.json`

- Production rollout + verification (M2):
  - Deployed services:
    - `clawtrials-staging`: `3625d6b1-4fc9-4f97-a29f-d3a024ef47f1`
    - `clawtrials` (prod): `e61dde2b-06a5-4c99-9e6d-6010f8d5412c`
    - `clawbounties-staging`: `540fa374-3783-4085-af4d-b4430f9e3f9f`
    - `clawbounties` (prod): `a759fb62-4e85-451a-92e0-4a06bda36fa4`
    - dependency deploys:
      - `clawscope-staging`: `95d19b41-5032-4fd0-ab3d-f83469d35cc2`
      - `clawscope` (prod): `bf9a8055-e68a-4153-993e-627de6fb0aa7`
  - Production route fix (clawtrials):
    - Added production API path routes in `services/clawtrials/wrangler.toml`:
      - `clawtrials.com/v1/harness*`
      - `clawtrials.com/health`
  - Production migration fix:
    - Initial prod requester smoke failed with deterministic DB error:
      - `DB_WRITE_FAILED` / `D1_ERROR: no such table: requester_auth_events`
    - Applied remote D1 migrations on prod clawbounties DB:
      - `0013_submission_execution_attestations.sql`
      - `0014_requester_auth_events.sql`
  - Production smoke artifacts (all green):
    - requester E2E:
      - `artifacts/simulations/clawbounties/2026-02-11T22-20-53-579Z-requester-e2e/requester-smoke.json`
    - test-lane E2E:
      - `artifacts/simulations/clawbounties/2026-02-11T22-21-49-713Z-test-e2e/test-smoke.json`
    - batch 10:
      - `artifacts/simulations/clawbounties/2026-02-11T22-22-07-779Z-batch-10/{summary.json,jobs.ndjson}`
    - batch 50:
      - `artifacts/simulations/clawbounties/2026-02-11T22-22-33-468Z-batch-50/{summary.json,jobs.ndjson}`
    - batch 200:
      - `artifacts/simulations/clawbounties/2026-02-11T22-23-42-689Z-batch-200/{summary.json,jobs.ndjson}`
    - prod gate report (includes deterministic invalid-harness replay 422 checks):
      - `artifacts/simulations/clawbounties/2026-02-11T22-23-53-242Z-prod-gate/{gate-report.json,gate-report.md}`

- Story closure + tracker truth (M3):
  - Flipped to `passes=true` with production evidence complete:
    - `CBT-US-022`
    - `CBT-US-023`
    - `CBT-US-024`
    - `CBT-US-025`
    - `CBT-US-026`
    - `CBT-US-027`

## 2026-02-11 - CBT-OPS-004 kickoff (truth-first planning)
- Opened planned stories in `services/clawbounties/prd.json` with `passes=false`:
  - `CBT-US-028` Identity control-plane contract assimilation
  - `CBT-US-029` Sensitive transition enforcement hardening
  - `CBT-US-030` API-only simulation discipline for control-plane lane
- Scope for next execution tranche:
  - align marketplace auth contracts with identity control-plane outputs
  - harden sensitive transition enforcement semantics in production operations
  - preserve API-only simulation discipline for all validation flows
- Governance:
  - kickoff only; no implementation or pass flips in this PR.
