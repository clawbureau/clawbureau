{
  "project": "clawbureau",
  "branchName": "ralph/clawledger-phase1-trust",
  "description": "clawledger.com (Ledger) — PRD — Event-sourced ledger for balances, holds, and transfers. Idempotent and auditable.",
  "userStories": [
    {
      "id": "CLD-US-001",
      "title": "Create accounts",
      "description": "As a user, I want a balance account so that I can receive credits.",
      "acceptanceCriteria": [
        "Create account on first use",
        "Enforce unique DID",
        "Return current balance",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in services/ledger with D1 + Cloudflare Workers"
    },
    {
      "id": "CLD-US-002",
      "title": "Ledger event writes",
      "description": "As a system, I want append-only events so that audits are possible.",
      "acceptanceCriteria": [
        "Event types: mint/burn/transfer/hold/release",
        "Idempotency key required",
        "Write hash to clawlogs",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented event system with hash chain, idempotency keys, and API endpoints"
    },
    {
      "id": "CLD-US-003",
      "title": "Hold/Release support",
      "description": "As a escrow, I want to lock funds so that payments are safe.",
      "acceptanceCriteria": [
        "Create hold event",
        "Release or cancel hold",
        "Prevent negative balances",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented holds with create/release API, balance validation, and D1 migration"
    },
    {
      "id": "CLD-US-004",
      "title": "Balance reconciliation",
      "description": "As a operator, I want ledger replay checks so that bugs are caught.",
      "acceptanceCriteria": [
        "Nightly replay job",
        "Alert on mismatch",
        "Export report",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Implemented nightly cron job (2 AM UTC), event replay with balance comparison, hash chain verification, alert webhooks, and export endpoint"
    },
    {
      "id": "CLD-US-005",
      "title": "Reserve attestation",
      "description": "As a auditor, I want reserve coverage reports so that credits are trusted.",
      "acceptanceCriteria": [
        "Compute reserves/outstanding",
        "Signed attestation",
        "Public endpoint",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Implemented reserve attestation with GET /attestation/reserve endpoint, net minted calculation, balance hash verification, and hash-based signature"
    },
    {
      "id": "CLD-US-006",
      "title": "API access",
      "description": "As a platform, I want ledger APIs so that I can integrate.",
      "acceptanceCriteria": [
        "GET /balances",
        "POST /transfers",
        "Webhook for events",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Implemented GET /balances with pagination/filtering, POST /transfers with validation and balance updates, and webhook notifications via EVENT_WEBHOOK_URL"
    },
    {
      "id": "CLD-US-007",
      "title": "Balance buckets & invariants",
      "description": "As a system, I want balance buckets so that holds, stakes, and fees are explicit.",
      "acceptanceCriteria": [
        "Track buckets: available (A), held (H), bonded (B), fee pool (F), promo (P)",
        "Enforce non-negative balances per bucket",
        "Expose balances per bucket in API responses",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented bucket-level operations (credit/debit) for all five buckets with non-negative enforcement via InsufficientFundsError. Added generic creditBucket/debitBucket and moveBetweenBuckets methods. API responses already expose per-bucket balances in AccountResponse."
    },
    {
      "id": "CLD-US-008",
      "title": "Stake/fee event types",
      "description": "As a platform, I want explicit stake and fee events so that audits are deterministic.",
      "acceptanceCriteria": [
        "Support event types: stake_lock, stake_slash, fee_burn, fee_transfer, promo_mint, promo_burn",
        "Link stake/fee events to originating escrow/trial ids",
        "Emit hash-chained log entry for each event",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented stake_lock, stake_slash, fee_burn, fee_transfer, promo_mint, promo_burn event types with metadata for escrow/trial/campaign linking. Hash-chained events via StakeFeeService. API endpoints at /stake/lock, /stake/slash, /fees/burn, /fees/transfer, /promo/mint, /promo/burn."
    },
    {
      "id": "CLD-US-009",
      "title": "Clearing accounts & settlement refs",
      "description": "As a finance operator, I want clearing accounts so that cross-service settlement is clean.",
      "acceptanceCriteria": [
        "Create per-domain clearing accounts",
        "Allow transfers between user accounts and clearing accounts",
        "Store netting batch ids on settlement events",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Implemented per-domain clearing accounts with ClearingAccountRepository. Added clearing_deposit, clearing_withdraw, settlement event types. Settlements require batchId for netting references. API endpoints: POST/GET /clearing/accounts, POST /clearing/deposit, POST /clearing/withdraw, POST /settlements."
    },
    {
      "id": "CLD-US-010",
      "title": "Reserve asset registry",
      "description": "As a auditor, I want reserve asset tables so that coverage is verifiable.",
      "acceptanceCriteria": [
        "Store reserve assets with haircut factors",
        "Compute coverage ratio from eligible reserves only",
        "Include reserve breakdown in signed attestation",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Added reserve_assets table + /reserve/assets registry endpoints. Reserve attestations now compute coverage from eligible reserve assets after applying haircut_bps and include signed reserve asset breakdown (via reserveAssetsHash)."
    },
    {
      "id": "CLD-US-011",
      "title": "Compute reserve assets",
      "description": "As a finance operator, I want compute reserves so that credits are backed.",
      "acceptanceCriteria": [
        "Record Gemini/FAL credit balances as reserve assets",
        "Apply conservative haircuts by provider",
        "Include compute reserves in coverage attestations",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Added POST /reserve/compute to upsert stable reserve assets for Gemini + FAL compute credits (asset_type=compute_credits, currency=USD) with conservative provider haircuts (gemini=7000bps, fal=6000bps). These assets flow into /attestation/reserve via the existing reserve asset registry." 
    },
    {
      "id": "CLD-US-012",
      "title": "Public landing + skill docs",
      "description": "As a developer, I want public landing/docs/skill endpoints so that I can discover and integrate the ledger quickly.",
      "acceptanceCriteria": [
        "GET / returns a small HTML landing page with links to /docs and /skill.md",
        "GET /skill.md returns integration docs + example curl commands",
        "GET /robots.txt and /sitemap.xml exist (minimal)",
        "GET /.well-known/security.txt exists",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Added public endpoints to services/ledger worker: GET / (HTML landing), GET /docs, GET /skill.md (OpenClaw frontmatter with metadata as single-line JSON object string + curl examples), GET /robots.txt, GET /sitemap.xml, and GET /.well-known/security.txt." 
    },
    {
      "id": "CLD-US-013",
      "title": "Spec-compatible v1 endpoints",
      "description": "As an integrator, I want /v1/balances and /v1/transfers so that the ledger matches the Agent Economy MVP spec.",
      "acceptanceCriteria": [
        "GET /v1/balances?did=<did> returns buckets A/H/B/F/P as integer strings",
        "POST /v1/transfers supports bucket moves and cross-account transfers with idempotency_key",
        "Supports clearing: accounts (auto-create) as transfer targets/sources",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Added spec-compatible endpoints /v1/balances and /v1/transfers (bucket letters A/H/B/F/P), including clearing: account support and event logging."
    },
    {
      "id": "CLD-US-014",
      "title": "Production deploy + fail-closed admin auth",
      "description": "As an operator, I want clawledger deployed with staging/prod environments and fail-closed auth so that it is safe to expose on its domain.",
      "acceptanceCriteria": [
        "wrangler.toml binds real D1 databases for staging + production",
        "wrangler.toml configures custom-domain routes for staging.clawledger.com and clawledger.com",
        "All non-public endpoints require Authorization: Bearer <LEDGER_ADMIN_KEY> (503 if LEDGER_ADMIN_KEY is unset)",
        "Staging + production deploy succeed",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Wired D1 database bindings and custom-domain routes, added fail-closed admin-key auth gate for non-public endpoints, and deployed staging + production." 
    },
    {
      "id": "CLD-US-015",
      "title": "Machine payment settlement provenance foundation",
      "description": "As a platform, I want provider-agnostic settlement ingestion semantics so future machine-payment providers can integrate without changing core ledger invariants.",
      "acceptanceCriteria": [
        "Settlement spec + canonical schema exist for provider-neutral ingest",
        "POST /v1/payments/settlements/ingest is admin-auth + idempotency-key required",
        "Fail-closed status transition validation with deterministic error codes",
        "Event model includes payin_settle, payin_reverse, payout_settle",
        "GET settlement lookup/list endpoints support deterministic pagination",
        "Typecheck and tests pass"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Added payment settlement spec/schemas, migration 0007 (payment_settlements + idempotency replay table), ingest + lookup/list endpoints, fail-closed transition checks, and settlement smoke test for staging/prod." 
    }
  ]
}
