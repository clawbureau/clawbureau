{
  "$id": "https://schemas.clawbureau.org/claw.poh.execution_attestation.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Execution Attestation v1",
  "type": "object",
  "description": "Attestation that a run executed in a specific isolation environment (sandbox/TEE).",
  "additionalProperties": false,
  "required": [
    "attestation_version",
    "attestation_id",
    "execution_type",
    "agent_did",
    "attester_did",
    "issued_at"
  ],
  "properties": {
    "attestation_version": { "const": "1" },
    "attestation_id": { "type": "string", "minLength": 1 },
    "execution_type": {
      "type": "string",
      "enum": ["sandbox_execution", "tee_execution"],
      "description": "Type of execution guarantee."
    },
    "agent_did": {
      "type": "string",
      "pattern": "^did:",
      "description": "Agent DID that was executed. Must start with 'did:'."
    },
    "attester_did": {
      "type": "string",
      "pattern": "^did:",
      "description": "Attester DID (sandbox/TEE authority). Must start with 'did:'."
    },
    "run_id": { "type": "string", "description": "Optional binding to a specific run_id." },
    "proof_bundle_hash_b64u": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_-]+$",
      "minLength": 8,
      "description": "Optional binding to a proof bundle hash (base64url)."
    },
    "harness": {
      "type": "object",
      "description": "Optional harness metadata (id/version/runtime/config hash) observed by the attester.",
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string" },
        "version": { "type": "string" },
        "runtime": { "type": "string" },
        "config_hash_b64u": { "type": "string", "pattern": "^[A-Za-z0-9_-]+$" }
      }
    },
    "runtime_metadata": {
      "type": "object",
      "description": "Optional environment claims (e.g. image hash, resource limits, network policy). For tee_execution, runtime_metadata.tee carries measured attestation claims.",
      "additionalProperties": true,
      "properties": {
        "tee": {
          "type": "object",
          "description": "TEE remote-attestation summary claims used for policy gating (allowlist/revocation) and offline review.",
          "additionalProperties": false,
          "required": [
            "attestation_type",
            "root_id",
            "tcb_version",
            "evidence_ref",
            "measurements"
          ],
          "properties": {
            "attestation_type": {
              "type": "string",
              "enum": [
                "sgx_quote",
                "tdx_quote",
                "sev_snp_report",
                "nitro_attestation_doc",
                "generic_tee"
              ]
            },
            "root_id": {
              "type": "string",
              "minLength": 1,
              "description": "TEE root-of-trust identifier used for allowlist/revocation policy checks."
            },
            "tcb_version": {
              "type": "string",
              "minLength": 1,
              "description": "TCB version string used for allowlist/revocation policy checks."
            },
            "evidence_ref": {
              "type": "object",
              "additionalProperties": false,
              "required": ["resource_type", "resource_hash_b64u"],
              "properties": {
                "resource_type": { "type": "string", "minLength": 1 },
                "resource_hash_b64u": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9_-]+$",
                  "minLength": 8
                },
                "uri": { "type": "string" }
              }
            },
            "measurements": {
              "type": "object",
              "additionalProperties": false,
              "required": ["measurement_hash_b64u"],
              "properties": {
                "measurement_hash_b64u": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9_-]+$",
                  "minLength": 8
                },
                "runtime_digest_b64u": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9_-]+$",
                  "minLength": 8
                },
                "kernel_digest_b64u": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9_-]+$",
                  "minLength": 8
                }
              }
            },
            "tcb": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "status": {
                  "type": "string",
                  "enum": [
                    "up_to_date",
                    "out_of_date",
                    "configuration_needed",
                    "revoked",
                    "unknown"
                  ]
                },
                "advisory_ids": {
                  "type": "array",
                  "items": { "type": "string", "minLength": 1 }
                }
              }
            },
            "metadata": { "type": "object", "additionalProperties": true }
          }
        }
      }
    },
    "issued_at": { "type": "string", "format": "date-time" },
    "expires_at": { "type": "string", "format": "date-time" },
    "metadata": { "type": "object" }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "execution_type": { "const": "tee_execution" }
        }
      },
      "then": {
        "required": ["runtime_metadata"],
        "properties": {
          "runtime_metadata": {
            "required": ["tee"],
            "properties": {
              "tee": {
                "required": [
                  "attestation_type",
                  "root_id",
                  "tcb_version",
                  "evidence_ref",
                  "measurements"
                ]
              }
            }
          }
        }
      }
    }
  ]
}
