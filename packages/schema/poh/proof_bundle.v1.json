{
  "$id": "https://schemas.clawbureau.org/claw.poh.proof_bundle.v1.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Proof Bundle v1",
  "type": "object",
  "additionalProperties": false,
  "required": ["bundle_version", "bundle_id", "agent_did"],
  "properties": {
    "bundle_version": {
      "const": "1",
      "description": "Proof bundle payload version."
    },
    "bundle_id": {
      "type": "string",
      "minLength": 1,
      "description": "Unique identifier for this proof bundle payload."
    },
    "agent_did": {
      "type": "string",
      "pattern": "^did:",
      "description": "Agent DID. Must start with 'did:'."
    },
    "eip8004_agent_id": {
      "type": "string",
      "pattern": "^[0-9]+$",
      "description": "ERC-721 tokenId from EIP-8004 Identity Registry (uint256 as decimal string). Optional — only present for EIP-8004-registered agents."
    },
    "eip8004_registry": {
      "type": "string",
      "pattern": "^eip155:[0-9]+:0x[0-9a-fA-F]{40}$",
      "description": "CAIP-10 address of the EIP-8004 Identity Registry contract (e.g. eip155:1:0x1234...abcd). Optional — SHOULD be present when eip8004_agent_id is set."
    },
    "urm": {
      "type": "object",
      "description": "Universal Resource Manifest (URM) reference. The URM document itself is content-addressed and can be fetched separately.",
      "additionalProperties": false,
      "required": ["urm_version", "urm_id", "resource_type", "resource_hash_b64u"],
      "properties": {
        "urm_version": { "const": "1" },
        "urm_id": { "type": "string", "minLength": 1 },
        "resource_type": { "type": "string", "minLength": 1 },
        "resource_hash_b64u": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_-]+$",
          "minLength": 8,
          "description": "SHA-256 hash of the URM bytes, base64url (no padding)."
        },
        "metadata": { "type": "object", "description": "Optional URM reference metadata." }
      }
    },
    "event_chain": {
      "type": "array",
      "minItems": 1,
      "description": "Hash-chained event log entries for this run (tamper-evident).",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "event_id",
          "run_id",
          "event_type",
          "timestamp",
          "payload_hash_b64u",
          "prev_hash_b64u",
          "event_hash_b64u"
        ],
        "properties": {
          "event_id": { "type": "string", "minLength": 1 },
          "run_id": { "type": "string", "minLength": 1 },
          "event_type": { "type": "string", "minLength": 1 },
          "timestamp": { "type": "string", "format": "date-time" },
          "payload_hash_b64u": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 8,
            "description": "Hash of the event payload bytes, base64url (no padding)."
          },
          "prev_hash_b64u": {
            "type": ["string", "null"],
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 8,
            "description": "Previous event hash (base64url) or null for the first event."
          },
          "event_hash_b64u": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 8,
            "description": "Hash of the canonical event header, base64url (no padding)."
          }
        }
      }
    },
    "receipts": {
      "type": "array",
      "minItems": 1,
      "description": "Gateway receipt envelopes (proof-of-harness). Expected to be SignedEnvelope<GatewayReceiptPayload>.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "envelope_version",
          "envelope_type",
          "payload",
          "payload_hash_b64u",
          "hash_algorithm",
          "signature_b64u",
          "algorithm",
          "signer_did",
          "issued_at"
        ],
        "properties": {
          "envelope_version": { "const": "1" },
          "envelope_type": { "const": "gateway_receipt" },
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "receipt_version",
              "receipt_id",
              "gateway_id",
              "provider",
              "model",
              "request_hash_b64u",
              "response_hash_b64u",
              "tokens_input",
              "tokens_output",
              "latency_ms",
              "timestamp"
            ],
            "properties": {
              "receipt_version": { "const": "1" },
              "receipt_id": { "type": "string", "minLength": 1 },
              "gateway_id": { "type": "string", "minLength": 1 },
              "provider": { "type": "string", "minLength": 1 },
              "model": { "type": "string", "minLength": 1 },
              "request_hash_b64u": {
                "type": "string",
                "pattern": "^[A-Za-z0-9_-]+$",
                "minLength": 8,
                "description": "SHA-256 hash of request bytes, base64url (no padding)."
              },
              "response_hash_b64u": {
                "type": "string",
                "pattern": "^[A-Za-z0-9_-]+$",
                "minLength": 8,
                "description": "SHA-256 hash of response bytes, base64url (no padding)."
              },
              "tokens_input": { "type": "number", "minimum": 0 },
              "tokens_output": { "type": "number", "minimum": 0 },
              "latency_ms": { "type": "number", "minimum": 0 },
              "timestamp": { "type": "string", "format": "date-time" },
              "binding": { "$ref": "https://schemas.clawbureau.org/claw.poh.receipt_binding.v1.json" },
              "metadata": {
                "type": "object",
                "description": "Optional receipt metadata. These fields are signed as part of the receipt payload but must not be interpreted as stronger guarantees than their tier semantics.",
                "properties": {
                  "model_identity": {
                    "$ref": "https://schemas.clawbureau.org/claw.poh.model_identity.v1.json"
                  },
                  "model_identity_hash_b64u": {
                    "type": "string",
                    "pattern": "^[A-Za-z0-9_-]+$",
                    "minLength": 8,
                    "description": "sha256_b64u(JCS(model_identity)) for stable deduping."
                  },
                  "audit_result_refs": {
                    "type": "array",
                    "description": "Optional references to audit_result_attestation artifacts that cover this output.",
                    "items": {
                      "type": "object",
                      "additionalProperties": false,
                      "required": ["resource_hash_b64u"],
                      "properties": {
                        "resource_type": { "type": "string" },
                        "resource_hash_b64u": {
                          "type": "string",
                          "pattern": "^[A-Za-z0-9_-]+$",
                          "minLength": 8
                        },
                        "uri": { "type": "string" }
                      }
                    }
                  }
                },
                "additionalProperties": true
              }
            }
          },
          "payload_hash_b64u": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 8
          },
          "hash_algorithm": {
            "type": "string",
            "enum": ["SHA-256", "BLAKE3"]
          },
          "signature_b64u": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 8
          },
          "algorithm": {
            "type": "string",
            "enum": ["Ed25519"]
          },
          "signer_did": {
            "type": "string",
            "pattern": "^did:",
            "description": "Receipt signer DID. Must start with 'did:'."
          },
          "issued_at": { "type": "string", "format": "date-time" }
        }
      }
    },
    "tool_receipts": {
      "type": "array",
      "description": "Tool receipt payloads (Coverage MT). Raw ToolReceiptPayload objects — not envelope-wrapped.",
      "items": {
        "type": "object",
        "required": ["receipt_version", "receipt_id", "tool_name", "hash_algorithm", "agent_did", "timestamp"],
        "properties": {
          "receipt_version": { "const": "1" },
          "receipt_id": { "type": "string", "minLength": 1 },
          "tool_name": { "type": "string", "minLength": 1 },
          "tool_version": { "type": "string" },
          "args_hash_b64u": { "type": "string", "minLength": 1 },
          "args_digest": { "type": "string", "minLength": 1 },
          "result_hash_b64u": { "type": "string", "minLength": 1 },
          "result_digest": { "type": "string", "minLength": 1 },
          "result_status": { "type": "string" },
          "hash_algorithm": { "type": "string", "enum": ["SHA-256", "BLAKE3"] },
          "duration_ms": { "type": "number", "minimum": 0 },
          "latency_ms": { "type": "number", "minimum": 0 },
          "agent_did": { "type": "string", "pattern": "^did:" },
          "timestamp": { "type": "string", "format": "date-time" },
          "binding": { "type": "object" }
        }
      }
    },
    "side_effect_receipts": {
      "type": "array",
      "description": "Side-effect receipt payloads (Coverage MTS). Raw SideEffectReceiptPayload objects.",
      "items": {
        "type": "object",
        "required": ["receipt_version", "receipt_id", "effect_class", "hash_algorithm", "agent_did", "timestamp"],
        "properties": {
          "receipt_version": { "const": "1" },
          "receipt_id": { "type": "string", "minLength": 1 },
          "effect_class": { "type": "string", "enum": ["network_egress", "filesystem_write", "external_api_write"] },
          "target_digest": { "type": "string" },
          "request_digest": { "type": "string" },
          "response_digest": { "type": "string" },
          "hash_algorithm": { "type": "string", "enum": ["SHA-256", "BLAKE3"] },
          "vendor_id": { "type": "string" },
          "bytes_written": { "type": "number", "minimum": 0 },
          "agent_did": { "type": "string", "pattern": "^did:" },
          "timestamp": { "type": "string", "format": "date-time" },
          "binding": { "type": "object" }
        }
      }
    },
    "human_approval_receipts": {
      "type": "array",
      "description": "Human approval receipt payloads (Coverage MTS). Raw HumanApprovalReceiptPayload objects.",
      "items": {
        "type": "object",
        "required": ["receipt_version", "receipt_id", "approval_type", "agent_did", "timestamp"],
        "properties": {
          "receipt_version": { "const": "1" },
          "receipt_id": { "type": "string", "minLength": 1 },
          "approval_type": { "type": "string", "enum": ["explicit_approve", "explicit_deny", "auto_approve", "timeout_deny"] },
          "scope_hash_b64u": { "type": "string" },
          "plan_hash_b64u": { "type": "string" },
          "approver_subject": { "type": "string" },
          "capability_minted": { "type": "boolean" },
          "policy_hash_b64u": { "type": "string" },
          "agent_did": { "type": "string", "pattern": "^did:" },
          "timestamp": { "type": "string", "format": "date-time" },
          "binding": { "type": "object" }
        }
      }
    },
    "delegation_receipts": {
      "type": "array",
      "description": "Delegation receipt payloads for multi-agent orchestration (Merkle DAG). Each receipt links to a delegate agent's proof bundle by hash, enabling strict liability cascade verification.",
      "items": {
        "type": "object",
        "required": ["receipt_version", "receipt_id", "delegator_did", "delegate_did", "task_description_hash_b64u", "delegate_bundle_hash_b64u", "hash_algorithm", "delegated_at"],
        "properties": {
          "receipt_version": { "const": "1" },
          "receipt_id": { "type": "string", "minLength": 1 },
          "delegator_did": { "type": "string", "pattern": "^did:" },
          "delegate_did": { "type": "string", "pattern": "^did:" },
          "task_description_hash_b64u": { "type": "string", "pattern": "^[A-Za-z0-9_-]+$", "minLength": 8 },
          "delegate_bundle_hash_b64u": { "type": "string", "pattern": "^[A-Za-z0-9_-]+$", "minLength": 8, "description": "SHA-256 hash of the delegate agent's proof_bundle -- creates the Merkle DAG link." },
          "delegation_policy": { "type": "string", "description": "Policy constraints passed to delegate (hash of WPC subset)." },
          "hash_algorithm": { "type": "string", "enum": ["SHA-256", "BLAKE3"] },
          "delegated_at": { "type": "string", "format": "date-time" },
          "completed_at": { "type": "string", "format": "date-time" },
          "binding": { "type": "object" }
        }
      }
    },
    "attestations": {
      "type": "array",
      "minItems": 1,
      "description": "Attestation references used for trust tier computation.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "attestation_id",
          "attestation_type",
          "attester_did",
          "subject_did",
          "signature_b64u"
        ],
        "properties": {
          "attestation_id": { "type": "string", "minLength": 1 },
          "attestation_type": { "type": "string", "enum": ["owner", "third_party"] },
          "attester_did": { "type": "string", "pattern": "^did:" },
          "subject_did": { "type": "string", "pattern": "^did:" },
          "expires_at": { "type": "string", "format": "date-time" },
          "signature_b64u": {
            "type": "string",
            "pattern": "^[A-Za-z0-9_-]+$",
            "minLength": 8
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional bundle metadata. SHOULD include harness info for auditability.",
      "properties": {
        "harness": {
          "type": "object",
          "description": "Harness metadata identifying the runtime that produced this bundle.",
          "required": ["id", "version"],
          "properties": {
            "id": {
              "type": "string",
              "minLength": 1,
              "description": "Harness identifier (e.g. openclaw, pi, claude-code, codex, opencode, factory-droid, script)."
            },
            "version": {
              "type": "string",
              "minLength": 1,
              "description": "Harness version string."
            },
            "runtime": {
              "type": "string",
              "description": "Execution environment (host, docker, clawea, tee)."
            },
            "config_hash_b64u": {
              "type": "string",
              "pattern": "^[A-Za-z0-9_-]+$",
              "minLength": 8,
              "description": "Hash of the harness config inputs, base64url (no padding)."
            }
          }
        }
      }
    }
  },
  "anyOf": [
    { "required": ["urm"] },
    { "required": ["event_chain"] },
    { "required": ["receipts"] },
    { "required": ["tool_receipts"] },
    { "required": ["side_effect_receipts"] },
    { "required": ["human_approval_receipts"] },
    { "required": ["delegation_receipts"] },
    { "required": ["attestations"] }
  ]
}
