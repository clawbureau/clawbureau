{
  "project": "clawbureau",
  "branchName": "ralph/clawledger-phase1-trust",
  "description": "clawledger.com (Ledger) \u2014 PRD \u2014 Event-sourced ledger for balances, holds, and transfers. Idempotent and auditable.",
  "userStories": [
    {
      "id": "CLD-US-001",
      "title": "Create accounts",
      "description": "As a user, I want a balance account so that I can receive credits.",
      "acceptanceCriteria": [
        "Create account on first use",
        "Enforce unique DID",
        "Return current balance",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in services/ledger with D1 + Cloudflare Workers"
    },
    {
      "id": "CLD-US-002",
      "title": "Ledger event writes",
      "description": "As a system, I want append-only events so that audits are possible.",
      "acceptanceCriteria": [
        "Event types: mint/burn/transfer/hold/release",
        "Idempotency key required",
        "Write hash to clawlogs",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented event system with hash chain, idempotency keys, and API endpoints"
    },
    {
      "id": "CLD-US-003",
      "title": "Hold/Release support",
      "description": "As a escrow, I want to lock funds so that payments are safe.",
      "acceptanceCriteria": [
        "Create hold event",
        "Release or cancel hold",
        "Prevent negative balances",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented holds with create/release API, balance validation, and D1 migration"
    },
    {
      "id": "CLD-US-004",
      "title": "Balance reconciliation",
      "description": "As a operator, I want ledger replay checks so that bugs are caught.",
      "acceptanceCriteria": [
        "Nightly replay job",
        "Alert on mismatch",
        "Export report",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Implemented nightly cron job (2 AM UTC), event replay with balance comparison, hash chain verification, alert webhooks, and export endpoint"
    },
    {
      "id": "CLD-US-005",
      "title": "Reserve attestation",
      "description": "As a auditor, I want reserve coverage reports so that credits are trusted.",
      "acceptanceCriteria": [
        "Compute reserves/outstanding",
        "Signed attestation",
        "Public endpoint",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Implemented reserve attestation with GET /attestation/reserve endpoint, net minted calculation, balance hash verification, and hash-based signature"
    },
    {
      "id": "CLD-US-006",
      "title": "API access",
      "description": "As a platform, I want ledger APIs so that I can integrate.",
      "acceptanceCriteria": [
        "GET /balances",
        "POST /transfers",
        "Webhook for events",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Implemented GET /balances with pagination/filtering, POST /transfers with validation and balance updates, and webhook notifications via EVENT_WEBHOOK_URL"
    },
    {
      "id": "CLD-US-007",
      "title": "Balance buckets & invariants",
      "description": "As a system, I want balance buckets so that holds, stakes, and fees are explicit.",
      "acceptanceCriteria": [
        "Track buckets: available (A), held (H), bonded (B), fee pool (F), promo (P)",
        "Enforce non-negative balances per bucket",
        "Expose balances per bucket in API responses",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented bucket-level operations (credit/debit) for all five buckets with non-negative enforcement via InsufficientFundsError. Added generic creditBucket/debitBucket and moveBetweenBuckets methods. API responses already expose per-bucket balances in AccountResponse."
    },
    {
      "id": "CLD-US-008",
      "title": "Stake/fee event types",
      "description": "As a platform, I want explicit stake and fee events so that audits are deterministic.",
      "acceptanceCriteria": [
        "Support event types: stake_lock, stake_slash, fee_burn, fee_transfer, promo_mint, promo_burn",
        "Link stake/fee events to originating escrow/trial ids",
        "Emit hash-chained log entry for each event",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented stake_lock, stake_slash, fee_burn, fee_transfer, promo_mint, promo_burn event types with metadata for escrow/trial/campaign linking. Hash-chained events via StakeFeeService. API endpoints at /stake/lock, /stake/slash, /fees/burn, /fees/transfer, /promo/mint, /promo/burn."
    },
    {
      "id": "CLD-US-009",
      "title": "Clearing accounts & settlement refs",
      "description": "As a finance operator, I want clearing accounts so that cross-service settlement is clean.",
      "acceptanceCriteria": [
        "Create per-domain clearing accounts",
        "Allow transfers between user accounts and clearing accounts",
        "Store netting batch ids on settlement events",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Implemented per-domain clearing accounts with ClearingAccountRepository. Added clearing_deposit, clearing_withdraw, settlement event types. Settlements require batchId for netting references. API endpoints: POST/GET /clearing/accounts, POST /clearing/deposit, POST /clearing/withdraw, POST /settlements."
    },
    {
      "id": "CLD-US-010",
      "title": "Reserve asset registry",
      "description": "As a auditor, I want reserve asset tables so that coverage is verifiable.",
      "acceptanceCriteria": [
        "Store reserve assets with haircut factors",
        "Compute coverage ratio from eligible reserves only",
        "Include reserve breakdown in signed attestation",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "CLD-US-011",
      "title": "Compute reserve assets",
      "description": "As a finance operator, I want compute reserves so that credits are backed.",
      "acceptanceCriteria": [
        "Record Gemini/FAL credit balances as reserve assets",
        "Apply conservative haircuts by provider",
        "Include compute reserves in coverage attestations",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    }
  ]
}
