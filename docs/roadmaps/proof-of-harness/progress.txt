## Codebase Patterns
- Roadmap workstreams can be tracked with a Ralph-style `prd.json` + `progress.txt` under `docs/roadmaps/<topic>/`.
- Proof-of-harness (PoH) in this repo is modeled as: URM reference + hash-linked event chain + gateway receipts + optional attestations.
- clawbounties should gate automation (auto-approval, lower stake) on PoH tiers, not on self-asserted harness metadata.
- clawproxy already supports receipt binding headers: X-Run-Id, X-Event-Hash, X-Idempotency-Key.

# Ralph Progress Log
Started: 2026-02-05T21:49:28Z
---

## 2026-02-05T21:49:28Z - POH-US-001 (planning)
- What was implemented
  - Added a new roadmap PRD at `docs/roadmaps/proof-of-harness/prd.json`.
  - Created `docs/roadmaps/proof-of-harness/progress.txt` for tracking.
  - Drafted the Proof-of-Harness Adapter Spec v1 (see `ADAPTER_SPEC_v1.md`).
- Files changed
  - docs/roadmaps/proof-of-harness/prd.json
  - docs/roadmaps/proof-of-harness/progress.txt
  - docs/roadmaps/proof-of-harness/ADAPTER_SPEC_v1.md
- **Learnings for future iterations:**
  - Current `clawverify` ProofBundlePayload exists as TypeScript types but the corresponding JSON schema files are not yet in `packages/schema/poh/`.
  - Current `clawproxy` receipt format is not yet the same as `clawverify`'s `SignedEnvelope<GatewayReceiptPayload>`; we need to reconcile formats before we can claim `gateway` tier end-to-end.
---

## 2026-02-05T22:10:00Z - POH-US-002
- What was implemented
  - Added PoH payload schemas under `packages/schema/poh/`:
    - proof_bundle.v1.json
    - event_chain.v1.json
    - urm.v1.json
    - execution_attestation.v1.json
  - Updated `packages/schema/README.md` to list the new PoH schemas.
- Files changed
  - packages/schema/poh/proof_bundle.v1.json
  - packages/schema/poh/event_chain.v1.json
  - packages/schema/poh/urm.v1.json
  - packages/schema/poh/execution_attestation.v1.json
  - packages/schema/README.md
  - services/clawverify/src/types.ts
  - services/clawverify/src/schema-registry.ts
  - services/clawverify/src/schema-docs.ts
  - proofs/ralph/proof-of-harness-schemas/commit.sig.json
- **Learnings for future iterations:**
  - The JSON schemas encode the *intended* receipt envelope shape (SignedEnvelope<GatewayReceiptPayload>), but clawproxy currently emits a different receipt structure; POH-US-003/004 must reconcile this before we can derive `gateway` tier deterministically.
---

## 2026-02-06T02:09:00Z - POH-US-003
- What was implemented
  - Tightened `clawverify` proof bundle verification to be schema-aligned and fail-closed.
  - Event chain validation now enforces run_id consistency and prev_hash linkage.
  - Receipt verification inside proof bundles is upgraded from structural checks to full cryptographic verification via `verifyReceipt`.
- Files changed
  - services/clawverify/src/verify-proof-bundle.ts
  - services/clawverify/src/types.ts
- **Learnings for future iterations:**
  - Receipt verification currently assumes `SignedEnvelope<GatewayReceiptPayload>` (and `did:key` extraction); clawproxy output still needs to be unified before `gateway` tier can be reliably derived.
---

## 2026-02-06T02:17:00Z - POH-US-004
- What was implemented
  - Standardized and documented receipt binding fields + headers (run_id/event_hash/idempotency) in the adapter spec and clawproxy skill docs.
  - Added `receipt_binding.v1.json` schema and extended `proof_bundle.v1.json` to carry `payload.binding` and `metadata.harness` for auditability.
  - Added corresponding TS types in `clawverify` (`ReceiptBinding`, `HarnessMetadata`, `ProofBundleMetadata`).
- Files changed
  - packages/schema/poh/receipt_binding.v1.json
  - packages/schema/poh/proof_bundle.v1.json
  - packages/schema/README.md
  - docs/roadmaps/proof-of-harness/ADAPTER_SPEC_v1.md
  - services/clawproxy/src/index.ts
  - services/clawverify/src/types.ts
- **Learnings for future iterations:**
  - Keep schema docs (`services/clawverify/src/schema-docs.ts`) in sync when adding new envelope types or PoH schema IDs.
---

## 2026-02-06T02:24:00Z - POH-US-005
- What was implemented
  - Added `@openclaw/provider-clawproxy`: an OpenClaw provider plugin that routes model calls through clawproxy.
  - Injects PoH binding headers (X-Run-Id, X-Event-Hash, X-Idempotency-Key) per call and collects `_receipt` artifacts.
- Files changed
  - packages/openclaw-provider-clawproxy/*
---

## 2026-02-06T02:33:00Z - POH-US-006
- What was implemented
  - Added a harness recorder to generate URM + hash-linked event chain and assemble/sign proof bundles for OpenClaw runs.
  - Implemented recorder crypto utilities (SHA-256 base64url hashing, did:key derivation, Ed25519 signing).
- Files changed
  - packages/openclaw-provider-clawproxy/src/recorder.ts
  - packages/openclaw-provider-clawproxy/src/crypto.ts
  - packages/openclaw-provider-clawproxy/src/types.ts
- **Learnings for future iterations:**
  - Bridging the current clawproxy `_receipt` into a `SignedEnvelope<GatewayReceiptPayload>` cannot produce a verifiable signature without clawproxy emitting the canonical envelope format; until then, receipt envelopes in bundles are best-effort placeholders.
---

## 2026-02-06T02:45:00Z - POH-US-007
- What was implemented
  - Added `@clawbureau/clawproof-adapters`: external harness adapters + wrapper scripts (Claude Code/Codex/Pi/Opencode/Factory Droid).
  - Adapters route LLM calls through clawproxy and output proof artifacts under `.clawproof/`.
- Files changed
  - packages/clawproof-adapters/*
---

## 2026-02-06T02:52:00Z - POH-US-008
- What was implemented
  - Added `@clawbureau/clawproof-sdk`: lightweight SDK for API scripts to emit PoH bundles (event chain + URM + receipts + agent signature).
  - Included a minimal example script.
- Files changed
  - packages/clawproof-sdk/*
---

## 2026-02-06T22:54:35Z - POH-US-009
- What was implemented
  - Updated `clawproxy` to emit canonical `_receipt_envelope` (SignedEnvelope<GatewayReceiptPayload>) alongside the legacy `_receipt`.
  - Receipt signer DID is now deterministic `did:key` derived from the `PROXY_SIGNING_KEY` public key and exposed via `/v1/did`.
  - Updated `clawverify` receipt verification to require a fail-closed signer allowlist (`GATEWAY_RECEIPT_SIGNER_DIDS`) and propagated it through:
    - POST /v1/verify/receipt
    - POST /v1/verify/bundle
    - POST /v1/verify/batch
    - POST /v1/verify/agent
  - Updated the OpenClaw provider and the `clawproof` SDK/adapters to prefer `_receipt_envelope` when present (fallback to legacy bridging).
- Files changed
  - services/clawproxy/src/crypto.ts
  - services/clawproxy/src/receipt.ts
  - services/clawproxy/src/types.ts
  - services/clawproxy/src/index.ts
  - services/clawverify/src/verify-receipt.ts
  - services/clawverify/src/verify-proof-bundle.ts
  - services/clawverify/src/verify-agent.ts
  - services/clawverify/src/verify-batch.ts
  - services/clawverify/src/index.ts
  - services/clawverify/wrangler.toml
  - packages/openclaw-provider-clawproxy/src/provider.ts
  - packages/openclaw-provider-clawproxy/src/recorder.ts
  - packages/openclaw-provider-clawproxy/src/types.ts
  - packages/clawproof-sdk/src/run.ts
  - packages/clawproof-sdk/src/types.ts
  - packages/clawproof-adapters/src/session.ts
  - packages/clawproof-adapters/src/types.ts
---

## 2026-02-07T15:52:00Z - POH-US-010
- What was implemented
  - Hardened clawverify proof-bundle receipt verification: gateway receipts now only count if they are cryptographically valid AND bound to the bundle’s event chain (`binding.run_id` + `binding.event_hash_b64u`).
  - This prevents signature-valid receipts from being replayed across unrelated bundles to obtain gateway tier.
- Files changed
  - services/clawverify/src/verify-proof-bundle.ts
  - services/clawverify/src/types.ts
  - docs/roadmaps/proof-of-harness/prd.json
  - docs/roadmaps/proof-of-harness/progress.txt
---

## 2026-02-07T16:06:00Z - POH-US-011
- What was implemented
  - Wired commit proof verification for code bounties by documenting + configuring the `CLAWCLAIM_REPO_CLAIM_ALLOWLIST` allowlist.
  - Added a minimal smoke script to generate a `commit_proof` envelope and verify it via `POST /v1/verify/commit-proof`.
- Files changed
  - services/clawverify/wrangler.toml
  - packages/schema/poh/commit_proof.v1.json
  - docs/roadmaps/proof-of-harness/prd.json
  - docs/roadmaps/proof-of-harness/progress.txt
  - scripts/poh/smoke-commit-proof.mjs
  - proofs/fix/poh/POH-US-011-commit-proof-allowlist/commit.sig.json
---

## 2026-02-07T18:54:04Z - POH-US-012
- What was implemented
  - Added a local shim HTTP server to `@clawbureau/clawproof-adapters` so external harness CLIs can point provider base URLs at localhost while the shim forwards requests to `clawproxy` with PoH binding headers.
  - Updated external harness adapters to **not** overwrite upstream provider API keys with proxy tokens (the shim extracts upstream keys and forwards them via `X-Provider-API-Key`).
  - Added a canonical PoH harness registry (`docs/roadmaps/proof-of-harness/harnesses.mjs`) and a generated markdown doc (`HARNESS_REGISTRY.md`).
  - Added sync + validation scripts and a GitHub Actions workflow to keep the generated doc in sync.
- Files changed
  - packages/clawproof-adapters/src/shim.ts
  - packages/clawproof-adapters/src/cli.ts
  - packages/clawproof-adapters/src/adapters/*
  - docs/roadmaps/proof-of-harness/harnesses.mjs
  - docs/roadmaps/proof-of-harness/HARNESS_REGISTRY.md
  - scripts/poh/sync-harness-registry.mjs
  - scripts/poh/validate-harness-registry.mjs
  - .github/workflows/poh-harness-registry.yml
  - docs/roadmaps/proof-of-harness/ADAPTER_SPEC_v1.md
  - docs/roadmaps/proof-of-harness/prd.json
  - .gitignore
---

## 2026-02-10T13:30:00Z - POH-US-021
- What was implemented
  - Added job-scoped CST binding for CWC bounties to prevent receipt borrowing/transfer:
    - Marketplace stores expected `cwc_token_scope_hash_b64u` on bounty acceptance (deterministic v1 hash).
    - Marketplace issues a worker+job scoped CST from clawscope on accept (best-effort) and via `POST /v1/bounties/{id}/cst`.
    - Submission verification enforces `receipt.payload.binding.token_scope_hash_b64u` matches the expected value on all verified+run-bound receipts.
- Files changed
  - services/clawbounties/migrations/0011_cwc_job_cst.sql
  - services/clawbounties/src/index.ts
  - docs/roadmaps/proof-of-harness/oracle/2026-02-10/*
---

## 2026-02-10T17:30:00Z - POH-US-022
- What was implemented
  - Generalized job-scoped CST binding beyond CWC bounties (receipt non-transferability):
    - Added `job_token_scope_hash_b64u` on bounties (deterministic v1 hash) for non-CWC jobs.
    - Acceptance now computes/persists expected job token scope hash for bounties with `min_proof_tier != self`.
    - `POST /v1/bounties/{id}/cst` now supports non-CWC bounties and returns `job_auth` (while CWC continues to return `cwc_auth`).
    - Submission verification enforces `binding.token_scope_hash_b64u` matches the stored expected job hash for non-CWC bounties (when configured).
  - Updated harness tooling to accept both marketplace CST response shapes:
    - `@clawbureau/clawproof-adapters` CLI accepts `job_auth.cst` or `cwc_auth.cst`.
    - `@openclaw/provider-clawproxy` auto-fetch accepts `job_auth` or `cwc_auth` and only overrides policy hash when the CST pins one.
  - Hardened smoke script assertions to validate deterministic `proof_bundle.reason` strings.
- Files changed
  - services/clawbounties/migrations/0012_job_cst_binding.sql
  - services/clawbounties/src/index.ts
  - packages/clawproof-adapters/src/cli.ts
  - packages/openclaw-provider-clawproxy/src/index.ts
  - scripts/poh/smoke-cwc-job-cst-binding.mjs
---

## 2026-02-10T20:50:00Z - PoH vNext (model identity + verifiable audits) (planning)
- What was updated
  - Added PoH vNext docs:
    - `docs/roadmaps/proof-of-harness/DESIGN_model-identity-and-verifiable-audits.md`
    - `docs/roadmaps/proof-of-harness/ROADMAP_vNext.md`
    - `docs/roadmaps/proof-of-harness/PHASE0_PR_STACK.md`
  - Added ADR for deterministic audit pack hashing (policy gating):
    - `docs/foundations/decisions/0001-audit-pack-convention.md`
  - Added new PoH vNext schemas:
    - `packages/schema/poh/model_identity.v1.json`
    - `packages/schema/poh/derivation_attestation.v1.json`
    - `packages/schema/poh/audit_result_attestation.v1.json`
    - `packages/schema/poh/log_inclusion_proof.v1.json`
  - Updated PoH spec and tracker:
    - `docs/roadmaps/proof-of-harness/ADAPTER_SPEC_v1.md` (trust vector semantics + canonical receipts + model identity)
    - `docs/roadmaps/proof-of-harness/prd.json` (added POHVN-US-001..008)
- Notes
  - Closed provider APIs cannot prove weight identity; `model_identity.tier=closed_opaque` encodes this explicitly.
  - PoH tiers remain unchanged; model identity is an orthogonal axis.
---

## 2026-02-10T22:50:00Z - POHVN-US-001 (model identity axis) (implemented)
- What was implemented
  - clawproxy emits `payload.metadata.model_identity` + `payload.metadata.model_identity_hash_b64u` on every gateway receipt.
  - clawverify validates the model identity object + hash and surfaces `model_identity_tier` + deterministic `risk_flags` on verify outputs.
  - Tripwire smoke asserts end-to-end behavior (clawproxy→fal(OpenRouter)→clawverify) including:
    - receipt metadata fields
    - model identity hash correctness (JCS)
    - clawverify returning `model_identity_tier`
- PRs
  - PR #97: CPX-US-016 receipt metadata emission
  - PR #98: tripwire asserts model identity metadata + hash
  - PR #99: CVF-US-016 model identity tier verification
---
