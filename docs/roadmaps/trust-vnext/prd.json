{
  "name": "clawbureau-trust-vnext",
  "project": "clawbureau",
  "description": "Trust vNext: verifier hardening, anti-replay, prompt integrity commitments, confidential consulting contracts/policies, sandbox attestations, and witnessed-web strategy.",
  "branchName": "ralph/trust-vnext",
  "userStories": [
    {
      "id": "CVF-US-021",
      "title": "Recompute event hashes in clawverify (fail-closed)",
      "description": "As a verifier, I want clawverify to recompute event hashes from canonical event headers so that tampered event chains cannot be used to claim higher trust tiers.",
      "acceptanceCriteria": [
        "For every event in event_chain, recompute event_hash_b64u per docs/roadmaps/proof-of-harness/ADAPTER_SPEC_v1.md",
        "Reject proof bundles where any event_hash_b64u mismatches the recomputed value",
        "Reject proof bundles where chain root no longer matches after recomputation",
        "Add unit tests covering tamper cases"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented recomputation of event_hash_b64u from canonical headers in services/clawverify/src/verify-proof-bundle.ts and added vitest coverage for tamper cases."
    },
    {
      "id": "CVF-US-022",
      "title": "Enforce envelope signer DID equals payload agent DID",
      "description": "As a verifier, I want the proof bundle envelope signer DID to match payload.agent_did so authorship/accountability cannot be swapped.",
      "acceptanceCriteria": [
        "If envelope.signer_did !== payload.agent_did, verification fails",
        "Add tests for mismatch cases"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented fail-closed check in services/clawverify/src/verify-proof-bundle.ts: envelope.signer_did must equal payload.agent_did. Added unit test coverage."
    },
    {
      "id": "CVF-US-023",
      "title": "Disable attestation tier uplift until signatures are verified",
      "description": "As a marketplace, I want attestations to only affect trust tiers when they are cryptographically verified against an allowlist of attesters.",
      "acceptanceCriteria": [
        "If attestations are present but not signature-verified, they do not increase trust tier",
        "Add an allowlist mechanism for attester DIDs (similar to gateway receipt signer allowlist)",
        "Add tests for shape-only attestations"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented allowlisted signature verification for proof bundle attestations (attester allowlist + JCS canonicalization + Ed25519). Added Env config ATTESTATION_SIGNER_DIDS and unit tests to ensure shape-only attestations do not uplift trust_tier."
    },
    {
      "id": "CVF-US-024",
      "title": "Strict JSON schema validation (Ajv) for proof bundles + receipts",
      "description": "As a verifier, I want strict schema validation so unknown fields, missing required fields, and type mismatches fail closed.",
      "acceptanceCriteria": [
        "Validate proof bundles, receipts, URM, and attestations using Ajv against schemas in packages/schema",
        "Fail closed on additionalProperties violations",
        "Return deterministic error codes for schema failures"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Added Ajv (draft 2020-12) schema validation for proof bundle envelopes and gateway receipt envelopes using schemas in packages/schema. Implemented Workers-safe Ajv *standalone* validators (no runtime new Function) and fail-closed SCHEMA_VALIDATION_FAILED errors with field paths derived from Ajv errors. Added unit tests for unknown-field rejection."
    },
    {
      "id": "CVF-US-025",
      "title": "Receipt numeric + size hardening",
      "description": "As a verifier, I want receipt fields to be strictly validated (finite numbers, bounded sizes) so attackers cannot bypass checks with NaN/Infinity or DoS the verifier.",
      "acceptanceCriteria": [
        "Reject NaN/Infinity/non-finite numeric fields (tokens, latency, etc.)",
        "Enforce max counts and byte-size limits for events/receipts/metadata",
        "Enforce uniqueness constraints for event_id and receipt_id within a bundle",
        "Add tests for edge cases"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Hardened receipt numeric validation (finite + integer + bounds) and proof bundle validation (max counts, metadata byte-size limits, and uniqueness checks for event_id + receipt_id). Added unit tests for Infinity/non-integer receipts, duplicate IDs, and oversized metadata."
    },
    {
      "id": "POH-US-013",
      "title": "Align trust tier semantics across PoH + marketplace",
      "description": "As a platform, I want consistent tier naming/meaning across clawverify outputs and marketplace requirements so automation gates are coherent.",
      "acceptanceCriteria": [
        "Define canonical tier labels (self, gateway-receipted, sandbox-attested, tee-attested, witnessed-web)",
        "clawverify outputs the canonical tier (or components + derived tier)",
        "docs/specs/agent-economy/MVP.md references the same tier definitions"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Added canonical marketplace-facing `proof_tier` to clawverify (bundle + agent endpoints) with aligned numeric `poh_tier` mapping (unknown=0, self=1, gateway=2, sandbox=3, tee=4, witnessed_web=5). Updated Agent Economy MVP spec tier definitions and added tests for gateway-tier bundles."
    },
    {
      "id": "CPX-US-031",
      "title": "Durable idempotency store for clawproxy",
      "description": "As a gateway, I want idempotency to be durable across instances so receipts cannot be replayed or duplicated across deploys.",
      "acceptanceCriteria": [
        "Replace in-memory idempotency with durable storage (KV/DO/D1/etc.)",
        "Same nonce returns same response/receipt only if request fingerprint matches",
        "Same nonce with different fingerprint fails closed",
        "Add tests for cross-instance semantics"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Replaced in-memory nonce cache with a per-nonce Durable Object idempotency store. Requests compute a stable fingerprint (provider URL + request body + binding fields + payment mode). Same nonce+fingerprint replays the stored response; different fingerprints fail closed; concurrent in-flight reuse returns 409. Added unit tests exercising lock/commit/replay/mismatch and simulated restart persistence."
    },
    {
      "id": "POH-US-014",
      "title": "Marketplace replay database",
      "description": "As a marketplace, I want to reject duplicate submissions that reuse run_id or receipt_id so trust tiers cannot be inflated via replay.",
      "acceptanceCriteria": [
        "Persist seen (agent_did, run_id) pairs and reject duplicates",
        "Persist seen (receipt_signer_did, receipt_id) pairs and reject duplicates",
        "Return deterministic error codes for replay rejection"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented a marketplace replay DB in services/clawbounties: D1 migration adds replay_runs (agent_did, run_id) and replay_receipts (receipt_signer_did, receipt_id) with PK uniqueness. Submission handler reserves these keys for proof-bundle-VALID submissions and rejects duplicates with deterministic error codes (REPLAY_RUN_ID_REUSED / REPLAY_RECEIPT_ID_REUSED)."
    },
    {
      "id": "POH-US-015",
      "title": "URM materialization + CAS retrieval contract",
      "description": "As a verifier, I want URM bytes to be retrievable and hash-verified so URM references are meaningful and fail-closed.",
      "acceptanceCriteria": [
        "Verification either includes URM bytes or fetches them by URI",
        "Verifier computes resource_hash_b64u and compares to proof bundle reference",
        "Fail closed if URM bytes are missing/unfetchable"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Implemented URM materialization verification in clawverify: /v1/verify/bundle now accepts an optional `urm` document and fail-closed rejects bundles that contain a URM reference without providing the URM bytes. The verifier validates the URM against the strict schema (Ajv standalone), recomputes the SHA-256 hash (base64url), enforces binding (urm_id + agent_did + run_id when event_chain is valid), and compares to payload.urm.resource_hash_b64u. Marketplace (clawbounties) now forwards `urm` to clawverify and requires it when proof_bundle_envelope.payload.urm is present."
    },
    {
      "id": "POH-US-016",
      "title": "Prompt commitment evidence (OpenClaw)",
      "description": "As a marketplace/verifier, I want prompt-pack commitments and per-call rendered system prompt hashes so replay means evidence re-validation (not token reproduction) and prompt injection risk is reduced.",
      "acceptanceCriteria": [
        "Compute a prompt_root_hash_b64u over prompt-pack inputs",
        "Record rendered_system_prompt_hash_b64u per llm_call",
        "Persist commitments in URM and/or proof bundle metadata",
        "Add tests for determinism of hashing/canonicalization"
      ],
      "priority": 10,
      "passes": false
    },
    {
      "id": "POH-US-017",
      "title": "New schema: system_prompt_report / prompt_pack",
      "description": "As a platform, I want versioned schemas for prompt commitments so they are verifiable and evolve safely.",
      "acceptanceCriteria": [
        "Add new schema(s) under packages/schema for prompt commitment objects",
        "Register schemas in clawverify schema registry",
        "Verifier validates prompt commitment objects when present"
      ],
      "priority": 11,
      "passes": false
    },
    {
      "id": "CPX-US-032",
      "title": "Strict auth header mode (CST vs provider keys)",
      "description": "As a gateway, I want unambiguous header rules so CSTs and provider API keys cannot be confused or exploited.",
      "acceptanceCriteria": [
        "Define a strict mode where CST must be in a canonical header (e.g. X-CST)",
        "Provider keys must be in X-Provider-API-Key",
        "Reject ambiguous/mixed Authorization usages in strict mode",
        "Document behavior in docs/prds/clawproxy.md"
      ],
      "priority": 12,
      "passes": false
    },
    {
      "id": "CCO-US-021",
      "title": "Work Policy Contract (WPC) registry API (signed policies)",
      "description": "As a platform, I want a signed policy registry so jobs can pin a WPC hash and gateways/verifiers can enforce it.",
      "acceptanceCriteria": [
        "Define a canonical WPC JSON shape + hashing (JCS + SHA-256)",
        "Implement create/read endpoints that return signed WPC envelopes",
        "Document how policy_hash is computed and validated"
      ],
      "priority": 13,
      "passes": false
    },
    {
      "id": "CWC-US-001",
      "title": "Confidential Work Contract (CWC) schema + signing",
      "description": "As a buyer and worker, I want a contract that pins tier requirements, egress limits, and policy hashes so confidential consulting is enforceable and verifiable.",
      "acceptanceCriteria": [
        "Define a versioned CWC schema (buyer signs, worker countersigns)",
        "CWC includes required tier, wpc_hash, disclosure/privacy mode, dispute terms",
        "Marketplace stores and enforces CWC hash at job post + submission time"
      ],
      "priority": 14,
      "passes": false
    },
    {
      "id": "CEA-US-010",
      "title": "clawea sandbox attestation MVP",
      "description": "As a verifier, I want allowlisted sandbox attestations so sandbox-enforced runs can lift trust tiers beyond gateway receipts.",
      "acceptanceCriteria": [
        "Produce a signed execution attestation object bound to run_id",
        "Verifier validates signature and attester DID allowlist",
        "Tier uplift only happens when attestation is valid"
      ],
      "priority": 15,
      "passes": false
    },
    {
      "id": "POH-US-018",
      "title": "Witnessed-web receipts for subscription/web auth",
      "description": "As a platform, I want a credible path for subscription-web usage evidence (ChatGPT/Claude/Gemini web) that does not rely on a workerâ€™s local machine.",
      "acceptanceCriteria": [
        "Define a web_receipt schema and signed envelope type",
        "Introduce an allowlisted witness service that can sign web receipts",
        "Verifier recognizes web_receipt but does not equate it to gateway API receipts by default"
      ],
      "priority": 16,
      "passes": false
    },
    {
      "id": "OCL-US-001",
      "title": "OpenClaw Airlock: trusted vs untrusted context partition",
      "description": "As a harness, I want buyer repos/uploads to be treated as untrusted data so they cannot modify system-prompt-authoritative context (bootstrap/skills/policy).",
      "acceptanceCriteria": [
        "Separate a trusted IdentityRoot (bootstrap/personality/skills) from an untrusted JobRoot (buyer repo/files)",
        "Disable bootstrap/skills auto-discovery for untrusted mounts in sensitive profiles",
        "Document the Airlock pattern in docs/integration/OPENCLAW_INTEGRATION.md"
      ],
      "priority": 17,
      "passes": false,
      "notes": "May require upstream OpenClaw changes or an extension/plugin that enforces mount/path allowlists."
    },
    {
      "id": "OCL-US-002",
      "title": "OpenClaw: role-based directive authorization (buyer cannot change security)",
      "description": "As an operator, I want directives (/elevated, /exec, /model, etc.) to be applied only by authorized roles so buyers cannot downgrade security posture via prompt injection.",
      "acceptanceCriteria": [
        "Introduce directive authorization by role (operator vs buyer)",
        "Buyer messages cannot apply directives that affect tool/sandbox/security",
        "Add regression tests for directive parsing and authorization"
      ],
      "priority": 18,
      "passes": false,
      "notes": "See docs/openclaw/9.3-directives.md + prompt-injection oracle outputs."
    },
    {
      "id": "OCL-US-003",
      "title": "OpenClaw: Sensitive Consulting Profile preset",
      "description": "As a worker, I want a one-click preset for sensitive consulting that is safe-by-default (sandboxed, minimal tools, no network) and produces verifiable evidence.",
      "acceptanceCriteria": [
        "Ship a preset that sets sandbox.mode=all and minimal tool profile",
        "Disable skill binary auto-allow (autoAllowBins) in the sensitive profile",
        "Default deny browser/web/tools/sessions/message and raw network",
        "Document the preset + intended trust tier mapping"
      ],
      "priority": 19,
      "passes": false
    },
    {
      "id": "POH-US-019",
      "title": "Streaming-safe shim for external harness CLIs",
      "description": "As an operator, I want the clawproof shim proxy to support streaming/SSE so external harnesses can reliably produce gateway-tier bundles.",
      "acceptanceCriteria": [
        "Shim forwards streaming responses without buffering entire bodies",
        "Receipts are extracted/attached in a deterministic way (e.g. final event or trailer object)",
        "Header injection (run_id/event_hash/idempotency) works for streaming flows",
        "Add smoke test coverage for at least one streaming harness/provider"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Implemented streaming pass-through in clawproxy + SSE trailer receipt comments; shim forwards SSE without buffering and captures receipts (with idempotency replay fallback)."
    },
    {
      "id": "POH-US-020",
      "title": "Pre-hash redaction middleware in PoH recorders/adapters",
      "description": "As a platform, we must redact secrets/PII before hashing event payloads or embedding URM metadata so proofs are safe to store/share and cannot leak credentials via future materialization/debugging.",
      "acceptanceCriteria": [
        "Implement a redaction utility (regex-based) ported from agentlog/redact.py",
        "clawproof-adapters recordEvent() redacts payload before computing payload_hash_b64u and event_hash_b64u",
        "OpenClaw recorder recordEvent() redacts payload before hashing",
        "URM metadata is redacted and bounded to verifier metadata limits",
        "Add unit tests covering common secret patterns (JWT, Bearer, sk-*, ghp_*, etc.)"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Implemented pre-hash redaction in packages/clawproof-adapters and packages/openclaw-provider-clawproxy (recorder). Added redaction utility modules and vitest coverage in clawproof-adapters. URM metadata is redacted and bounded to 16KB to avoid fail-closed verifier rejection."
    },
    {
      "id": "OCL-US-004",
      "title": "OpenClaw: Trust Pulse artifact + URM pointer (non-tier)",
      "description": "As a buyer and worker, I want a small, redacted, derived summary of run actions (tool names + file touches) visible for UX without exposing transcripts, and explicitly not affecting proof tiers.",
      "acceptanceCriteria": [
        "Generate a trust_pulse.v1 document (tools + relative file touches) as a self-reported artifact",
        "Attach a small pointer (schema + artifact hash + non-tier flags) into URM.metadata.trust_pulse",
        "Ensure no absolute paths or traversal segments are included in file paths",
        "Ensure trust pulse is bounded and redacted",
        "Verifier/marketplace must ignore trust pulse fields for proof tier computation"
      ],
      "priority": 22,
      "passes": true,
      "notes": "Added packages/schema/poh/trust_pulse.v1.json. The clawproof adapter session + OpenClaw recorder now generate a Trust Pulse document, attach a trust_pulse pointer in URM metadata, and include the trust pulse hash as a URM output resource (self-reported, tier_uplift=false)."
    },
    {
      "id": "AGL-US-001",
      "title": "agentlog: local PoH verification badge (verify command)",
      "description": "As an OpenClaw user, I want a local command that tells me whether a run is verifiably gateway-tier (or not) using PoH artifacts (bundle+URM+receipts), without uploading transcripts.",
      "acceptanceCriteria": [
        "Add an agentlog verify subcommand that verifies a proof bundle + URM against clawverify",
        "Fail closed when URM is missing, receipts are untrusted, or bindings are invalid",
        "Output derived-only status (no transcript content)"
      ],
      "priority": 23,
      "passes": true,
      "notes": "Implemented `agentlog verify` in /Users/gfw/code/agentlog/cli.py. The command discovers bundle+URM JSON artifacts (e.g. .clawproof/*-bundle.json + *-urm.json), calls clawverify /v1/verify/bundle with {envelope, urm}, and prints a derived-only VERIFIED/UNVERIFIED badge with proof_tier/trust_tier. Fail-closed on missing URM or verifier invalidation."
    }
  ],
  "metadata": {
    "updatedAt": "2026-02-09T16:40:00Z",
    "seededFrom": "docs/roadmaps/proof-of-harness/oracle/2026-02-07/next-building-blocks-plan.gpt-5.2-pro.md"
  }
}
