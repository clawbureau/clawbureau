Menu

## Telegram Integration

Relevant source files
- [docs/tools/slash-commands.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/tools/slash-commands.md)
- [src/auto-reply/command-detection.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/command-detection.ts)
- [src/auto-reply/commands-args.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/commands-args.ts)
- [src/auto-reply/commands-registry.data.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/commands-registry.data.ts)
- [src/auto-reply/commands-registry.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/commands-registry.test.ts)
- [src/auto-reply/commands-registry.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/commands-registry.ts)
- [src/auto-reply/commands-registry.types.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/commands-registry.types.ts)
- [src/auto-reply/group-activation.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/group-activation.ts)
- [src/auto-reply/reply.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/reply.ts)
- [src/auto-reply/reply/commands-info.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/reply/commands-info.test.ts)
- [src/auto-reply/reply/commands-info.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/reply/commands-info.ts)
- [src/auto-reply/reply/commands.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/reply/commands.ts)
- [src/auto-reply/reply/directive-handling.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/reply/directive-handling.ts)
- [src/auto-reply/send-policy.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/send-policy.ts)
- [src/auto-reply/status.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/status.test.ts)
- [src/auto-reply/status.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/status.ts)
- [src/auto-reply/templating.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/templating.ts)
- [src/config/config.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/config.ts)
- [src/discord/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/discord/monitor.ts)
- [src/discord/monitor/native-command.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/discord/monitor/native-command.ts)
- [src/imessage/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/imessage/monitor.ts)
- [src/signal/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/signal/monitor.ts)
- [src/slack/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/slack/monitor.ts)
- [src/slack/monitor/slash.command-arg-menus.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/slack/monitor/slash.command-arg-menus.test.ts)
- [src/slack/monitor/slash.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/slack/monitor/slash.ts)
- [src/telegram/bot-handlers.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-handlers.ts)
- [src/telegram/bot.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts)
- [src/telegram/bot.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts)
- [src/telegram/bot/types.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot/types.ts)
- [src/web/auto-reply.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/auto-reply.ts)
- [src/web/inbound.media.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/inbound.media.test.ts)
- [src/web/inbound.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/inbound.test.ts)
- [src/web/inbound.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/inbound.ts)
- [src/web/test-helpers.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/test-helpers.ts)
- [src/web/vcard.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/vcard.ts)

OpenClaw integrates with Telegram via the [grammY](https://grammy.dev/) framework, providing bot functionality with support for native commands, forum topics, media handling, and sophisticated message routing. This page covers the Telegram-specific channel adapter implementation.

For general channel concepts (routing, access control, session keys), see [Channel Routing and Access Control](https://deepwiki.com/openclaw/openclaw/8.1-channel-routing-and-access-control). For command system architecture, see [Commands and Directives](https://deepwiki.com/openclaw/openclaw/9-commands-and-directives).

---

## Architecture Overview

The Telegram integration implements a full-featured bot client with several key characteristics:

- **Sequential Processing**: Messages from the same chat/thread are processed sequentially using grammY's `sequentialize` middleware
- **API Throttling**: Automatic rate limiting via `apiThrottler` to comply with Telegram's rate limits
- **Update Deduplication**: Tracks recent updates to prevent duplicate processing
- **Forum Support**: Native handling of Telegram forum topics with independent session isolation
- **Native Commands**: Registers slash commands directly with Telegram's Bot API
- **Media Groups**: Buffers and processes photo/video albums as single messages
- **Text Fragments**: Detects and combines long messages split by Telegram clients

**Core Components Diagram**

```
Special HandlersMessage ProcessingHandler RegistrationMiddleware StackBot InitializationcreateTelegramBot()Bot
(grammY)API Client Config
(fetch, timeoutSeconds)apiThrottler
(rate limiting)sequentialize
(getTelegramSequentialKey)Raw Update Logger
(verbose mode)recordUpdateId
(offset tracking)shouldSkipUpdate
(deduplication)registerTelegramNativeCommands
(setMyCommands)bot.on('message')
(processMessage)bot.on('callback_query')
(inline buttons)bot.on('message_reaction')
(system events)bot.on('edited_message')
(processMessage)createTelegramMessageProcessorAccess Control
(DM/group policies)resolveMedia
(photos, videos, docs)resolveTelegramForumThreadId
(topic sessions)resolveAgentRoute
(session key)mediaGroupBuffer
(album batching)textFragmentBuffer
(message coalescing)inboundDebouncer
(rapid typing)
```

**Sources**: [src/telegram/bot.ts 109-471](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L109-L471) [src/telegram/bot-handlers.ts 26-190](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-handlers.ts#L26-L190)

---

## Bot Initialization

The `createTelegramBot` function creates a grammY `Bot` instance with OpenClaw-specific configuration:

**Sources**: [src/telegram/bot.ts 109-471](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L109-L471) [src/telegram/bot.test.ts 210-245](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L210-L245)

### Configuration Options

Key options passed to `createTelegramBot`:

| Option | Type | Purpose |
| --- | --- | --- |
| `token` | `string` | Telegram Bot API token (required) |
| `accountId` | `string` | Multi-account identifier (optional) |
| `runtime` | `RuntimeEnv` | Logger/error handlers |
| `requireMention` | `boolean` | Override group mention requirement |
| `allowFrom` | `string[]` | DM allowlist override |
| `groupAllowFrom` | `string[]` | Group allowlist override |
| `mediaMaxMb` | `number` | Media size limit (default: 5MB) |
| `replyToMode` | `ReplyToMode` | Threading behavior (`first` / `all` / `off`) |
| `proxyFetch` | `typeof fetch` | Custom fetch for proxying |
| `config` | `OpenClawConfig` | Full config object |
| `updateOffset.lastUpdateId` | `number` | Resume from update ID |
| `updateOffset.onUpdateId` | `callback` | Track latest processed update |

**Sources**: [src/telegram/bot.ts 50-65](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L50-L65)

### Account Resolution

The bot resolves its configuration from the multi-account system:

```
const account = resolveTelegramAccount({
  cfg,
  accountId: opts.accountId,
});
const telegramCfg = account.config; // TelegramChannelConfig
```

This allows multiple Telegram bots to run simultaneously with independent configurations. The account ID is used for allowlist storage, session routing, and command authorization.

**Sources**: [src/telegram/bot.ts 118-122](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L118-L122)

---

## Sequential Processing

Telegram messages are processed sequentially per chat/thread to prevent race conditions and maintain conversation order:

```
export function getTelegramSequentialKey(ctx: {
  chat?: { id?: number };
  message?: TelegramMessage;
  update?: { ... };
}): string {
  // Reaction updates use chat ID
  if (reaction?.chat?.id) {
    return \`telegram:${reaction.chat.id}\`;
  }
  
  const chatId = msg?.chat?.id ?? ctx.chat?.id;
  const rawText = msg?.text ?? msg?.caption;
  const botUsername = ctx.me?.username;
  
  // Control commands get dedicated key for fast-path processing
  if (rawText && isControlCommandMessage(rawText, undefined, { botUsername })) {
    return \`telegram:${chatId}:control\`;
  }
  
  // Forum topics get separate keys
  const isGroup = msg?.chat?.type === "group" || msg?.chat?.type === "supergroup";
  const messageThreadId = msg?.message_thread_id;
  const isForum = msg?.chat?.is_forum;
  const threadId = isGroup
    ? resolveTelegramForumThreadId({ isForum, messageThreadId })
    : messageThreadId;
  
  if (typeof chatId === "number") {
    return threadId != null 
      ? \`telegram:${chatId}:topic:${threadId}\` 
      : \`telegram:${chatId}\`;
  }
  
  return "telegram:unknown";
}
```

**Sequentialization Keys**:

- `telegram:{chatId}` - Private chats
- `telegram:{chatId}:topic:{threadId}` - Private chat threads OR forum topics
- `telegram:{chatId}:control` - Control commands (fast path)
- `telegram:unknown` - Fallback

**Sources**: [src/telegram/bot.ts 67-107](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L67-L107) [src/telegram/bot.test.ts 335-361](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L335-L361)

---

## Update Deduplication

Telegram may deliver duplicate updates during reconnections or network issues. OpenClaw tracks recent updates to prevent reprocessing:

```
newduplicateTelegram UpdatebuildTelegramUpdateKey
(update_id, message_id, chat_id)recentUpdates.check(key)Process UpdateSkip (already seen)recordUpdateId
(save lastUpdateId)
```

The deduplication logic uses:

- `resolveTelegramUpdateId(ctx)` - Extract update ID from context
- `buildTelegramUpdateKey(ctx)` - Generate composite key from update
- `createTelegramUpdateDedupe()` - In-memory recent-update cache

Updates are skipped if:

1. `update_id <= lastUpdateId` (already processed by offset)
2. The update key was seen recently (within cache window)

**Sources**: [src/telegram/bot.ts 155-178](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L155-L178) [src/telegram/bot-updates.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-updates.ts)

---

## Forum and Topic Support

Telegram forums (supergroups with `is_forum=true`) have multiple independent topic threads. OpenClaw treats each topic as a separate session:

### Topic ID Resolution

```
export function resolveTelegramForumThreadId(params: {
  isForum?: boolean;
  messageThreadId?: number;
}): number | undefined {
  // Forums: use threadId, default to General (1) if missing
  if (params.isForum) {
    return params.messageThreadId ?? 1;
  }
  // Non-forums: no topic isolation
  return undefined;
}
```

**Session Key Patterns**:

- Forum topic: `agent:{agentId}:telegram:group:{chatId}:{topicId}`
- Regular group: `agent:{agentId}:telegram:group:{chatId}`
- Private thread: `agent:{agentId}:telegram:dm:{chatId}:thread:{threadId}`

The topic configuration hierarchy:

1. `channels.telegram.groups[chatId].topics[topicId]` - Topic-specific config
2. `channels.telegram.groups[chatId]` - Group-level config
3. `channels.telegram` - Global Telegram config

**Sources**: [src/telegram/bot/helpers.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot/helpers.ts) [src/telegram/bot.ts 315-323](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L315-L323)

---

## Native Commands

OpenClaw registers slash commands with Telegram's Bot API via `setMyCommands`:

```
Command HandlingCommand Registrationregistersmenu neededcompletelistNativeCommandSpecsForConfig
(filter enabled commands)listSkillCommandsForAgents
(user-invocable skills)telegramCfg.customCommandsCheck for collisions
(custom vs native)bot.api.setMyCommands
(Telegram API)bot.command(name, handler)parseCommandArgs
(extract arg values)Check DM/group policiesSend inline buttons
(arg selection)processMessage
(route as text command)
```

**Command Sources**:

1. **Native commands**: From `listNativeCommandSpecsForConfig` (help, status, model, etc.)
2. **Skill commands**: From `listSkillCommandsForAgents` (user-invocable skills)
3. **Custom commands**: From `channels.telegram.customCommands` array

**Collision Handling**: Custom commands that collide with native command names are rejected with an error log.

**Sources**: [src/telegram/bot.test.ts 216-315](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L216-L315) [src/telegram/bot-native-commands.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-native-commands.ts)

### Custom Commands

```
{
  channels: {
    telegram: {
      customCommands: [
        { command: "backup", description: "Run backup script" },
        { command: "deploy", description: "Deploy to production" }
      ]
    }
  }
}
```

Custom commands are registered alongside native commands but do **not** execute tool logicâ€”they're forwarded to the agent as text.

**Sources**: [src/telegram/bot.test.ts 216-315](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L216-L315)

---

## Message Processing Pipeline

The core message processor is created by `createTelegramMessageProcessor` and handles the full inbound message flow:

```
Response SendergetReplyFromConfigEnvelope BuilderMedia ResolutionAccess ControlMessage HandlerTelegram UpdateResponse SendergetReplyFromConfigEnvelope BuilderMedia ResolutionAccess ControlMessage HandlerTelegram Updatealt[Denied (Pairing Required)][Allowed]message eventshouldSkipUpdate(deduplication)Check DM/group policiesPairing check (if DM policy)allowed / deniedSend pairing requestresolveMedia(photos, documents, etc)Extract text + entitiesBuild envelope headerConstruct inbound contextRoute to agentresponse payloadStream/send responseSet typing indicator
```

**Sources**: [src/telegram/bot-message.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-message.ts) [src/telegram/bot.ts 325-346](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L325-L346)

### Access Control Layers

**DM (Direct Message) Policies**:

- `open` - Accept all DMs (no authorization)
- `pairing` - Require pairing code exchange (default)
- `allowlist` - Require sender in `allowFrom` list
- `disabled` - Reject all DMs

**Group Policies**:

- `open` - Accept all group messages (subject to mention gating)
- `allowlist` - Require sender in `groupAllowFrom` OR group in allowlist
- `disabled` - Reject all group messages

**Pairing Flow** (when `dmPolicy: "pairing"`):

1. Unknown sender sends message
2. Bot generates pairing code via `upsertTelegramPairingRequest`
3. Bot responds with code and instructions
4. User shares code with bot owner
5. Owner runs `/allowlist add telegram:{userId}`
6. User can now message the bot

**Sources**: [src/telegram/bot.test.ts 561-635](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L561-L635) [src/telegram/pairing-store.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/pairing-store.ts)

---

## Media Handling

Telegram supports various media types with different handling strategies:

### Media Types

| Type | Handler | Notes |
| --- | --- | --- |
| Photo | `resolveMedia` | Downloads largest size |
| Video | `resolveMedia` | Downloads video file |
| Document | `resolveMedia` | Downloads with original filename |
| Audio | `resolveMedia` | Downloads audio file |
| Voice | `resolveMedia` | Downloads voice note |
| Sticker | `resolveMedia` | Downloads + caches metadata |
| Location | `extractLocationData` | GPS coordinates + metadata |
| Venue | `extractLocationData` | Location + place info |

### Media Groups (Albums)

When users send multiple photos/videos as an album, Telegram delivers them as separate updates with the same `media_group_id`. OpenClaw buffers these for batch processing:

```
const mediaGroupBuffer = new Map<string, MediaGroupEntry>();
// Entry = { messages: [], timer: setTimeout(...) }

// On media group update:
if (mediaGroupId) {
  const entry = mediaGroupBuffer.get(mediaGroupId) || createEntry();
  entry.messages.push({ ctx, msg });
  clearTimeout(entry.timer);
  entry.timer = setTimeout(() => {
    processMediaGroup(entry); // Process all as one message
  }, MEDIA_GROUP_TIMEOUT_MS); // 1000ms
}
```

The processor collects all media URLs and passes them as `mediaUrls` array to the reply system.

**Sources**: [src/telegram/bot-handlers.ts 47-141](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-handlers.ts#L47-L141) [src/telegram/bot-updates.ts 19](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-updates.ts#L19-L19)

### Stickers

Telegram stickers include emoji associations and set metadata. OpenClaw caches sticker descriptions to avoid redundant vision processing:

```
export interface StickerMetadata {
  emoji?: string;
  setName?: string;
  fileId?: string;
  fileUniqueId?: string;
  cachedDescription?: string; // Skip re-processing if present
}
```

**Sources**: [src/telegram/bot/types.ts 77-89](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot/types.ts#L77-L89)

---

## Text Fragment Handling

Some Telegram clients split long messages into multiple sequential updates. OpenClaw detects and coalesces these:

**Detection Heuristics**:

- Text length â‰¥ 4000 characters (threshold)
- Time gap â‰¤ 1500ms between messages
- Message ID gap â‰¤ 1 (sequential)
- Max 12 parts allowed
- Max 50,000 total characters
```
const textFragmentBuffer = new Map<string, TextFragmentEntry>();
// Key: \`${chatId}:${senderId}\`
// Entry: { messages: [], timer: setTimeout(...) }

// On potential fragment:
if (text.length >= THRESHOLD && !hasControlCommand(text)) {
  const entry = getOrCreateEntry(key);
  entry.messages.push({ msg, ctx, receivedAtMs });
  scheduleFlush(entry); // Debounce 1500ms
}
```

When flushed, the text is concatenated and processed as a single synthetic message.

**Sources**: [src/telegram/bot-handlers.ts 50-190](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-handlers.ts#L50-L190)

---

## Inbound Debouncing

To handle rapid typing without overwhelming the agent, OpenClaw debounces consecutive text messages:

```
const inboundDebouncer = createInboundDebouncer<TelegramDebounceEntry>({
  debounceMs, // From config
  buildKey: (entry) => entry.debounceKey,
  shouldDebounce: (entry) => {
    // Don't debounce media or control commands
    if (entry.allMedia.length > 0) return false;
    if (hasControlCommand(text, cfg)) return false;
    return true;
  },
  onFlush: async (entries) => {
    // Combine all text, process with last message's metadata
    const combined = entries.map(e => e.msg.text).join("\n");
    await processMessage(lastEntry.ctx, [], lastEntry.storeAllowFrom);
  },
});
```

**Configuration**:

```
{
  messages: {
    inbound: {
      debounce: {
        telegram: 1000 // ms
      }
    }
  }
}
```

**Sources**: [src/telegram/bot-handlers.ts 58-111](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-handlers.ts#L58-L111) [src/auto-reply/inbound-debounce.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/inbound-debounce.ts)

---

## Reaction Notifications

Telegram allows users to react to messages with emoji. OpenClaw can emit system events when reactions are added:

**Reaction Notification Modes**:

- `off` - Ignore all reactions (default)
- `own` - Notify when someone reacts to bot's messages
- `allowlist` - Notify when allowlisted users add reactions
- `all` - Notify for all reactions
```
{
  channels: {
    telegram: {
      reactionNotifications: "own"
    }
  }
}
```

**System Event Format**:

```
Signal reaction added: ðŸ‘ by Ada Lovelace (@ada) msg 123
```

The event is enqueued to the session context, making it available in the next agent turn.

**Sources**: [src/telegram/bot.ts 369-452](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L369-L452) [src/telegram/bot.test.ts 754-789](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L754-L789)

---

## Inline Buttons (Callback Queries)

OpenClaw supports interactive inline buttons for command menus and pagination:

### Callback Query Flow

```
LogicAuthHandlerTelegramUserLogicAuthHandlerTelegramUseralt[Pagination Callback][Command Arg Callback]alt[Scope Blocked][Scope Allowed]Click buttoncallback_queryanswerCallbackQuery(immediate ack)Check inline button scopeSkip (no response)Parse callback databuildCommandsMessagePaginatededitMessageText(update menu)Build command with arg valueprocessMessage(execute command)
```

**Inline Button Scopes**:

- `off` - Disable all inline buttons
- `dm` - DMs only
- `group` - Groups only
- `allowlist` - Allowlisted users only (default)
- `all` - Everyone
```
{
  channels: {
    telegram: {
      capabilities: {
        inlineButtons: "allowlist"
      }
    }
  }
}
```

**Use Cases**:

1. **Command Pagination**: `/commands` shows paginated list with â—€ Prev / Next â–¶ buttons
2. **Argument Menus**: Native commands with missing args show button menus

**Sources**: [src/telegram/bot.ts 192-201](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L192-L201) [src/telegram/bot.test.ts 363-515](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L363-L515) [src/telegram/bot-handlers.ts 192-470](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-handlers.ts#L192-L470)

---

## Response Streaming

Telegram responses can be streamed in three modes:

**Stream Modes**:

- `off` - Send complete response as single message
- `partial` - Stream text chunks, edit message incrementally
- `block` - Stream tool output + thinking as separate messages
```
{
  channels: {
    telegram: {
      streamMode: "partial"
    }
  }
}
```

**Partial Streaming**:

- Edits the same message as text arrives
- Maximum ~30-40 edits per message (Telegram limit)
- Falls back to new messages when edit limit reached

**Block Streaming**:

- Each tool result/thought becomes a separate message
- More verbose but doesn't hit edit limits

**Sources**: [src/telegram/bot/helpers.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot/helpers.ts#LNaN-LNaN)

---

## Reply Threading

Telegram supports native reply threads (quote/reply-to). OpenClaw respects this for conversation context:

**Reply-To Modes**:

- `first` - Reply to user's first message only (default)
- `all` - Reply to every user message (creates thread)
- `off` - Never use native replies
```
{
  channels: {
    telegram: {
      replyToMode: "first"
    }
  }
}
```

When a user replies to a message, OpenClaw includes the quoted context in the envelope:

```
[Replying to Ada id:9001]
> Can you summarize this?

Sure, see below
```

**Quote Support**: Telegram's partial reply feature (quoting a text snippet) is also extracted and included.

**Sources**: [src/telegram/bot.test.ts 869-967](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L869-L967) [src/telegram/send.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/send.ts#LNaN-LNaN)

---

## Configuration Reference

Complete Telegram configuration schema:

```
{
  channels: {
    telegram: {
      // Authentication
      token: string;
      accountId?: string;
      
      // Network
      network?: "clearnet" | "tor";
      timeoutSeconds?: number;
      
      // Access Control
      dmPolicy?: "open" | "pairing" | "allowlist" | "disabled";
      allowFrom?: string[]; // User IDs or usernames
      groupPolicy?: "open" | "allowlist" | "disabled";
      groupAllowFrom?: string[];
      groups?: {
        [chatId: string]: {
          enabled?: boolean;
          allowFrom?: string[];
          requireMention?: boolean;
          topics?: {
            [topicId: string]: {
              enabled?: boolean;
              allowFrom?: string[];
            };
          };
        };
      };
      
      // Response Behavior
      replyToMode?: "first" | "all" | "off";
      streamMode?: "off" | "partial" | "block";
      blockStreaming?: boolean; // Legacy alias for streamMode
      
      // Media
      mediaMaxMb?: number; // Default: 5
      
      // Commands
      commands?: {
        native?: boolean | "auto";
        nativeSkills?: boolean | "auto";
      };
      customCommands?: Array<{
        command: string;
        description: string;
      }>;
      
      // Features
      capabilities?: {
        inlineButtons?: "off" | "dm" | "group" | "allowlist" | "all";
      };
      reactionNotifications?: "off" | "own" | "allowlist" | "all";
      
      // History
      historyLimit?: number; // Group chat history
      
      // Chunking
      textChunkLimit?: number;
      textChunkMode?: "length" | "newline";
    };
  };
}
```

**Sources**: [src/config/types.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/types.ts#LNaN-LNaN) [src/telegram/bot.ts 50-65](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L50-L65)

---

The bot includes comprehensive error handling:

**API Error Logging**: Telegram API calls are wrapped with `withTelegramApiErrorLogging` for structured error reporting.

**Unknown Interaction Errors**: Expired interactions (callback queries older than 3 seconds) are silently skipped.

**Global Error Handlers**: The bot installs catch-all handlers via `bot.catch()` to prevent crashes from unhandled rejections.

**Update Skipping**: Updates are skipped (not failed) when:

- Deduplication detects a duplicate
- Access control rejects the sender
- Rate limiting throttles the request

**Sources**: [src/telegram/bot.ts 145-153](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L145-L153) [src/telegram/api-logging.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/api-logging.ts)

---

## Testing and Mocking

The Telegram integration includes extensive test coverage with mocked grammY and API clients:

**Key Test Helpers**:

- `botCtorSpy` - Tracks bot construction
- `sendMessageSpy` - Verifies outbound messages
- `setMyCommandsSpy` - Validates command registration
- `editMessageTextSpy` - Verifies message edits
- `setMessageReactionSpy` - Validates reaction API calls

**Test Categories**:

1. **Command Registration**: Validates native + custom + skill commands
2. **Collision Detection**: Ensures custom commands don't override native ones
3. **Access Control**: Tests pairing, allowlists, group policies
4. **Message Processing**: Validates envelopes, media, replies
5. **Forum Support**: Tests topic isolation and configuration
6. **Inline Buttons**: Validates callback query handling
7. **Pagination**: Tests command list pagination

**Sources**: [src/telegram/bot.test.ts 1-1076](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts#L1-L1076)

<svg id="mermaid-fu8dstus3vp" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 2412 512" style="max-width: 512px;" role="graphics-document document" aria-roledescription="error"><g></g><g><path class="error-icon" d="m411.313,123.313c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32-9.375,9.375-20.688-20.688c-12.484-12.5-32.766-12.5-45.25,0l-16,16c-1.261,1.261-2.304,2.648-3.31,4.051-21.739-8.561-45.324-13.426-70.065-13.426-105.867,0-192,86.133-192,192s86.133,192 192,192 192-86.133 192-192c0-24.741-4.864-48.327-13.426-70.065 1.402-1.007 2.79-2.049 4.051-3.31l16-16c12.5-12.492 12.5-32.758 0-45.25l-20.688-20.688 9.375-9.375 32.001-31.999zm-219.313,100.687c-52.938,0-96,43.063-96,96 0,8.836-7.164,16-16,16s-16-7.164-16-16c0-70.578 57.422-128 128-128 8.836,0 16,7.164 16,16s-7.164,16-16,16z"></path><path class="error-icon" d="m459.02,148.98c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l16,16c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16.001-16z"></path><path class="error-icon" d="m340.395,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16-16c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l15.999,16z"></path><path class="error-icon" d="m400,64c8.844,0 16-7.164 16-16v-32c0-8.836-7.156-16-16-16-8.844,0-16,7.164-16,16v32c0,8.836 7.156,16 16,16z"></path><path class="error-icon" d="m496,96.586h-32c-8.844,0-16,7.164-16,16 0,8.836 7.156,16 16,16h32c8.844,0 16-7.164 16-16 0-8.836-7.156-16-16-16z"></path><path class="error-icon" d="m436.98,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688l32-32c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32c-6.251,6.25-6.251,16.375-0.001,22.625z"></path><text class="error-text" x="1440" y="250" font-size="150px" style="text-anchor: middle;">Syntax error in text</text> <text class="error-text" x="1250" y="400" font-size="100px" style="text-anchor: middle;">mermaid version 11.12.2</text></g></svg> <svg id="mermaid-7khuxtjp8f" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 2412 512" style="max-width: 512px;" role="graphics-document document" aria-roledescription="error"><g></g><g><path class="error-icon" d="m411.313,123.313c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32-9.375,9.375-20.688-20.688c-12.484-12.5-32.766-12.5-45.25,0l-16,16c-1.261,1.261-2.304,2.648-3.31,4.051-21.739-8.561-45.324-13.426-70.065-13.426-105.867,0-192,86.133-192,192s86.133,192 192,192 192-86.133 192-192c0-24.741-4.864-48.327-13.426-70.065 1.402-1.007 2.79-2.049 4.051-3.31l16-16c12.5-12.492 12.5-32.758 0-45.25l-20.688-20.688 9.375-9.375 32.001-31.999zm-219.313,100.687c-52.938,0-96,43.063-96,96 0,8.836-7.164,16-16,16s-16-7.164-16-16c0-70.578 57.422-128 128-128 8.836,0 16,7.164 16,16s-7.164,16-16,16z"></path><path class="error-icon" d="m459.02,148.98c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l16,16c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16.001-16z"></path><path class="error-icon" d="m340.395,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16-16c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l15.999,16z"></path><path class="error-icon" d="m400,64c8.844,0 16-7.164 16-16v-32c0-8.836-7.156-16-16-16-8.844,0-16,7.164-16,16v32c0,8.836 7.156,16 16,16z"></path><path class="error-icon" d="m496,96.586h-32c-8.844,0-16,7.164-16,16 0,8.836 7.156,16 16,16h32c8.844,0 16-7.164 16-16 0-8.836-7.156-16-16-16z"></path><path class="error-icon" d="m436.98,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688l32-32c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32c-6.251,6.25-6.251,16.375-0.001,22.625z"></path><text class="error-text" x="1440" y="250" font-size="150px" style="text-anchor: middle;">Syntax error in text</text> <text class="error-text" x="1250" y="400" font-size="100px" style="text-anchor: middle;">mermaid version 11.12.2</text></g></svg>