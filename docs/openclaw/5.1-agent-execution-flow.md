Menu

## Agent Execution Flow

Relevant source files
- [.npmrc](https://github.com/openclaw/openclaw/blob/bf6ec64f/.npmrc)
- [CHANGELOG.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/CHANGELOG.md)
- [README.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/README.md)
- [assets/avatar-placeholder.svg](https://github.com/openclaw/openclaw/blob/bf6ec64f/assets/avatar-placeholder.svg)
- [docs/gateway/configuration-examples.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/gateway/configuration-examples.md)
- [docs/gateway/configuration.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/gateway/configuration.md)
- [docs/gateway/sandbox-vs-tool-policy-vs-elevated.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/gateway/sandbox-vs-tool-policy-vs-elevated.md)
- [docs/gateway/sandboxing.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/gateway/sandboxing.md)
- [docs/multi-agent-sandbox-tools.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/multi-agent-sandbox-tools.md)
- [docs/tools/elevated.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/tools/elevated.md)
- [docs/tools/index.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/tools/index.md)
- [extensions/memory-core/package.json](https://github.com/openclaw/openclaw/blob/bf6ec64f/extensions/memory-core/package.json)
- [package.json](https://github.com/openclaw/openclaw/blob/bf6ec64f/package.json)
- [pnpm-lock.yaml](https://github.com/openclaw/openclaw/blob/bf6ec64f/pnpm-lock.yaml)
- [pnpm-workspace.yaml](https://github.com/openclaw/openclaw/blob/bf6ec64f/pnpm-workspace.yaml)
- [scripts/clawtributors-map.json](https://github.com/openclaw/openclaw/blob/bf6ec64f/scripts/clawtributors-map.json)
- [scripts/update-clawtributors.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/scripts/update-clawtributors.ts)
- [scripts/update-clawtributors.types.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/scripts/update-clawtributors.types.ts)
- [src/agents/bash-tools.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/bash-tools.ts)
- [src/agents/pi-embedded-helpers.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-helpers.ts)
- [src/agents/pi-embedded-runner-extraparams.live.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner-extraparams.live.test.ts)
- [src/agents/pi-embedded-runner-extraparams.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner-extraparams.test.ts)
- [src/agents/pi-embedded-runner.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner.ts)
- [src/agents/pi-embedded-subscribe.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-subscribe.ts)
- [src/agents/pi-tools.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools.ts)
- [src/agents/sandbox.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/sandbox.ts)
- [src/config/types.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/types.ts)
- [src/config/zod-schema.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/zod-schema.ts)
- [src/discord/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/discord/monitor.ts)
- [src/imessage/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/imessage/monitor.ts)
- [src/index.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/index.ts)
- [src/signal/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/signal/monitor.ts)
- [src/slack/monitor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/slack/monitor.ts)
- [src/telegram/bot.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.test.ts)
- [src/telegram/bot.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts)
- [src/web/auto-reply.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/auto-reply.ts)
- [src/web/inbound.media.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/inbound.media.test.ts)
- [src/web/inbound.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/inbound.test.ts)
- [src/web/inbound.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/inbound.ts)
- [src/web/test-helpers.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/test-helpers.ts)
- [src/web/vcard.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/vcard.ts)
- [ui/package.json](https://github.com/openclaw/openclaw/blob/bf6ec64f/ui/package.json)
- [ui/src/styles.css](https://github.com/openclaw/openclaw/blob/bf6ec64f/ui/src/styles.css)
- [ui/src/styles/layout.mobile.css](https://github.com/openclaw/openclaw/blob/bf6ec64f/ui/src/styles/layout.mobile.css)

This page traces a complete agent execution cycle from the moment an inbound message arrives through tool execution to final response delivery. It covers the main execution path, tool routing decisions, and state management.

For configuration of agent behavior, see [Agent System](https://deepwiki.com/openclaw/openclaw/5-agent-system). For system prompt construction details, see [System Prompt](https://deepwiki.com/openclaw/openclaw/5.2-system-prompt). For session management specifics, see [Session Management](https://deepwiki.com/openclaw/openclaw/5.3-session-management).

---

## Overview

An agent turn consists of several sequential phases:

1. **Message Receipt**: Channel adapter receives inbound message
2. **Routing & Access Control**: Validates sender and resolves target agent
3. **Session Resolution**: Determines session key and locks for sequential processing
4. **Context Assembly**: Builds system prompt and retrieves memory search results
5. **Agent Runtime**: Initializes Pi Agent Core with tools and configuration
6. **Model Execution**: Streams request to model provider with automatic failover
7. **Tool Execution**: Routes and executes tool calls with security policies
8. **Response Handling**: Streams chunks back to channel, handles overflow
9. **State Persistence**: Saves session transcript and metadata

**Sources**: [CHANGELOG.md 1-100](https://github.com/openclaw/openclaw/blob/bf6ec64f/CHANGELOG.md#L1-L100) [src/agents/pi-embedded-runner.ts 1-28](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner.ts#L1-L28) [src/web/auto-reply.ts 1-2](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/auto-reply.ts#L1-L2)

---

## Message Receipt and Channel Routing

### Channel Message Processing

```
duplicatenewdeniedallowedChannel Adapter
(Telegram/Discord/Slack/etc)Inbound Message EventDedupe Check
buildTelegramUpdateKeyAccess Control
dmPolicy/groupPolicyAgent Router
resolveAgentRouteMessage Queue
queueEmbeddedPiMessageDrop (silent)Send Pairing Code
(if dmPolicy=pairing)
```

Each channel adapter (Telegram, Discord, Slack, etc.) implements message handling that:

1. **Deduplicates updates**: Uses channel-specific update IDs to prevent reprocessing
2. **Applies access policies**: Checks `dmPolicy` for DMs, `groupPolicy` for groups
3. **Routes to agent**: Uses `resolveAgentRoute` to determine target agent based on bindings
4. **Queues message**: Calls `queueEmbeddedPiMessage` with resolved session key

**Example for Telegram**:

- Update deduplication: [src/telegram/bot.ts 157-178](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L157-L178)
- Access policy checks: [src/telegram/bot.ts 228-236](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L228-L236)
- Message queueing: [src/telegram/bot.ts 325-346](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L325-L346)

**Sources**: [src/telegram/bot.ts 1-50](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot.ts#L1-L50) [src/web/auto-reply.ts 1-2](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/web/auto-reply.ts#L1-L2) [src/discord/monitor.ts 1-29](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/discord/monitor.ts#L1-L29) [src/slack/monitor.ts 1-6](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/slack/monitor.ts#L1-L6)

---

## Session Resolution and Locking

### Session Key Patterns

Session keys determine conversation context isolation:

| Pattern | Example | Meaning |
| --- | --- | --- |
| `agent:main:telegram:dm:123456789` | Telegram DM | Direct message on Telegram |
| `agent:main:discord:group:987654321` | Discord channel | Discord channel/thread |
| `agent:work:whatsapp:group:120363...@g.us` | WhatsApp group | WhatsApp group chat |
| `agent:main:main` | CLI/TUI | Direct CLI interaction |

**Session resolution flow**:

```
isDMisGrouphasThreadMessage Context
(channel, sender, chat)Resolve Agent ID
resolveAgentRouteDetermine Session TypeDM Session
agent:ID:channel:dm:senderGroup Session
agent:ID:channel:group:chatIdThread Session
agent:ID:channel:group:chatId:thread:threadIdAcquire Session Lock
(if queueMode=sequential)Load Session Store
loadSessionStore
```

**Queue modes**:

- `sequential` (default): Acquires lock, processes messages one-at-a-time per session
- `concurrent`: No lock, multiple messages can process simultaneously

**Sources**: [src/routing/session-key.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/session-key.ts) [src/config/sessions.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/sessions.ts) [src/agents/pi-embedded-runner/runs.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner/runs.ts)

---

## Agent Runtime Initialization

### Runtime Setup

Before model execution, the runtime assembles the execution context:

```
Session Key
agent:main:telegram:dm:123Agent Config
agents.list[agentId]Workspace Root
agents.list[].workspaceAgent Directory
~/.openclaw/agents/main/agentTool Registry
createOpenClawCodingToolsSandbox Context
resolveSandboxContextExtra Params
resolveExtraParamsBootstrap Files
buildBootstrapContextFilesMemory Search
Memory Search ProviderSystem Prompt
createSystemPromptOverride
```

**Key runtime components**:

| Component | Purpose | Config Key |
| --- | --- | --- |
| **Workspace** | Root directory for agent files | `agents.list[].workspace` |
| **Agent Dir** | Auth profiles, cache, state | Derived from agent ID |
| **Bootstrap Files** | AGENTS.md, SOUL.md, TOOLS.md | Auto-discovered in workspace |
| **Tool Registry** | Available tools (exec, read, browser, etc.) | `tools.allow`, `tools.deny` |
| **Sandbox Context** | Docker container for isolation | `agents.list[].sandbox` |
| **Memory Search** | Hybrid BM25 + vector retrieval | `memorySearch.*` |

**Sources**: [src/agents/pi-embedded-runner/run.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner/run.ts) [src/agents/pi-tools.ts 1-50](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools.ts#L1-L50) [src/agents/sandbox/context.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/sandbox/context.ts)

---

## Context Assembly

### System Prompt Construction

The system prompt is built from multiple sources:

```
Runtime ContextTool SchemasMemory ContextWorkspace FilesAGENTS.md
(agent instructions)SOUL.md
(personality)TOOLS.md
(custom tools)skills/*/SKILL.mdmemory_search results
(BM25 + vector)Core Tools
(exec, read, write)Plugin Tools
(slack, discord, etc)Channel Tools
(message, sessions)identity
(name, theme, emoji)session_status
(model, tokens, cost)timezone
(host-local)System Prompt Builder
createSystemPromptOverrideFinal System Prompt
```

**Bootstrap file discovery**:

- Max chars per file: `DEFAULT_BOOTSTRAP_MAX_CHARS` (100,000)
- Files are read from workspace root and `skills/*/` subdirectories
- Content is stripped of thought signatures and injected into system prompt

**Memory search integration**:

- Query: Current message text + recent history
- Hybrid retrieval: BM25 (keyword) + vector (semantic)
- Results injected as context before prompt

**Sources**: [src/agents/pi-embedded-helpers/bootstrap.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-helpers/bootstrap.ts) [src/agents/pi-embedded-runner/system-prompt.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner/system-prompt.ts) [src/memory/](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/memory/)

---

## Model Execution and Streaming

### Model Request Flow

```
Event Streamin cooldownreadyauth errorbilling errorrate limitSelect Model
primary + fallbacksCheck Cooldown
(billing/failure backoff)Stream Request
Pi Agent Coretext_deltatool_callthinking_deltamessage_endFailover Logic
classifyFailoverReasonRotate Auth ProfileTry Fallback ModelProcess Delta
subscribeEmbeddedPiSessionRoute Tool CallStream ReasoningFinalize Response
```

**Failover conditions**:

- **Auth errors**: Rotate to next auth profile for same provider
- **Billing errors**: Cooldown current profile, try fallback model
- **Rate limits**: Immediate fallback to next model
- **Context overflow**: Auto-compact session before retry

**Event handling** in `subscribeEmbeddedPiSession`:

- `text_delta`: Accumulates into `deltaBuffer`, chunks for streaming
- `tool_call`: Routes to tool executor, waits for result
- `thinking_delta`: Optionally streams reasoning (if `reasoningMode=stream`)
- `message_end`: Finalizes assistant text, saves to session

**Sources**: [src/agents/pi-embedded-runner/run.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner/run.ts) [src/agents/pi-embedded-subscribe.ts 1-50](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-subscribe.ts#L1-L50) [src/agents/pi-embedded-helpers/errors.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-helpers/errors.ts)

---

## Tool Call Routing and Execution

### Tool Execution Decision Tree

```
Other Tool Typesexec Tool Flowdeniedallowedexecyesnoapproveddeniedyesno + sandboxno + no sandboxotherTool Call Event
(tool name + args)Check Tool Policy
isToolAllowedByPoliciesTool Blocked
(policy denial)Route by Tool TypeApproval
Required?Safe Binary?Send Approval Prompt
/approve commandWait for User ResponseExecute in Sandbox
(Docker container)Execute on Host
(PTY)browser
(CDP protocol)canvas
(A2UI host)node.invoke
(device actions)message
(channel send)sessions_*
(cross-session)Tool Result
(success/error)
```

### Tool Policy Precedence

Tool execution is gated by multiple policy layers (evaluated in order):

1. **Tool Profile**: Base allowlist (`tools.profile` or `agents.list[].tools.profile`)
2. **Provider Profile**: Provider-specific restrictions (`tools.byProvider`)
3. **Global Policy**: `tools.allow` / `tools.deny`
4. **Agent Policy**: `agents.list[].tools.allow` / `agents.list[].tools.deny`
5. **Group Policy**: Per-group/channel restrictions (`channels.*.groups.*.tools`)
6. **Sandbox Policy**: Sandbox tool allowlist (`agents.list[].sandbox.tools`)
7. **Subagent Policy**: Inherited from parent (for spawned sessions)

**Exec tool approval flow**:

- Check `tools.exec.ask`: `off` (never), `elevated` (when /elevated on), `always`
- Check `tools.exec.security`: `full` (always approve), `sandbox` (approve outside sandbox)
- Check safe binaries list: `tools.exec.safeBins` (auto-approved commands)
- If approval needed: Send prompt via channel, wait for `/approve <id>` command

**Sources**: [src/agents/pi-tools.ts 1-100](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools.ts#L1-L100) [src/agents/bash-tools.exec.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/bash-tools.exec.ts) [src/agents/pi-tools.policy.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools.policy.ts)

---

## Response Delivery

### Streaming and Chunking

```
UserChannel AdapterEmbeddedBlockChunkersubscribeEmbeddedPiSessionModel ProviderUserChannel AdapterEmbeddedBlockChunkersubscribeEmbeddedPiSessionModel Provideralt[Block chunking enabled][No block chunking]alt[Context overflow]text_delta eventAccumulate in deltaBufferProcess chunkDetect <think> tagsEmit block boundarySend partial replyDisplay messageBuffer until message_endtool_call eventExecute toolUpdate typing indicatormessage_end eventFinalize assistantTextsSend final replyDisplay complete messageCheck context overflowAuto-compact (summarize)Compacted contextSave session state
```

**Block streaming modes**:

- `text_end`: Stream complete message after `message_end`
- `tool_call`: Stream after each tool call completes
- `text_delta`: Stream on every text delta (real-time)

**Chunking behavior**:

- Text limit per chunk: `channels.*.textChunkLimit` (default varies by channel)
- Chunk mode: `length` (split at limit) or `newline` (paragraph-aware)
- Reasoning blocks: Detected via `<think>` / `<thought>` tags, streamed separately if `reasoningMode=stream`

**Message editing**:

- Telegram: Edits existing message on each delta (efficient)
- Discord: Edits existing message with rate limiting
- WhatsApp/Signal: Sends new message per chunk (no edit support)

**Sources**: [src/agents/pi-embedded-subscribe.ts 1-100](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-subscribe.ts#L1-L100) [src/agents/pi-embedded-block-chunker.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-block-chunker.ts) [src/auto-reply/chunk.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/auto-reply/chunk.ts)

---

## Session State Management

### State Persistence

After each agent turn, session state is saved:

```
Session Store JSONyesnodaily/idlenoneFinalize ResponseContext
Overflow?Auto-Compact
compactEmbeddedPiSessionSummarize via ModelSave Transcript
saveSessionStorehistory
(message array)settings
(thinking, verbose, etc)status
(last active, message count)Increment messageCountReset
Policy?Reset Session
(clear history)Done
```

**Session store schema**:

```
{
  history: Array<{role, content, timestamp}>,
  thinkingLevel: "off" | "low" | "medium" | "high",
  verboseLevel: 0 | 1 | 2 | 3,
  model?: string,
  sendPolicy?: "announce" | "quiet",
  groupActivation?: "mention" | "always",
  lastActiveAt?: string,
  messageCount?: number,
  totalTokens?: number,
  totalCost?: number
}
```

**Auto-compaction triggers**:

- Context overflow error from model provider
- Manual `/compact` command
- Configurable token threshold (future)

**Compaction strategy**:

- Uses adaptive chunking: splits history into semantic segments
- Summarizes each segment via model
- Merges summaries into compact context
- Retains recent N turns verbatim (configurable)

**Reset policies**:

- `daily`: Reset at 4am local time (configurable idle window)
- `idle`: Reset after N hours of inactivity
- `none`: Manual `/reset` only

**Sources**: [src/config/sessions.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/sessions.ts) [src/agents/pi-embedded-runner/compact.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner/compact.ts) [src/session/](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/session/)

---

The runtime classifies errors to determine failover strategy:

| Error Type | Classification Function | Failover Action |
| --- | --- | --- |
| **Auth errors** | `isAuthAssistantError` | Rotate auth profile |
| **Billing errors** | `isBillingAssistantError` | Cooldown + fallback model |
| **Rate limits** | `isRateLimitAssistantError` | Immediate fallback |
| **Context overflow** | `isContextOverflowError` | Auto-compact + retry |
| **Timeouts** | `isTimeoutErrorMessage` | Retry same model |
| **Image size errors** | `isImageSizeError` | Surface to user |

**Cooldown behavior**:

- Billing backoff: Default 24 hours (`auth.cooldowns.billingBackoffHours`)
- Failure window: Tracks errors over 1 hour (`auth.cooldowns.failureWindowHours`)
- Max cooldown: 7 days (`auth.cooldowns.billingMaxHours`)

**Auth profile rotation**:

1. Check `auth.order[provider]` for profile list
2. Skip profiles in cooldown
3. Attempt next profile with valid credentials
4. If all profiles exhausted, fall back to next model in fallback chain

**Sources**: [src/agents/pi-embedded-helpers/errors.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-helpers/errors.ts) [src/agents/model-auth.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/model-auth.ts) [src/agents/pi-embedded-runner/run.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner/run.ts)

---

## Complete Flow Example

### End-to-End Trace

For a Telegram message "Write a hello world script":

1. **Receipt**: Telegram bot receives update, validates not duplicate
2. **Policy**: Checks `channels.telegram.allowFrom`, passes for known sender
3. **Routing**: Resolves to `agent:main:telegram:dm:123456789`
4. **Queue**: Calls `queueEmbeddedPiMessage` with session key
5. **Lock**: Acquires session lock (if `queueMode=sequential`)
6. **Load**: Reads session store from `~/.openclaw/sessions/agent:main/sessions.json`
7. **Bootstrap**: Reads `AGENTS.md`, `SOUL.md`, `TOOLS.md` from workspace
8. **Memory**: Queries memory search with "Write a hello world script"
9. **Tools**: Builds tool registry (exec, read, write, etc.)
10. **Prompt**: Combines bootstrap + memory + tools into system prompt
11. **Model**: Streams to `anthropic/claude-sonnet-4-5` with failover to Opus
12. **Delta**: Receives `text_delta` events, accumulates in buffer
13. **Tool Call**: Model calls `write(path="hello.sh", content="#!/bin/bash\necho 'Hello, World!'\n")`
14. **Policy Check**: Validates `write` allowed by tool policy
15. **Execute**: Writes file to workspace
16. **Result**: Returns success to model
17. **Final**: Model sends final text "I've created a hello world script"
18. **Stream**: Chunks response to Telegram (respects 4096 char limit)
19. **Save**: Writes updated session store with new turn
20. **Unlock**: Releases session lock

**Sources**: [src/agents/pi-embedded-runner/run.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-runner/run.ts) [src/agents/pi-embedded-subscribe.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-embedded-subscribe.ts) [src/telegram/bot-message.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/telegram/bot-message.ts)

<svg id="mermaid-fu8dstus3vp" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 2412 512" style="max-width: 512px;" role="graphics-document document" aria-roledescription="error"><g></g><g><path class="error-icon" d="m411.313,123.313c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32-9.375,9.375-20.688-20.688c-12.484-12.5-32.766-12.5-45.25,0l-16,16c-1.261,1.261-2.304,2.648-3.31,4.051-21.739-8.561-45.324-13.426-70.065-13.426-105.867,0-192,86.133-192,192s86.133,192 192,192 192-86.133 192-192c0-24.741-4.864-48.327-13.426-70.065 1.402-1.007 2.79-2.049 4.051-3.31l16-16c12.5-12.492 12.5-32.758 0-45.25l-20.688-20.688 9.375-9.375 32.001-31.999zm-219.313,100.687c-52.938,0-96,43.063-96,96 0,8.836-7.164,16-16,16s-16-7.164-16-16c0-70.578 57.422-128 128-128 8.836,0 16,7.164 16,16s-7.164,16-16,16z"></path><path class="error-icon" d="m459.02,148.98c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l16,16c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16.001-16z"></path><path class="error-icon" d="m340.395,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16-16c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l15.999,16z"></path><path class="error-icon" d="m400,64c8.844,0 16-7.164 16-16v-32c0-8.836-7.156-16-16-16-8.844,0-16,7.164-16,16v32c0,8.836 7.156,16 16,16z"></path><path class="error-icon" d="m496,96.586h-32c-8.844,0-16,7.164-16,16 0,8.836 7.156,16 16,16h32c8.844,0 16-7.164 16-16 0-8.836-7.156-16-16-16z"></path><path class="error-icon" d="m436.98,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688l32-32c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32c-6.251,6.25-6.251,16.375-0.001,22.625z"></path><text class="error-text" x="1440" y="250" font-size="150px" style="text-anchor: middle;">Syntax error in text</text> <text class="error-text" x="1250" y="400" font-size="100px" style="text-anchor: middle;">mermaid version 11.12.2</text></g></svg>