Menu

## Multi-Agent Configuration

Relevant source files
- [docs/cli/index.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/cli/index.md)
- [docs/gateway/doctor.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/gateway/doctor.md)
- [docs/gateway/index.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/gateway/index.md)
- [docs/gateway/troubleshooting.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/gateway/troubleshooting.md)
- [docs/index.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/index.md)
- [docs/start/getting-started.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/start/getting-started.md)
- [docs/start/wizard.md](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/start/wizard.md)
- [src/agents/agent-scope.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.test.ts)
- [src/agents/agent-scope.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts)
- [src/agents/bash-tools.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/bash-tools.test.ts)
- [src/agents/model-auth.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/model-auth.ts)
- [src/agents/pi-tools-agent-config.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools-agent-config.test.ts)
- [src/agents/sandbox-skills.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/sandbox-skills.test.ts)
- [src/commands/auth-choice-options.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/auth-choice-options.test.ts)
- [src/commands/auth-choice-options.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/auth-choice-options.ts)
- [src/commands/auth-choice.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/auth-choice.test.ts)
- [src/commands/auth-choice.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/auth-choice.ts)
- [src/commands/configure.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/configure.ts)
- [src/commands/doctor.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/doctor.ts)
- [src/commands/onboard-auth.test.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/onboard-auth.test.ts)
- [src/commands/onboard-auth.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/onboard-auth.ts)
- [src/commands/onboard-non-interactive.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/onboard-non-interactive.ts)
- [src/commands/onboard-types.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/onboard-types.ts)
- [src/config/config.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/config.ts)
- [src/wizard/onboarding.ts](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/wizard/onboarding.ts)

Multi-agent configuration allows you to run multiple isolated agents within a single OpenClaw Gateway instance. Each agent maintains its own workspace, session history, authentication profiles, and can have distinct model configurations, tool policies, and sandbox settings. This enables use cases like separating work/personal contexts, routing different messaging accounts to specialized agents, or maintaining strict isolation between different user groups.

For general agent execution behavior, see [Agent Execution Flow](https://deepwiki.com/openclaw/openclaw/5.1-agent-execution-flow). For workspace organization, see [Skills System](https://deepwiki.com/openclaw/openclaw/6.3-skills-system). For session management across agents, see [Session Management](https://deepwiki.com/openclaw/openclaw/5.3-session-management).

---

## Agent Configuration Structure

Multi-agent configuration consists of three main components: default settings, agent definitions, and bindings.

```
Binding RuleAgent DefinitionConfiguration SchemaProvides defaultsagents.defaults
(Default settings)agents.list[]
(Agent definitions)bindings[]
(Routing rules)id: stringname?: stringworkspace: stringagentDir?: stringmodel?: string | ModelConfigsandbox?: SandboxConfigtools?: ToolsConfigidentity, groupChat, subagents, etc.match: { channel, accountId?, senderId? }agent: string (agent id)
```

**Sources:**[src/config/types.ts 1-500](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/types.ts#L1-L500) [src/agents/agent-scope.ts 15-30](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L15-L30)

---

### Core Config Fields

The `agents` section in `openclaw.json` contains:

| Field | Type | Description |
| --- | --- | --- |
| `agents.defaults` | `AgentDefaults` | Default configuration inherited by all agents unless overridden |
| `agents.list[]` | `AgentEntry[]` | Array of agent definitions, each with a unique `id` |
| `agents.list[].id` | `string` | Unique identifier for the agent (normalized to lowercase) |
| `agents.list[].name` | `string?` | Display name for the agent |
| `agents.list[].default` | `boolean?` | Mark this agent as the default (used for unbound sessions) |
| `agents.list[].workspace` | `string` | Path to the agent's workspace directory |
| `agents.list[].agentDir` | `string?` | Path to agent state directory (auth profiles, etc.) |
| `agents.list[].model` | `string \| ModelConfig?` | Model override (primary + fallbacks) |
| `agents.list[].sandbox` | `SandboxConfig?` | Sandbox settings override |
| `agents.list[].tools` | `ToolsConfig?` | Tool policy override |
| `agents.list[].identity` | `Identity?` | Agent identity configuration |
| `agents.list[].groupChat` | `GroupChatConfig?` | Group chat behavior override |
| `agents.list[].subagents` | `SubagentsConfig?` | Subagent configuration |
| `agents.list[].memorySearch` | `MemorySearchConfig?` | Memory search settings |
| `agents.list[].humanDelay` | `HumanDelayConfig?` | Human delay simulation |
| `agents.list[].heartbeat` | `HeartbeatConfig?` | Heartbeat configuration |

**Sources:**[src/config/types.ts 200-350](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/types.ts#L200-L350) [src/agents/agent-scope.ts 16-32](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L16-L32)

---

## Agent Resolution and Routing

The Gateway uses a two-stage process to determine which agent handles a given session: binding resolution, then default fallback.

```
"agents.defaults""resolveAgentConfig""resolveSessionAgentId""Session Key Parser""Binding Resolver""Channel Router""Inbound Message""agents.defaults""resolveAgentConfig""resolveSessionAgentId""Session Key Parser""Binding Resolver""Channel Router""Inbound Message"alt[Binding Matches][No Binding Match]"channel: whatsappaccountId: bizsenderId: +1555...""Check bindings[]""Matched agent: work""sessionKey: agent:work:main""Use default agent""sessionKey: agent:main:main""Get agent config for 'work'""Merge with defaults""Resolved config"
```

**Sources:**[src/routing/session-key.ts 1-100](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/session-key.ts#L1-L100) [src/agents/agent-scope.ts 66-84](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L66-L84)

---

### Session Key Format

Sessions are identified by keys following the pattern: `agent:<agentId>:<conversationKey>`

- `agent:main:main` - Default agent, main conversation
- `agent:work:dm:whatsapp:+15555550123` - Work agent, DM with specific sender
- `agent:personal:group:telegram:123456` - Personal agent, Telegram group

The `parseAgentSessionKey` function extracts the `agentId` from session keys:

```
// From src/routing/session-key.ts
parseAgentSessionKey("agent:work:main") // => { agentId: "work", ... }
```

**Sources:**[src/routing/session-key.ts 1-50](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/session-key.ts#L1-L50) [src/agents/agent-scope.ts 66-77](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L66-L77)

---

### Binding Resolution

Bindings in the `bindings[]` array route messages to specific agents based on channel and account patterns.

```
Binding Entrymatchagent: 'work'channel: 'whatsapp'accountId?: 'biz'senderId?: '+1555...'Matches if channel matches
and accountId matches (if specified)
and senderId matches (if specified)
```

**Example bindings:**

```
{
  "bindings": [
    {
      "match": {
        "channel": "whatsapp",
        "accountId": "biz"
      },
      "agent": "work"
    },
    {
      "match": {
        "channel": "telegram",
        "accountId": "personal"
      },
      "agent": "personal"
    }
  ]
}
```

**Sources:**[src/routing/bindings.ts 1-150](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/bindings.ts#L1-L150) [docs/cli/index.md 479-509](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/cli/index.md#L479-L509)

---

## Per-Agent Configuration Overrides

Each agent can override any setting from `agents.defaults`. When an agent-specific value is present, it replaces the default entirely (no deep merging for most fields).

```
Agent-Specific FieldsResolution PriorityIf presentElse if presentElseagents.list[i].agents.defaults.System DefaultFinal Valueworkspacemodel (primary + fallbacks)sandbox (mode, scope, access)tools (allow, deny, elevated)identitygroupChatmemorySearchsubagents
```

**Sources:**[src/agents/agent-scope.ts 86-115](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L86-L115) [src/agents/pi-tools-agent-config.test.ts 98-131](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools-agent-config.test.ts#L98-L131)

---

### Model Configuration Override

Agents can specify a different primary model and fallbacks:

```
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "anthropic/claude-sonnet-4",
        "fallbacks": ["openai/gpt-4.1"]
      }
    },
    "list": [
      {
        "id": "work",
        "model": {
          "primary": "anthropic/claude-opus-4",
          "fallbacks": ["openai/gpt-5.2"]
        }
      },
      {
        "id": "personal",
        "model": "anthropic/claude-haiku-4" // String shorthand for primary only
      }
    ]
  }
}
```

The resolution logic:

- `resolveAgentModelPrimary(cfg, agentId)` returns the agent-specific primary, or falls back to `agents.defaults.model.primary`
- `resolveAgentModelFallbacksOverride(cfg, agentId)` returns `undefined` if no override, allowing global fallbacks to apply
- An explicit empty array (`fallbacks: []`) disables global fallbacks for that agent

**Sources:**[src/agents/agent-scope.ts 117-134](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L117-L134) [src/agents/agent-scope.test.ts 54-108](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.test.ts#L54-L108)

---

### Sandbox Configuration Override

Each agent can have isolated sandbox settings:

```
{
  "agents": {
    "defaults": {
      "sandbox": {
        "mode": "non-main",
        "scope": "session",
        "workspaceAccess": "rw"
      }
    },
    "list": [
      {
        "id": "restricted",
        "sandbox": {
          "mode": "all", // Always sandbox
          "scope": "agent", // One container per agent
          "workspaceAccess": "none", // No host workspace access
          "docker": {
            "image": "openclaw/agent:restricted",
            "cpus": "1.0",
            "memory": "1g"
          }
        }
      }
    ]
  }
}
```

**Sources:**[src/agents/sandbox.ts 1-200](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/sandbox.ts#L1-L200) [src/agents/agent-scope.test.ts 110-136](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.test.ts#L110-L136)

---

### Tools Configuration Override

Agents can restrict or expand tool access:

```
{
  "agents": {
    "list": [
      {
        "id": "readonly",
        "tools": {
          "allow": ["read", "memory_search"],
          "deny": ["exec", "write", "edit", "apply_patch"]
        }
      },
      {
        "id": "elevated",
        "tools": {
          "elevated": {
            "enabled": true,
            "allowFrom": {
              "whatsapp": ["+15555550123"]
            },
            "defaultLevel": "on"
          }
        }
      }
    ]
  }
}
```

Tool resolution merges agent-specific policies with global defaults. If `agents.list[i].tools.allow` is specified, it replaces the global allow list entirely.

**Sources:**[src/agents/pi-tools-agent-config.test.ts 8-96](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools-agent-config.test.ts#L8-L96) [src/agents/agent-scope.test.ts 138-166](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.test.ts#L138-L166)

---

## Agent Directory Structure

Each agent maintains isolated on-disk state:

```
Per-Agent Structure~/.openclawagents/main/work/personal//sessions/transcripts/agent/Workspaces (separate)~/.openclaw/workspace~/.openclaw/workspace-work~/.openclaw/workspace-personal
```

**Default paths:**

| Path | Content |
| --- | --- |
| `~/.openclaw/agents/<agentId>/sessions/` | Session history JSON files |
| `~/.openclaw/agents/<agentId>/transcripts/` | Compacted conversation transcripts |
| `~/.openclaw/agents/<agentId>/agent/` | Agent state directory (auth profiles, etc.) |
| `~/.openclaw/agents/<agentId>/agent/auth-profiles.json` | Per-agent authentication profiles |
| `agents.list[i].workspace` | Agent workspace (defaults to `~/.openclaw/workspace-<agentId>`) |

The `agentDir` path can be overridden per agent using `agents.list[i].agentDir`.

**Sources:**[src/agents/agent-scope.ts 136-166](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L136-L166) [src/config/paths.ts 1-100](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/config/paths.ts#L1-L100)

---

Each agent has its own `auth-profiles.json` file storing API keys, OAuth tokens, and token-based credentials. This allows different agents to use different model providers or accounts.

```
Agent: mainAgent: workAgent: personal~/.openclaw/agents/main/agent/
auth-profiles.json~/.openclaw/agents/work/agent/
auth-profiles.json~/.openclaw/agents/personal/agent/
auth-profiles.json
```

When an agent needs model authentication, the system calls `resolveApiKeyForProvider` with the agent's directory, loading the corresponding `auth-profiles.json`.

**Sources:**[src/agents/auth-profiles.ts 1-300](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/auth-profiles.ts#L1-L300) [src/agents/model-auth.ts 129-227](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/model-auth.ts#L129-L227) [src/commands/onboard-auth.test.ts 27-92](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/onboard-auth.test.ts#L27-L92)

---

## CLI Management

### List Agents

```
openclaw agents list
openclaw agents list --json
openclaw agents list --bindings
```

**Output includes:**

- Agent ID
- Display name
- Workspace path
- Default flag
- Bindings (if `--bindings` is passed)

**Sources:**[docs/cli/index.md 478-487](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/cli/index.md#L478-L487)

---

### Add Agent

```
# Interactive wizard (recommended)
openclaw agents add work

# Non-interactive
openclaw agents add work \
  --workspace ~/.openclaw/workspace-work \
  --model anthropic/claude-opus-4 \
  --bind whatsapp:biz \
  --non-interactive \
  --json
```

**Flags:**

- `--workspace <dir>` - Required in non-interactive mode
- `--model <id>` - Set primary model
- `--agent-dir <dir>` - Override agent state directory
- `--bind <channel[:accountId]>` - Repeatable; bind channel/account to this agent
- `--non-interactive` - Skip prompts
- `--json` - Output JSON

The wizard:

1. Prompts for agent name and workspace
2. Optionally prompts for model selection
3. Optionally prompts for channel bindings
4. Creates `agents.list[]` entry and writes config
5. Initializes workspace and agent directories

**Sources:**[docs/cli/index.md 488-509](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/cli/index.md#L488-L509) [src/commands/agents.ts 1-300](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/commands/agents.ts#L1-L300)

---

### Delete Agent

```
openclaw agents delete <id>
openclaw agents delete work --force --json
```

Deletes the agent entry from `agents.list[]` and optionally removes workspace and state directories.

**Sources:**[docs/cli/index.md 501-506](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/cli/index.md#L501-L506)

---

## Binding Patterns

The `bindings[]` array routes inbound messages to specific agents. Matching is performed in order, with the first match winning.

```
Binding ResolutionNo matchNo matchNo matchMatchMatchMatchInbound MessageExtract channel, accountId, senderIdbindings[0]bindings[1]bindings[2]Default AgentAgent: workAgent: personalAgent: familyAgent: main
```

**Match precedence:**

1. Exact match: `{ channel: "whatsapp", accountId: "biz", senderId: "+1555..." }`
2. Account match: `{ channel: "whatsapp", accountId: "biz" }`
3. Channel match: `{ channel: "telegram" }`
4. Default agent (first agent with `default: true` or first in `agents.list[]`)

**Sources:**[src/routing/bindings.ts 1-200](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/bindings.ts#L1-L200) [src/agents/agent-scope.ts 54-65](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L54-L65)

---

### Common Binding Examples

**Route WhatsApp business account to work agent:**

```
{
  "bindings": [
    {
      "match": { "channel": "whatsapp", "accountId": "biz" },
      "agent": "work"
    }
  ],
  "channels": {
    "whatsapp": {
      "accounts": {
        "default": { /* personal */ },
        "biz": { /* business */ }
      }
    }
  }
}
```

**Route specific Telegram account to family agent:**

```
{
  "bindings": [
    {
      "match": { "channel": "telegram", "accountId": "family" },
      "agent": "family"
    }
  ]
}
```

**Route specific sender to personal agent (overrides account binding):**

```
{
  "bindings": [
    {
      "match": {
        "channel": "whatsapp",
        "accountId": "default",
        "senderId": "+15555550199"
      },
      "agent": "personal"
    },
    {
      "match": { "channel": "whatsapp", "accountId": "default" },
      "agent": "main"
    }
  ]
}
```

**Sources:**[docs/cli/index.md 488-509](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/cli/index.md#L488-L509) [src/routing/bindings.ts 1-200](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/bindings.ts#L1-L200)

---

## Agent Isolation Guarantees

Multi-agent configuration provides the following isolation:

| Resource | Isolation Level |
| --- | --- |
| **Sessions** | Complete - Each agent has isolated `sessions/` directory |
| **Transcripts** | Complete - Each agent has isolated `transcripts/` directory |
| **Auth Profiles** | Complete - Each agent has its own `auth-profiles.json` |
| **Workspace** | Complete - Each agent has a distinct workspace path |
| **Sandbox Containers** | Configurable - `scope: "agent"` creates one container per agent |
| **Memory Search** | Workspace-scoped - Each agent searches its own workspace |
| **Model Configuration** | Overridable - Each agent can have different models/fallbacks |
| **Tool Policies** | Overridable - Each agent can have distinct tool allow/deny lists |
| **Channel Bindings** | Routing-based - Messages route to agents via bindings |

**Non-isolated resources:**

- Gateway process (shared)
- Channel connections (shared, routed via bindings)
- System events (shared across agents, scoped by `sessionKey`)
- Cron jobs (shared, can target specific agents via session keys)

**Sources:**[src/agents/agent-scope.ts 1-200](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L1-L200) [src/routing/bindings.ts 1-200](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/bindings.ts#L1-L200)

---

## Configuration Examples

### Minimal Two-Agent Setup

```
{
  "agents": {
    "defaults": {
      "workspace": "~/.openclaw/workspace",
      "model": { "primary": "anthropic/claude-sonnet-4" }
    },
    "list": [
      {
        "id": "main",
        "default": true,
        "workspace": "~/.openclaw/workspace"
      },
      {
        "id": "work",
        "workspace": "~/.openclaw/workspace-work",
        "model": { "primary": "anthropic/claude-opus-4" }
      }
    ]
  },
  "bindings": [
    {
      "match": { "channel": "whatsapp", "accountId": "biz" },
      "agent": "work"
    }
  ]
}
```

**Sources:**[src/agents/agent-scope.test.ts 1-200](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.test.ts#L1-L200)

---

### Multi-Agent with Different Tool Policies

```
{
  "agents": {
    "defaults": {
      "workspace": "~/.openclaw/workspace",
      "sandbox": { "mode": "non-main" }
    },
    "list": [
      {
        "id": "main",
        "default": true,
        "workspace": "~/.openclaw/workspace",
        "sandbox": { "mode": "off" }
      },
      {
        "id": "restricted",
        "workspace": "~/.openclaw/workspace-restricted",
        "tools": {
          "allow": ["read", "memory_search"],
          "deny": ["exec", "write", "edit"]
        },
        "sandbox": {
          "mode": "all",
          "scope": "agent",
          "workspaceAccess": "none"
        }
      },
      {
        "id": "elevated",
        "workspace": "~/.openclaw/workspace-elevated",
        "tools": {
          "elevated": {
            "enabled": true,
            "allowFrom": { "whatsapp": ["+15555550123"] },
            "defaultLevel": "on"
          }
        }
      }
    ]
  },
  "bindings": [
    {
      "match": { "channel": "telegram", "accountId": "public" },
      "agent": "restricted"
    },
    {
      "match": { "channel": "whatsapp", "accountId": "default" },
      "agent": "main"
    }
  ]
}
```

**Sources:**[src/agents/pi-tools-agent-config.test.ts 1-300](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/pi-tools-agent-config.test.ts#L1-L300)

---

## Migration from Single-Agent Setup

To convert an existing single-agent configuration to multi-agent:

1. **Preserve existing state:**
	```
	# Existing config uses agents.defaults implicitly
	# Sessions are at ~/.openclaw/agents/main/sessions/
	# Workspace is at agents.defaults.workspace
	```
2. **Add new agent:**
	```
	openclaw agents add work \
	  --workspace ~/.openclaw/workspace-work \
	  --model anthropic/claude-opus-4
	```
3. **Configure bindings:**
	```
	{
	  "bindings": [
	    {
	      "match": { "channel": "whatsapp", "accountId": "biz" },
	      "agent": "work"
	    }
	  ]
	}
	```
4. **Verify:**
	```
	openclaw agents list --bindings
	openclaw status
	```

The default agent (`main`) continues to handle all unbound messages, preserving existing behavior.

**Sources:**[docs/cli/index.md 478-509](https://github.com/openclaw/openclaw/blob/bf6ec64f/docs/cli/index.md#L478-L509) [src/agents/agent-scope.ts 54-77](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L54-L77)

---

## Agent Resolution Code Flow

```
"Agent Runtime""resolveAgentConfig""resolveSessionAgentId""buildSessionKey""resolveBindingsForMessage""autoreply.reply""Message Event""Agent Runtime""resolveAgentConfig""resolveSessionAgentId""buildSessionKey""resolveBindingsForMessage""autoreply.reply""Message Event""agent:work:dm:whatsapp:+1555...""Process message""bindings[], channel, accountId, senderId""agentId: 'work' (or undefined)""Build session key""resolveSessionAgentId(sessionKey, config)""parseAgentSessionKey""agentId: 'work'""resolveAgentConfig(config, 'work')""Merge with agents.defaults""Resolved agent config""Start agent with workspace, auth, tools"
```

**Key functions:**

- `resolveSessionAgentId({ sessionKey, config })` - [src/agents/agent-scope.ts 79-84](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L79-L84)
- `resolveAgentConfig(cfg, agentId)` - [src/agents/agent-scope.ts 91-115](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L91-L115)
- `resolveAgentWorkspaceDir(cfg, agentId)` - [src/agents/agent-scope.ts 136-145](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L136-L145)
- `resolveAgentDir(cfg, agentId)` - [src/agents/agent-scope.ts 147-166](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L147-L166)
- `parseAgentSessionKey(sessionKey)` - [src/routing/session-key.ts 1-50](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/session-key.ts#L1-L50)

**Sources:**[src/agents/agent-scope.ts 66-166](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/agents/agent-scope.ts#L66-L166) [src/routing/session-key.ts 1-100](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/routing/session-key.ts#L1-L100) [src/autoreply/reply.ts 1-500](https://github.com/openclaw/openclaw/blob/bf6ec64f/src/autoreply/reply.ts#L1-L500)

<svg id="mermaid-fu8dstus3vp" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 2412 512" style="max-width: 512px;" role="graphics-document document" aria-roledescription="error"><g></g><g><path class="error-icon" d="m411.313,123.313c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32-9.375,9.375-20.688-20.688c-12.484-12.5-32.766-12.5-45.25,0l-16,16c-1.261,1.261-2.304,2.648-3.31,4.051-21.739-8.561-45.324-13.426-70.065-13.426-105.867,0-192,86.133-192,192s86.133,192 192,192 192-86.133 192-192c0-24.741-4.864-48.327-13.426-70.065 1.402-1.007 2.79-2.049 4.051-3.31l16-16c12.5-12.492 12.5-32.758 0-45.25l-20.688-20.688 9.375-9.375 32.001-31.999zm-219.313,100.687c-52.938,0-96,43.063-96,96 0,8.836-7.164,16-16,16s-16-7.164-16-16c0-70.578 57.422-128 128-128 8.836,0 16,7.164 16,16s-7.164,16-16,16z"></path><path class="error-icon" d="m459.02,148.98c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l16,16c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16.001-16z"></path><path class="error-icon" d="m340.395,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688 6.25-6.25 6.25-16.375 0-22.625l-16-16c-6.25-6.25-16.375-6.25-22.625,0s-6.25,16.375 0,22.625l15.999,16z"></path><path class="error-icon" d="m400,64c8.844,0 16-7.164 16-16v-32c0-8.836-7.156-16-16-16-8.844,0-16,7.164-16,16v32c0,8.836 7.156,16 16,16z"></path><path class="error-icon" d="m496,96.586h-32c-8.844,0-16,7.164-16,16 0,8.836 7.156,16 16,16h32c8.844,0 16-7.164 16-16 0-8.836-7.156-16-16-16z"></path><path class="error-icon" d="m436.98,75.605c3.125,3.125 7.219,4.688 11.313,4.688 4.094,0 8.188-1.563 11.313-4.688l32-32c6.25-6.25 6.25-16.375 0-22.625s-16.375-6.25-22.625,0l-32,32c-6.251,6.25-6.251,16.375-0.001,22.625z"></path><text class="error-text" x="1440" y="250" font-size="150px" style="text-anchor: middle;">Syntax error in text</text> <text class="error-text" x="1250" y="400" font-size="100px" style="text-anchor: middle;">mermaid version 11.12.2</text></g></svg>