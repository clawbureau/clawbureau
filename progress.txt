## Codebase Patterns
- JSON Schema patterns exist in packages/schema/ - follow naming convention: `{domain}/{resource}.v{version}.json`
- D1 database with TEXT columns for balances (stored as string representations of bigint)
- Cloudflare Workers architecture with wrangler.toml configuration
- ESLint flat config with typescript-eslint for type-aware linting
- Service structure: services/{service-name}/src/ with index.ts as entry point
- Event hash chain uses SHA-256 via Web Crypto API (crypto.subtle.digest)
- Idempotency keys are unique per event, enabling safe retries
- GENESIS_HASH is 64 zeros ('0'.repeat(64)) for first event in chain

# Ralph Progress Log
Started: 2026-02-02T03:08:26.936251
---

## 2026-02-02T03:30:00Z - CLD-US-001
- What was implemented:
  - Created services/ledger/ directory structure
  - Implemented Account types with balance buckets (available, held, bonded, feePool, promo)
  - AccountRepository for D1 database operations
  - AccountService for business logic
  - API endpoints: POST /accounts, GET /accounts/:did, GET /accounts/id/:id
  - D1 migration for accounts table with proper indexes
  - DID validation (did:method:identifier format)
  - Idempotent account creation (returns existing account if DID exists)
- Files changed:
  - services/ledger/package.json (new)
  - services/ledger/tsconfig.json (new)
  - services/ledger/wrangler.toml (new)
  - services/ledger/eslint.config.js (new)
  - services/ledger/src/types.ts (new)
  - services/ledger/src/accounts.ts (new)
  - services/ledger/src/index.ts (new)
  - services/ledger/migrations/0001_create_accounts.sql (new)
- **Learnings for future iterations:**
  - Use TEXT type for balance columns in D1/SQLite to store bigint values as strings
  - Always run `npm install` before quality checks in a new service
  - DID format is `did:method:identifier` - validate with regex pattern
  - Account IDs are derived deterministically from DIDs for reproducibility
  - Balance buckets align with PRD CLD-US-007 even though implementing CLD-US-001 first
---

## 2026-02-02T04:15:00Z - CLD-US-002
- What was implemented:
  - Event types: mint, burn, transfer, hold, release
  - LedgerEvent entity with idempotency key support
  - EventRepository for D1 database operations with idempotent writes
  - EventService for business logic including hash chain verification
  - SHA-256 hash chain linking events for audit trail
  - API endpoints:
    - POST /events - Create new event (idempotent via idempotency_key)
    - GET /events/:id - Get event by ID
    - GET /events/idempotency/:key - Get event by idempotency key
    - GET /accounts/:accountId/events - Get events for an account
    - GET /events/verify - Verify hash chain integrity
  - D1 migration for events table with indexes
- Files changed:
  - services/ledger/src/types.ts (updated - added event types)
  - services/ledger/src/events.ts (new)
  - services/ledger/src/index.ts (updated - added event routes)
  - services/ledger/migrations/0002_create_events.sql (new)
- **Learnings for future iterations:**
  - Use Web Crypto API (crypto.subtle.digest) for SHA-256 in Cloudflare Workers
  - Hash chain links events via previousHash → eventHash
  - Idempotency check happens before hash computation to return cached result
  - Unused parameters should be prefixed with underscore (e.g., _startEventId) for ESLint
  - Event buckets default to 'available' if not specified
---

## 2026-02-02T05:00:00Z - CLD-US-003
- What was implemented:
  - Hold/Release functionality for escrow operations
  - HoldService and HoldRepository for business logic and database operations
  - Hold creation: moves funds from available to held bucket
  - Release modes: 'cancel' (return to available) or 'complete' (transfer to target)
  - Balance validation with InsufficientFundsError for negative balance prevention
  - AccountRepository extended with balance update methods:
    - createHold(): available → held
    - releaseHoldToAvailable(): held → available (cancel)
    - completeHold(): remove from held (for transfers)
    - creditAvailable(): add to available (receive transfers)
  - API endpoints:
    - POST /holds - Create new hold (idempotent)
    - GET /holds/:id - Get hold by ID
    - POST /holds/:id/release - Release or cancel hold
    - GET /accounts/:accountId/holds - Get active holds for account
  - D1 migration for holds table with status tracking
- Files changed:
  - services/ledger/src/types.ts (updated - added hold types)
  - services/ledger/src/accounts.ts (updated - added balance methods)
  - services/ledger/src/holds.ts (new)
  - services/ledger/src/index.ts (updated - added hold routes)
  - services/ledger/migrations/0003_create_holds.sql (new)
- **Learnings for future iterations:**
  - Hold status is tracked separately from events (active/released/cancelled)
  - Release operations require their own idempotency keys
  - Complete release requires toAccountId for fund destination
  - InsufficientFundsError provides detailed context for balance failures
  - Optimistic concurrency via version column prevents race conditions
---
