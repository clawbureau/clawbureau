## Codebase Patterns
- Services live in `services/<service-name>/` with Cloudflare Worker structure
- Use wrangler.toml for Worker config, tsconfig.json with strict mode
- Package naming: @clawbureau/<service-name>
- Receipt hashes use SHA-256 hex encoding
- Types exported from `src/types.ts`, providers from `src/providers.ts`
- Security events use structured logging via `src/logging.ts` with [SECURITY] prefix

# Ralph Progress Log
Started: 2026-02-02T03:08:26.937763
---

## 2026-02-02 - CPX-US-001
- Implemented clawproxy Cloudflare Worker foundation
- Created POST /v1/proxy/:provider endpoint routing to Anthropic/OpenAI
- Added receipt generation with SHA-256 hashes of request/response bodies
- Files created:
  - services/clawproxy/package.json
  - services/clawproxy/wrangler.toml
  - services/clawproxy/tsconfig.json
  - services/clawproxy/src/index.ts (main entry)
  - services/clawproxy/src/types.ts (Receipt, Provider types)
  - services/clawproxy/src/providers.ts (Anthropic/OpenAI routing)
  - services/clawproxy/src/receipt.ts (receipt generation)
  - services/clawproxy/src/crypto.ts (SHA-256 hashing)
- **Learnings for future iterations:**
  - Receipt version is '1.0' with fields: version, provider, model, requestHash, responseHash, timestamp, latencyMs
  - Provider allowlist is hardcoded in providers.ts for SSRF prevention
  - Authorization header supports both "Bearer <key>" and raw key formats
  - Typecheck: `npm run typecheck` in services/clawproxy/
---

## 2026-02-02 - CPX-US-002
- Implemented Ed25519 receipt signing for cryptographically verifiable receipts
- Added GET /v1/did endpoint to expose proxy DID + public key for verification
- All proxy requests now fail closed (503) if PROXY_SIGNING_KEY is not configured
- Files modified:
  - services/clawproxy/src/types.ts (added DidResponse interface)
  - services/clawproxy/src/crypto.ts (added Ed25519 import/sign/verify functions, computeKeyId)
  - services/clawproxy/src/receipt.ts (added SigningContext, signing support in generateReceipt)
  - services/clawproxy/src/index.ts (added /v1/did endpoint, fail-closed logic, signing integration)
- **Learnings for future iterations:**
  - Ed25519 keys stored as base64url-encoded raw 32-byte seed in PROXY_SIGNING_KEY secret
  - PKCS8 wrapping is required for Web Crypto API Ed25519 import (16-byte header prepended to seed)
  - DID format: did:web:clawproxy.com with kid as truncated SHA-256 hash of public key
  - Receipt signature covers JSON-serialized payload excluding signature field
  - Signing context is cached at module level after first request
  - Cache-Control: public, max-age=3600 set on /v1/did responses
---

## 2026-02-02 - CPX-US-003
- Implemented structured security logging for blocked provider attempts
- Added logging.ts with SecurityEvent types and logBlockedProvider function
- Provider validation now logs BLOCKED_UNKNOWN_PROVIDER events with client IP, user agent, and attempted provider
- Added getSupportedProviders() helper for dynamic error messages
- Files created:
  - services/clawproxy/src/logging.ts (security event logging)
- Files modified:
  - services/clawproxy/src/index.ts (integrated logging, improved error messages)
  - services/clawproxy/src/providers.ts (added getSupportedProviders helper)
- **Learnings for future iterations:**
  - Security events use console.warn with [SECURITY] prefix for Cloudflare Workers observability
  - Client IP available via CF-Connecting-IP header in Cloudflare Workers
  - Structured JSON logging enables filtering/querying in observability tools
  - Keep security logging functions separate in logging.ts for reuse
---

## 2026-02-02 - CPX-US-004
- Added Google Gemini provider support to clawproxy
- Implemented dynamic URL building for Gemini's model-in-path requirement
- Added model validation for Google provider (required for URL construction)
- Files modified:
  - services/clawproxy/src/types.ts (added 'google' to Provider union type)
  - services/clawproxy/src/providers.ts (added Google config, buildProviderUrl function)
  - services/clawproxy/src/index.ts (integrated buildProviderUrl, added Google model validation)
- **Learnings for future iterations:**
  - Gemini API uses `x-goog-api-key` header for authentication (not Bearer token)
  - Gemini URL format: `models/{model}:generateContent` - model is path param, not body-only
  - Use buildProviderUrl() for all providers; returns static URL for most, dynamic for Google
  - Gemini responses include `usageMetadata` field automatically passed through
---
